

================================================================================
文件路径: combine.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\combine.py
================================================================================

import os

def is_code_file(filename):
    """检查文件是否为代码文件"""
    code_extensions = ['.py', '.js', '.vue', '.html', '.css', '.java', '.c', '.cpp', '.h', '.go', '.php', '.rb', '.sh']
    return any(filename.endswith(ext) for ext in code_extensions)

def get_file_content(filepath):
    """读取文件内容，处理可能的编码问题"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return f.read()
    except UnicodeDecodeError:
        try:
            with open(filepath, 'r', encoding='gbk') as f:
                return f.read()
        except Exception as e:
            return f"<无法读取文件内容，编码错误: {str(e)}>"
    except Exception as e:
        return f"<读取文件出错: {str(e)}>"

def process_directory(root_dir, output_file):
    """处理目录，收集所有代码文件信息"""
    with open(output_file, 'w', encoding='utf-8') as out_f:
        for root, dirs, files in os.walk(root_dir):
            for file in files:
                if is_code_file(file):
                    filepath = os.path.join(root, file)
                    relative_path = os.path.relpath(filepath, start=root_dir)
                    
                    # 写入文件信息
                    out_f.write(f"\n\n{'=' * 80}\n")
                    out_f.write(f"文件路径: {relative_path}\n")
                    out_f.write(f"完整路径: {filepath}\n")
                    out_f.write(f"{'=' * 80}\n\n")
                    
                    # 写入文件内容
                    content = get_file_content(filepath)
                    out_f.write(content)

if __name__ == "__main__":
    # 设置输出文件名
    output_filename = "all_code_contents.txt"
    
    # 获取当前目录
    current_dir = os.getcwd()
    
    print(f"开始处理目录: {current_dir}")
    print(f"代码内容将保存到: {output_filename}")
    
    # 处理目录
    process_directory(current_dir, output_filename)
    
    print("处理完成！")



================================================================================
文件路径: backend\manage.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\manage.py
================================================================================

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


================================================================================
文件路径: backend\update_admin.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\update_admin.py
================================================================================

#!/usr/bin/env python
import os
import django

# 设置Django环境
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from django.contrib.auth import get_user_model
from django.db.utils import IntegrityError

User = get_user_model()

def update_admin_user():
    """更新或创建管理员用户"""
    
    # 尝试查找用户名为root的用户
    try:
        user = User.objects.get(username='root')
        # 更新现有用户
        user.is_staff = True
        user.is_superuser = True
        user.set_password('root123456')
        user.save()
        print(f"已将用户 '{user.username}' 设置为管理员并更新密码为 'root123456'")
    except User.DoesNotExist:
        # 创建新的超级用户
        User.objects.create_superuser('root', 'admin@example.com', 'root123456')
        print("已创建新的管理员账号 'root'，密码为 'root123456'")
    
    # 验证设置
    user = User.objects.get(username='root')
    print(f"用户状态: is_staff={user.is_staff}, is_superuser={user.is_superuser}")

if __name__ == '__main__':
    update_admin_user() 

================================================================================
文件路径: backend\config\asgi.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\config\asgi.py
================================================================================




================================================================================
文件路径: backend\config\settings.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\config\settings.py
================================================================================

"""
Django设置文件
"""
import os
from pathlib import Path
from dotenv import load_dotenv
from datetime import timedelta

# 加载.env文件中的环境变量
# load_dotenv() # 使用下面更明确的方式
BASE_DIR = Path(__file__).resolve().parent.parent
dotenv_path = BASE_DIR / '.env'
load_dotenv(dotenv_path=dotenv_path)
print(f"DEBUG: Attempted loading .env from {dotenv_path}") # 添加更详细的调试信息

# 构建路径
# BASE_DIR = Path(__file__).resolve().parent.parent 

# 安全设置
SECRET_KEY = os.getenv('SECRET_KEY', 'django-insecure-change-this-in-production')
DEBUG = os.getenv('DEBUG', 'True').lower() == 'true'
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')

# 应用定义
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # 第三方应用
    'rest_framework',
    'corsheaders',
    'django_filters',
    
    # 自定义应用
    'users',
    'detection',
    'settings',  # 添加settings应用
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': os.getenv('DATABASE_NAME', 'mmdfd'),
        'USER': os.getenv('DATABASE_USER', 'root'),
        'PASSWORD': os.getenv('DATABASE_PASSWORD', 'root'),
        'HOST': os.getenv('DATABASE_HOST', 'localhost'),
        'PORT': os.getenv('DATABASE_PORT', '3306'),
        'OPTIONS': {
            'charset': 'utf8mb4',
        },
    }
}

# 密码验证
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# 国际化
LANGUAGE_CODE = 'zh-hans'
TIME_ZONE = 'Asia/Shanghai'
USE_I18N = True
USE_TZ = True

# 静态文件 (CSS, JavaScript, Images)
STATIC_URL = 'static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')

# 媒体文件配置
MEDIA_URL = 'media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# 默认主键字段类型
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# --- 模型和路径配置 --- (移动 MODEL_STORAGE_PATH 定义到前面)
MODEL_STORAGE_PATH = os.path.join(BASE_DIR, '..', 'models')
OPENROUTER_API_KEY = os.getenv('OPENROUTER_API_KEY', None)
MODEL_FILENAME = 'best_text_image_model.pth'
DEVICE = 'cuda' if os.getenv('USE_GPU', 'False').lower() == 'true' else 'cpu' # 可通过环境变量USE_GPU=True启用GPU
MODEL_PATH = os.path.join(MODEL_STORAGE_PATH, MODEL_FILENAME) # 现在 MODEL_STORAGE_PATH 已定义
NUM_METADATA_FEATURES = 0 # 设置为 0
# 确认模型训练时的参数 (与 train_model.py/model_evaluation.py 保持一致)
TEXT_MODEL_NAME = 'bert-base-chinese'
IMAGE_MODEL_NAME = 'resnet50'
IMAGE_MODEL_INPUT_SIZE = 224
MAX_TEXT_LEN = 128
IMG_EMBEDDING_DIM = 2048
TEXT_EMBEDDING_DIM = 768
FUSION_OUTPUT_DIM = 256
# --- 结束模型和路径配置 ---

# REST Framework设置
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.BasicAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 10,
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',
    ],
}

# CORS配置
CORS_ALLOW_ALL_ORIGINS = DEBUG  # 在开发环境中允许所有来源
CORS_ALLOWED_ORIGINS = os.getenv('CORS_ALLOWED_ORIGINS', 'http://localhost:8080').split(',')

# 自定义用户模型
AUTH_USER_MODEL = 'users.User'

# 文件上传设置
FILE_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB

# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'mmdfd.log'),
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': True,
        },
        'detection': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}

# 确保日志目录存在
os.makedirs(os.path.join(BASE_DIR, 'logs'), exist_ok=True)

# SimpleJWT配置
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(days=1),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': False,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': False,

    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'VERIFYING_KEY': None,
    'AUDIENCE': None,
    'ISSUER': None,

    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
    'USER_AUTHENTICATION_RULE': 'rest_framework_simplejwt.authentication.default_user_authentication_rule',

    'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),
    'TOKEN_TYPE_CLAIM': 'token_type',
    'TOKEN_USER_CLASS': 'rest_framework_simplejwt.models.TokenUser',

    'JTI_CLAIM': 'jti',
}


================================================================================
文件路径: backend\config\urls.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\config\urls.py
================================================================================

"""
项目URL配置
"""
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/users/', include('users.urls')),
    path('api/detection/', include('detection.urls')),
    path('api/', include('settings.urls')),  # 包含settings app的URL
]

# 开发环境下提供媒体文件服务
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)


================================================================================
文件路径: backend\config\wsgi.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\config\wsgi.py
================================================================================

"""
WSGI config for MM-DFD project.
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()


================================================================================
文件路径: backend\detection\apps.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\apps.py
================================================================================

"""
检测应用配置
"""
from django.apps import AppConfig

class DetectionConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'detection'
    verbose_name = '虚假新闻检测'


================================================================================
文件路径: backend\detection\models.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\models.py
================================================================================

"""
检测应用模型定义
"""
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.contrib.auth import get_user_model

User = get_user_model()

class Detection(models.Model):
    """
    新闻检测记录模型
    """
    # 检测状态常量
    STATUS_PENDING = 'pending'
    STATUS_PROCESSING = 'processing'
    STATUS_COMPLETED = 'completed'
    STATUS_FAILED = 'failed'
    
    STATUS_CHOICES = [
        (STATUS_PENDING, _('待处理')),
        (STATUS_PROCESSING, _('处理中')),
        (STATUS_COMPLETED, _('已完成')),
        (STATUS_FAILED, _('失败')),
    ]
    
    # 检测结果常量
    RESULT_FAKE = 'fake'
    RESULT_REAL = 'real'
    RESULT_UNKNOWN = 'unknown'
    
    RESULT_CHOICES = [
        (RESULT_FAKE, _('虚假')),
        (RESULT_REAL, _('真实')),
        (RESULT_UNKNOWN, _('未知')),
    ]
    
    user = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='detections',
        verbose_name=_('用户')
    )
    
    title = models.CharField(_('新闻标题'), max_length=255)
    content = models.TextField(_('新闻内容'))
    
    # 图像存储路径
    image = models.ImageField(_('新闻图像'), upload_to='news_images/%Y/%m/%d/', blank=True, null=True)
    
    # 检测状态与结果
    status = models.CharField(
        _('检测状态'), 
        max_length=20, 
        choices=STATUS_CHOICES,
        default=STATUS_PENDING
    )
    
    result = models.CharField(
        _('检测结果'), 
        max_length=20, 
        choices=RESULT_CHOICES,
        default=RESULT_UNKNOWN
    )
    
    # 置信度分数 (0-1范围内的浮点数)
    confidence_score = models.FloatField(_('置信度'), default=0.0)
    
    # 详细分析结果 (JSON格式存储)
    analysis_result = models.JSONField(_('分析结果'), blank=True, null=True)
    
    # 检测任务创建和完成时间
    created_at = models.DateTimeField(_('创建时间'), auto_now_add=True)
    updated_at = models.DateTimeField(_('更新时间'), auto_now=True)
    completed_at = models.DateTimeField(_('完成时间'), blank=True, null=True)
    
    # 检测错误信息
    error_message = models.TextField(_('错误信息'), blank=True, null=True)
    
    class Meta:
        verbose_name = _('检测记录')
        verbose_name_plural = _('检测记录')
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'created_at']),
            models.Index(fields=['status']),
            models.Index(fields=['result']),
        ]
    
    def __str__(self):
        return f"{self.title} - {self.get_result_display()}"
    
    def is_completed(self):
        """
        检查检测是否已完成
        """
        return self.status == self.STATUS_COMPLETED
    
    def is_fake(self):
        """
        检查新闻是否被判断为虚假
        """
        return self.result == self.RESULT_FAKE
    
    def is_real(self):
        """
        检查新闻是否被判断为真实
        """
        return self.result == self.RESULT_REAL


================================================================================
文件路径: backend\detection\serializers.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\serializers.py
================================================================================

"""
检测应用序列化器
"""
from rest_framework import serializers
from .models import Detection

class DetectionSerializer(serializers.ModelSerializer):
    """
    检测记录序列化器
    """
    user = serializers.StringRelatedField(read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    result_display = serializers.CharField(source='get_result_display', read_only=True)
    
    class Meta:
        model = Detection
        fields = [
            'id', 'user', 'title', 'content', 'image', 
            'status', 'status_display', 'result', 'result_display',
            'confidence_score', 'analysis_result', 
            'created_at', 'updated_at', 'completed_at', 'error_message'
        ]
        read_only_fields = [
            'id', 'user', 'status', 'status_display', 'result', 'result_display',
            'confidence_score', 'analysis_result', 
            'created_at', 'updated_at', 'completed_at', 'error_message'
        ]

class DetectionCreateSerializer(serializers.ModelSerializer):
    """
    创建检测记录的序列化器
    """
    class Meta:
        model = Detection
        fields = ['title', 'content', 'image']

class DetectionResultSerializer(serializers.ModelSerializer):
    """
    检测结果序列化器
    """
    user = serializers.StringRelatedField(read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    result_display = serializers.CharField(source='get_result_display', read_only=True)
    
    class Meta:
        model = Detection
        fields = [
            'id', 'user', 'title', 'content', 'image', 
            'status', 'status_display', 'result', 'result_display',
            'confidence_score', 'analysis_result', 
            'created_at', 'completed_at'
        ]
        read_only_fields = fields

class DetectionStatSerializer(serializers.Serializer):
    """
    检测统计序列化器
    """
    total_count = serializers.IntegerField()
    fake_count = serializers.IntegerField()
    real_count = serializers.IntegerField()
    pending_count = serializers.IntegerField()
    completed_count = serializers.IntegerField()
    failed_count = serializers.IntegerField()
    fake_percentage = serializers.FloatField()
    real_percentage = serializers.FloatField()
    average_confidence = serializers.FloatField()


================================================================================
文件路径: backend\detection\urls.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\urls.py
================================================================================

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import DetectionViewSet

router = DefaultRouter()
router.register(r'detections', DetectionViewSet, basename='detection')

urlpatterns = [
    path('', include(router.urls)),
]


================================================================================
文件路径: backend\detection\views.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\views.py
================================================================================

"""
检测应用视图
"""
import logging
from django.db.models import Count, Avg, Q, F, Sum, Case, When, Value, IntegerField
from django.utils import timezone
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import Detection
from .serializers import (
    DetectionSerializer, DetectionCreateSerializer, 
    DetectionResultSerializer, DetectionStatSerializer
)
from .services.detector import FakeNewsDetector
from django.db.models.functions import TruncDate
from datetime import timedelta, datetime

logger = logging.getLogger(__name__)

class IsOwnerOrReadOnly(permissions.BasePermission):
    """
    对象级权限，只允许对象的所有者编辑
    """
    def has_object_permission(self, request, view, obj):
        # 读取权限允许任何请求
        if request.method in permissions.SAFE_METHODS:
            return True
        
        # 管理员具有所有权限
        if request.user.is_staff:
            return True
            
        # 写入权限只允许对象的所有者
        return obj.user == request.user

class DetectionViewSet(viewsets.ModelViewSet):
    """
    检测记录视图集
    """
    queryset = Detection.objects.all()
    serializer_class = DetectionSerializer
    permission_classes = [permissions.IsAuthenticated, IsOwnerOrReadOnly]
    
    def get_queryset(self):
        """
        根据用户过滤检测记录
        """
        user = self.request.user
        # 管理员可以查看所有记录，普通用户只能查看自己的记录
        if user.is_staff:
            return Detection.objects.all()
        return Detection.objects.filter(user=user)
    
    def get_serializer_class(self):
        """
        根据不同操作返回不同的序列化器
        注意：对于 create 操作，我们虽然用 DetectionCreateSerializer 验证输入，
              但在 create 方法的响应中，我们会用 DetectionSerializer 返回完整数据。
        """
        if self.action == 'create':
            return DetectionCreateSerializer
        if self.action == 'get_stats':
            return DetectionStatSerializer
        # 对于 list, retrieve, update, partial_update, destroy 等，使用默认的 DetectionSerializer
        return DetectionSerializer

    # 覆盖 create 方法以确保返回完整序列化数据
    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        # 调用 perform_create 来保存对象并触发检测
        self.perform_create(serializer)
        # 使用 DetectionSerializer 序列化创建的对象以包含所有字段
        response_serializer = DetectionSerializer(serializer.instance, context=self.get_serializer_context())
        headers = self.get_success_headers(response_serializer.data)
        return Response(response_serializer.data, status=status.HTTP_201_CREATED, headers=headers)

    def perform_create(self, serializer):
        """
        创建检测记录时设置用户, 并启动检测任务
        """
        detection = serializer.save(user=self.request.user)
        
        # 启动异步检测任务 (当前是同步的)
        try:
            detector = FakeNewsDetector(detection.id)
            detector.detect()
        except Exception as e:
            logger.exception(f"检测任务启动失败: {str(e)}")
            detection.status = Detection.STATUS_FAILED
            detection.error_message = f"检测任务启动失败: {str(e)}"
            detection.save()
    
    @action(detail=True, methods=['get'])
    def result(self, request, pk=None):
        """
        获取检测结果
        """
        detection = self.get_object()
        serializer = DetectionResultSerializer(detection)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def my_detections(self, request):
        """
        获取当前用户的所有检测记录
        """
        detections = Detection.objects.filter(user=request.user).order_by('-created_at')
        page = self.paginate_queryset(detections)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)
        
        serializer = self.get_serializer(detections, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def get_stats(self, request):
        """
        获取检测统计信息
        """
        user = request.user
        
        # 确定统计范围
        if user.is_staff and request.query_params.get('all') == 'true':
            # 管理员可以查看所有统计
            detections = Detection.objects.all()
        else:
            # 普通用户只能查看自己的统计
            detections = Detection.objects.filter(user=user)
        
        # 计算基本统计量
        total_count = detections.count()
        
        # 如果没有检测记录，返回空统计
        if total_count == 0:
            return Response({
                'total_count': 0,
                'fake_count': 0,
                'real_count': 0,
                'pending_count': 0,
                'completed_count': 0,
                'failed_count': 0,
                'fake_percentage': 0,
                'real_percentage': 0,
                'average_confidence': 0
            })
        
        # 计算各类型数量
        fake_count = detections.filter(result=Detection.RESULT_FAKE).count()
        real_count = detections.filter(result=Detection.RESULT_REAL).count()
        pending_count = detections.filter(status=Detection.STATUS_PENDING).count()
        completed_count = detections.filter(status=Detection.STATUS_COMPLETED).count()
        failed_count = detections.filter(status=Detection.STATUS_FAILED).count()
        
        # 计算百分比
        fake_percentage = (fake_count / total_count) * 100 if total_count > 0 else 0
        real_percentage = (real_count / total_count) * 100 if total_count > 0 else 0
        
        # 计算平均置信度
        avg_confidence = detections.filter(
            status=Detection.STATUS_COMPLETED
        ).aggregate(avg=Avg('confidence_score'))['avg'] or 0
        
        # 添加按日期分组的数据统计
        # 获取过去7天的日期范围
        today = timezone.now().date()
        dates = [(today - timedelta(days=i)) for i in range(6, -1, -1)]
        
        # 按日期分组查询数据 - 修复日期查询逻辑
        # 不再使用日期过滤，而是分别计算每个日期的记录数
        date_counts = {}
        for date in dates:
            start_date = datetime.combine(date, datetime.min.time())
            end_date = datetime.combine(date, datetime.max.time())
            start_date = timezone.make_aware(start_date)
            end_date = timezone.make_aware(end_date)
            
            # 计算当天的检测数量
            count = detections.filter(created_at__gte=start_date, created_at__lte=end_date).count()
            date_counts[date.strftime('%Y-%m-%d')] = count
        
        # 如果所有日期的计数都是0，我们可能需要查看所有检测记录的日期分布
        if all(count == 0 for count in date_counts.values()) and total_count > 0:
            # 获取最早和最晚的检测记录日期
            earliest = detections.order_by('created_at').first()
            latest = detections.order_by('-created_at').first()
            
            if earliest and latest:
                earliest_date = earliest.created_at.date()
                latest_date = latest.created_at.date()
                
                # 计算所有检测记录的日期分布
                real_date_counts = {}
                date_range = []
                for date in (earliest_date + timedelta(days=n) for n in range((latest_date - earliest_date).days + 1)):
                    date_range.append(date)
                    start_date = datetime.combine(date, datetime.min.time())
                    end_date = datetime.combine(date, datetime.max.time())
                    start_date = timezone.make_aware(start_date)
                    end_date = timezone.make_aware(end_date)
                    count = detections.filter(created_at__gte=start_date, created_at__lte=end_date).count()
                    real_date_counts[date.strftime('%Y-%m-%d')] = count
                
                # 使用真实的日期分布，取最多7天数据
                if len(date_range) > 0:
                    # 最多取7天数据，优先取最近的数据
                    if len(date_range) > 7:
                        date_range = date_range[-7:]
                    
                    date_counts = {date.strftime('%Y-%m-%d'): real_date_counts.get(date.strftime('%Y-%m-%d'), 0) for date in date_range}
                    dates = date_range
        
        # 生成最近日期的统计数据
        weekly_trend = []
        for date in dates:
            date_str = date.strftime('%Y-%m-%d')
            if date == today:
                display_name = '今天'
            elif date == today - timedelta(days=1):
                display_name = '昨天'
            else:
                display_name = date_str
                
            weekly_trend.append({
                'date': display_name,
                'count': date_counts.get(date_str, 0)
            })
        
        # 计算今日检测量
        today_detections = date_counts.get(today.strftime('%Y-%m-%d'), 0)
        
        # 构建统计响应
        stats = {
            'total_count': total_count,
            'fake_count': fake_count,
            'real_count': real_count,
            'pending_count': pending_count,
            'completed_count': completed_count,
            'failed_count': failed_count,
            'fake_percentage': fake_percentage,
            'real_percentage': real_percentage,
            'average_confidence': avg_confidence,
            'weekly_trend': weekly_trend,
            'today_detections': today_detections,
            'result_distribution': [
                { 'name': '真实新闻', 'value': real_count },
                { 'name': '虚假新闻', 'value': fake_count }
            ]
        }
        
        return Response(stats)


================================================================================
文件路径: backend\detection\migrations\0001_initial.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\migrations\0001_initial.py
================================================================================

# Generated by Django 4.2.9 on 2025-04-19 05:10

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Detection',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=255, verbose_name='新闻标题')),
                ('content', models.TextField(verbose_name='新闻内容')),
                ('image', models.ImageField(blank=True, null=True, upload_to='news_images/%Y/%m/%d/', verbose_name='新闻图像')),
                ('status', models.CharField(choices=[('pending', '待处理'), ('processing', '处理中'), ('completed', '已完成'), ('failed', '失败')], default='pending', max_length=20, verbose_name='检测状态')),
                ('result', models.CharField(choices=[('fake', '虚假'), ('real', '真实'), ('unknown', '未知')], default='unknown', max_length=20, verbose_name='检测结果')),
                ('confidence_score', models.FloatField(default=0.0, verbose_name='置信度')),
                ('analysis_result', models.JSONField(blank=True, null=True, verbose_name='分析结果')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('completed_at', models.DateTimeField(blank=True, null=True, verbose_name='完成时间')),
                ('error_message', models.TextField(blank=True, null=True, verbose_name='错误信息')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='detections', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
            ],
            options={
                'verbose_name': '检测记录',
                'verbose_name_plural': '检测记录',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['user', 'created_at'], name='detection_d_user_id_005ef3_idx'), models.Index(fields=['status'], name='detection_d_status_c8cd09_idx'), models.Index(fields=['result'], name='detection_d_result_6448a8_idx')],
            },
        ),
    ]


================================================================================
文件路径: backend\detection\migrations\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\migrations\__init__.py
================================================================================



================================================================================
文件路径: backend\detection\ml\data_utils.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\ml\data_utils.py
================================================================================

# backend/detection/ml/data_utils.py

import torch
from transformers import AutoTokenizer
from torchvision import transforms
from torchvision.models import ResNet50_Weights
from PIL import Image
import logging
from django.conf import settings # Import settings

logger = logging.getLogger(__name__)

# --- Tokenizer Function (Copied from data_loader.py) ---
def get_tokenizer(model_name=settings.TEXT_MODEL_NAME):
    """ Returns a tokenizer for the specified model. """
    try:
        tokenizer = AutoTokenizer.from_pretrained(model_name)
        logger.info(f"Tokenizer loaded for {model_name}")
        return tokenizer
    except Exception as e:
        logger.error(f"Failed to load tokenizer for {model_name}: {e}")
        raise

# --- Image Transform Function (Adapted from data_loader.py) ---
def get_image_transforms(model_name=settings.IMAGE_MODEL_NAME, input_size=settings.IMAGE_MODEL_INPUT_SIZE):
    """ Returns appropriate image transforms for evaluation. """
    if model_name == 'resnet50':
        # Use standard weights for ResNet50 V2 for transforms
        try:
            weights = ResNet50_Weights.IMAGENET1K_V2
            transform = weights.transforms()
            logger.info(f"Using standard ResNet50 V2 transforms (input size {input_size})")
            # Ensure the resize matches the expected input size if different from standard
            if input_size != 224: # Standard ResNet input is 224
                # Overwrite the resize/center crop part if needed
                transform = transforms.Compose([
                    transforms.Resize(input_size + 32), # Standard practice: resize slightly larger
                    transforms.CenterCrop(input_size),
                    transforms.ToTensor(),
                    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
                ])
                logger.warning(f"Overriding standard ResNet transforms for input size {input_size}")
            return transform
        except Exception as e:
             logger.error(f"Failed to get ResNet50 V2 weights/transforms: {e}. Falling back to basic transforms.")
             # Fallback if weights unavailable
             return transforms.Compose([
                transforms.Resize((input_size, input_size)),
                transforms.ToTensor(),
                transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
            ])

    else:
        # Basic transforms for other/unknown models
        logger.warning(f"Using basic image transforms for model {model_name}")
        return transforms.Compose([
            transforms.Resize((input_size, input_size)),
            transforms.ToTensor(),
            # Standard ImageNet normalization, adjust if your model used different ones
            transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
        ])

# --- Preprocessing Function for Single Item (Metadata Excluded) --- #
def preprocess_input(text, image_path, tokenizer, image_transform, device):
    """
    Preprocesses text and image for a single detection item.
    Handles missing image.
    Returns a dictionary suitable for the text-image model input.
    """
    # 1. Text Processing
    encoding = tokenizer(text,
                         add_special_tokens=True,
                         max_length=settings.MAX_TEXT_LEN,
                         padding='max_length',
                         truncation=True,
                         return_attention_mask=True,
                         return_tensors='pt')

    input_ids = encoding['input_ids'].flatten().unsqueeze(0).to(device) # Add batch dim
    attention_mask = encoding['attention_mask'].flatten().unsqueeze(0).to(device) # Add batch dim

    # 2. Image Processing
    image_tensor = torch.zeros((1, 3, settings.IMAGE_MODEL_INPUT_SIZE, settings.IMAGE_MODEL_INPUT_SIZE)).to(device)
    image_available = torch.tensor([False]).to(device)
    if image_path and image_path.is_file():
        try:
            image = Image.open(image_path).convert('RGB')
            image_tensor = image_transform(image).unsqueeze(0).to(device) # Add batch dim
            image_available = torch.tensor([True]).to(device)
        except Exception as e:
            logger.warning(f"Could not process image {image_path}: {e}. Skipping image.")

    # 3. 移除 Metadata Processing
    # metadata_features = torch.zeros(...) 
    # metadata_tensor = ...

    # 返回不含 metadata 的字典
    return {
        'input_ids': input_ids,
        'attention_mask': attention_mask,
        'image': image_tensor,
        'image_available': image_available
    }

# --- 移除 Scaler Loading Function --- #
# def _load_scaler(scaler_path):
#     """ Loads the metadata scaler. """
#     ... (移除整个函数) 

================================================================================
文件路径: backend\detection\ml\model.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\ml\model.py
================================================================================

# backend/detection/ml/model.py

import torch
import torch.nn as nn
from torchvision.models import resnet50, ResNet50_Weights
from transformers import AutoModel
import logging
from django.conf import settings # Import settings

logger = logging.getLogger(__name__)

# --- Model Definitions (Modified to exclude metadata) ---

class MultimodalFakeNewsModel(nn.Module):
    """
    Multimodal model combining text and image.
    (Structure must match the saved best_text_image_model.pth weights)
    """
    def __init__(self, text_model_name=settings.TEXT_MODEL_NAME,
                 image_model_name=settings.IMAGE_MODEL_NAME,
                 text_embedding_dim=settings.TEXT_EMBEDDING_DIM,
                 img_embedding_dim=settings.IMG_EMBEDDING_DIM,
                 fusion_output_dim=settings.FUSION_OUTPUT_DIM):
        super().__init__()
        logger.info("Initializing Text-Image Multimodal Model for Inference...")

        # Text Encoder
        try:
            logger.info(f"Loading text model: {text_model_name}")
            self.text_encoder = AutoModel.from_pretrained(text_model_name)
        except Exception as e:
            logger.error(f"Failed to load text model {text_model_name}: {e}")
            raise

        # Image Encoder
        logger.info(f"Loading image model: {image_model_name}")
        if image_model_name == 'resnet50':
            self.image_encoder = resnet50(weights=None)
            self.image_encoder.fc = nn.Identity() # Remove classifier
            self.img_embedding_dim = img_embedding_dim # Use dim from settings
        else:
            raise ValueError(f"Image model '{image_model_name}' not currently supported for inference setup.")

        # Fusion Layer
        logger.info("Initializing fusion layer...")
        self.fusion_dim = text_embedding_dim + self.img_embedding_dim
        self.fusion_layer = nn.Sequential(
            nn.Linear(self.fusion_dim, fusion_output_dim),
            nn.ReLU(),
            nn.Dropout(0.5) # Match dropout from training
        )

        # Classifier Head
        logger.info("Initializing classifier head...")
        self.classifier = nn.Linear(fusion_output_dim, 1)

    def forward(self, input_ids, attention_mask, image, image_available):
        # Text Features
        text_outputs = self.text_encoder(input_ids=input_ids, attention_mask=attention_mask)
        text_features = text_outputs.last_hidden_state[:, 0, :]

        # Image Features
        batch_size = image.shape[0]
        image_features = torch.zeros(batch_size, self.img_embedding_dim, device=image.device)
        valid_image_mask = image_available.bool()
        if valid_image_mask.any():
            valid_images = image[valid_image_mask]
            if valid_images.shape[2] != settings.IMAGE_MODEL_INPUT_SIZE or valid_images.shape[3] != settings.IMAGE_MODEL_INPUT_SIZE:
                 logger.warning(f"Input image size {valid_images.shape[2:]} doesn't match expected {settings.IMAGE_MODEL_INPUT_SIZE}. Ensure transforms are correct.")
            valid_image_features = self.image_encoder(valid_images)
            image_features[valid_image_mask] = valid_image_features

        # Fusion
        fused_features = torch.cat((text_features, image_features), dim=1)
        fused_output = self.fusion_layer(fused_features)

        # Classification
        logits = self.classifier(fused_output)
        return logits.squeeze(-1) 

================================================================================
文件路径: backend\detection\services\detection_service.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\services\detection_service.py
================================================================================




================================================================================
文件路径: backend\detection\services\detector.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\services\detector.py
================================================================================

"""
虚假新闻检测核心服务
"""
import os
import time
import logging
import json
import numpy as np
import torch
import joblib
import asyncio
from pathlib import Path
from datetime import datetime
from django.conf import settings
from django.utils import timezone
from ..models import Detection
from .llm_verifier import verify_news_with_llms_async # Import the async LLM verifier
from ..ml.model import MultimodalFakeNewsModel # Import your model definition
from ..ml.data_utils import get_tokenizer, get_image_transforms, preprocess_input # Import utils

# 导入SystemSettings模型
from settings.models import SystemSettings

logger = logging.getLogger(__name__)

class FakeNewsDetector:
    """
    虚假新闻检测器类
    整合自训练的多模态模型和LLM交叉验证。
    """

    def __init__(self, detection_id):
        """
        初始化检测器
        - 加载自训练模型和scaler
        - 加载tokenizer和图像变换器
        - 获取Detection实例
        """
        self.detection_id = detection_id
        try:
            self.detection = Detection.objects.get(id=detection_id)
        except Detection.DoesNotExist:
            logger.error(f"Detection record with ID {detection_id} not found.")
            raise

        self.device = torch.device(settings.DEVICE)
        logger.info(f"Using device: {self.device}")

        # 加载自训练模型
        self.model = self._load_model()
        if self.model:
             self.model.to(self.device)
             self.model.eval() # Set model to evaluation mode

        # 移除加载元数据Scaler
        # self.scaler = self._load_scaler()
        self.scaler = None # Explicitly set to None

        # 加载Tokenizer和图像变换
        self.tokenizer = get_tokenizer()
        self.image_transform = get_image_transforms()

        # 更新状态为处理中
        self._update_status(Detection.STATUS_PROCESSING)

    def _load_model(self):
        """ 加载 PyTorch 模型 """
        model_path = settings.MODEL_PATH
        if not Path(model_path).exists():
            logger.error(f"自训练模型文件未找到: {model_path}")
            return None
        try:
            model = MultimodalFakeNewsModel() # Initialize model structure
            # Load state dict, ensuring map_location handles CPU/GPU
            model.load_state_dict(torch.load(model_path, map_location=self.device))
            logger.info(f"自训练模型加载成功: {model_path}")
            return model
        except Exception as e:
            logger.exception(f"加载自训练模型失败 {model_path}: {e}")
            return None

    def _update_status(self, status, error_message=None):
        """ 更新检测记录的状态 """
        self.detection.status = status
        if error_message:
            self.detection.error_message = str(error_message)[:1000] # Limit error message length
        if status == Detection.STATUS_COMPLETED:
            self.detection.completed_at = timezone.now()
        elif status == Detection.STATUS_FAILED:
             self.detection.completed_at = timezone.now() # Mark completion time even on failure
        
        self.detection.save()
        logger.info(f"Detection {self.detection_id} status updated to {status}.")
    
    def detect(self):
        """
        执行检测流程:
        1. 预处理文本和图像 (包括处理元数据缺失)
        2. 使用自训练模型进行预测
        3. 使用LLM进行交叉验证 (异步)
        4. 融合结果
        5. 更新数据库记录
        """
        start_time = time.time()
        logger.info(f"--- 开始检测 ID: {self.detection_id} ---")
        
        # 准备文本和图像路径
        text_content = f"{self.detection.title} {self.detection.content}"
        image_path = None
        if self.detection.image:
            try:
                # Ensure MEDIA_ROOT is correctly configured
                full_image_path = Path(settings.MEDIA_ROOT) / self.detection.image.name
                if full_image_path.is_file():
                    image_path = full_image_path
                else:
                    logger.warning(f"图像文件在路径 {full_image_path} 未找到。")
            except Exception as e:
                logger.error(f"获取图像路径时出错: {e}")

        # --- 1. 自训练模型预测 --- #
        local_model_result = {
                'result': Detection.RESULT_UNKNOWN,
                'confidence': 0.0,
            'error': None
        }
        if self.model:
            try:
                # 预处理输入
                processed_input = preprocess_input(
                    text=text_content,
                    image_path=image_path,
                    tokenizer=self.tokenizer,
                    image_transform=self.image_transform,
                    # scaler=self.scaler, # 移除 scaler 参数
                    device=self.device
                )

                # 模型推理
                with torch.no_grad():
                    # 调用模型时移除 metadata
                    logits = self.model(input_ids=processed_input['input_ids'], 
                                         attention_mask=processed_input['attention_mask'], 
                                         image=processed_input['image'], 
                                         image_available=processed_input['image_available'])
                    probability = torch.sigmoid(logits).item() # 获取概率值 (0-1)

                # 结果转换
                # 假设概率 > 0.5 为 Fake (需要根据你的模型训练目标确认)
                local_model_result['result'] = Detection.RESULT_FAKE if probability >= 0.5 else Detection.RESULT_REAL
                # 置信度可以基于概率与0.5的距离
                local_model_result['confidence'] = probability if probability >= 0.5 else (1 - probability)
                logger.info(f"本地模型预测结果: {local_model_result['result']}, 原始概率: {probability:.4f}, 置信度: {local_model_result['confidence']:.4f}")

            except Exception as e:
                logger.exception(f"本地模型推理失败: {e}")
                local_model_result['error'] = f"本地模型推理失败: {str(e)}"
        else:
            local_model_result['error'] = "本地模型未加载"
            logger.error("本地模型未加载，跳过推理。")

        # --- 2. LLM 交叉验证 --- #
        llm_result = {
            'overall_verdict': 'Skipped',
            'aggregated_confidence': 0.0,
            'error': None,
            'details': None
        }
        if settings.OPENROUTER_API_KEY:
            try:
                # 在同步代码中运行异步LLM验证函数
                llm_raw_result = asyncio.run(verify_news_with_llms_async(text_content, image_path))

                if llm_raw_result and not llm_raw_result.get('error'):
                     llm_result['overall_verdict'] = llm_raw_result.get('overall_verdict', 'Parsing Error')
                     llm_result['aggregated_confidence'] = llm_raw_result.get('aggregated_confidence', 0.0)
                     llm_result['details'] = llm_raw_result # Store full details
                     logger.info(f"LLM 验证结果: {llm_result['overall_verdict']}, 置信度: {llm_result['aggregated_confidence']:.4f}")
                else:
                     llm_result['error'] = llm_raw_result.get('error', 'Unknown LLM error')
                     llm_result['details'] = llm_raw_result
                     logger.error(f"LLM 验证失败: {llm_result['error']}")

            except Exception as e:
                logger.exception(f"LLM 验证过程中发生异常: {e}")
                llm_result['error'] = f"LLM 验证异常: {str(e)}"
        else:
             llm_result['error'] = "OpenRouter API Key 未配置"
             logger.warning("OpenRouter API Key 未配置，跳过 LLM 验证。")

        # --- 3. 结果融合 --- #
        final_result = Detection.RESULT_UNKNOWN
        final_confidence = 0.0
        fusion_strategy = "N/A"
        fusion_details = [] # 用于记录融合过程细节
        weighted_score = None # 初始化加权分数

        # --- 获取并映射模型结果 ---
        llm_verdict_mapped = Detection.RESULT_UNKNOWN
        llm_conf = llm_result.get('aggregated_confidence', 0.0)
        llm_overall_verdict_str = llm_result.get('overall_verdict', '').lower()
        if "fake" in llm_overall_verdict_str:
            llm_verdict_mapped = Detection.RESULT_FAKE
        elif "true" in llm_overall_verdict_str:
            llm_verdict_mapped = Detection.RESULT_REAL
        # 其他 (uncertain, mixed, skipped, error) 保持 unknown

        local_verdict = local_model_result.get('result', Detection.RESULT_UNKNOWN)
        local_conf = local_model_result.get('confidence', 0.0)
        local_error = local_model_result.get('error')
        llm_error = llm_result.get('error')
        
        # --- 从数据库获取模型权重 ---
        # 定义设置键名和默认值
        LOCAL_MODEL_WEIGHT_KEY = 'local_model_weight'
        LLM_WEIGHT_KEY = 'llm_weight'
        FAKE_THRESHOLD_KEY = 'fake_threshold'
        REAL_THRESHOLD_KEY = 'real_threshold'
        
        DEFAULT_LOCAL_MODEL_WEIGHT = 0.4
        DEFAULT_LLM_WEIGHT = 0.6
        DEFAULT_FAKE_THRESHOLD = 0.65
        DEFAULT_REAL_THRESHOLD = 0.35
        
        # 从数据库获取设置，如果不存在则使用默认值
        LOCAL_MODEL_WEIGHT = SystemSettings.get_value(LOCAL_MODEL_WEIGHT_KEY, DEFAULT_LOCAL_MODEL_WEIGHT)
        LLM_WEIGHT = SystemSettings.get_value(LLM_WEIGHT_KEY, DEFAULT_LLM_WEIGHT)
        FAKE_THRESHOLD = SystemSettings.get_value(FAKE_THRESHOLD_KEY, DEFAULT_FAKE_THRESHOLD)
        REAL_THRESHOLD = SystemSettings.get_value(REAL_THRESHOLD_KEY, DEFAULT_REAL_THRESHOLD)
        
        logger.info(f"使用模型权重设置: 本地模型={LOCAL_MODEL_WEIGHT}, LLM={LLM_WEIGHT}, " 
                   f"虚假阈值={FAKE_THRESHOLD}, 真实阈值={REAL_THRESHOLD}")
        
        # --- 数值化判断结果 (Real=0, Fake=1, Unknown=0.5) ---
        def verdict_to_score(verdict_str):
            if verdict_str == Detection.RESULT_REAL:
                return 0.0
            elif verdict_str == Detection.RESULT_FAKE:
                return 1.0
            else:
                return 0.5
        
        llm_numeric_score = verdict_to_score(llm_verdict_mapped)
        local_numeric_score = verdict_to_score(local_verdict)

        # --- 检查模型有效性 ---
        local_model_active = local_error is None and local_verdict != Detection.RESULT_UNKNOWN
        # LLM 只有在无错误且判断明确 (Fake/Real) 时才算 active
        llm_active = llm_error is None and llm_verdict_mapped != Detection.RESULT_UNKNOWN 

        # --- 计算融合结果 --- 
        if local_model_active and llm_active:
            # Case 1: 两个模型都有效
            effective_local_weight = LOCAL_MODEL_WEIGHT
            effective_llm_weight = LLM_WEIGHT
            total_weight = effective_local_weight + effective_llm_weight
            
            # 计算加权分数
            weighted_score = ((local_numeric_score * effective_local_weight) + 
                             (llm_numeric_score * effective_llm_weight)) / total_weight
            # 计算加权置信度
            weighted_confidence = ((local_conf * effective_local_weight) + 
                                (llm_conf * effective_llm_weight)) / total_weight

            # 根据加权分数和阈值决定最终结果
            if weighted_score >= FAKE_THRESHOLD:
                final_result = Detection.RESULT_FAKE
                final_confidence = 0.5 + (weighted_score - 0.5) 
                final_confidence = final_confidence * weighted_confidence 
            elif weighted_score <= REAL_THRESHOLD:
                final_result = Detection.RESULT_REAL
                final_confidence = 0.5 + (0.5 - weighted_score)
                final_confidence = final_confidence * weighted_confidence
            else:
                final_result = Detection.RESULT_UNKNOWN
                final_confidence = 0.0  # 对于未知结果，置信度始终为0
            
            fusion_strategy = f"Weighted Average (Both Active - Local W: {effective_local_weight:.2f}, LLM W: {effective_llm_weight:.2f}), Score: {weighted_score:.3f}"
            fusion_details = [
                f"Local model active (Verdict: {local_verdict}, Conf: {local_conf:.3f})",
                f"LLM active (Mapped Verdict: {llm_verdict_mapped}, Conf: {llm_conf:.3f}, Raw: {llm_overall_verdict_str})"
            ]

        elif local_model_active:
            # Case 2: 只有本地模型有效
            fusion_strategy = f"Local Model Only (LLM Inactive/Uncertain)"
            final_result = local_verdict
            final_confidence = local_conf * 0.8 # 置信度折减
            fusion_details = [
                f"Local model active (Verdict: {local_verdict}, Conf: {local_conf:.3f})",
                f"LLM inactive/uncertain (Error: {llm_error}, Mapped Verdict: {llm_verdict_mapped}, Raw: {llm_overall_verdict_str})",
                f"Confidence adjusted due to LLM inactivity/uncertainty. Original local: {local_conf:.3f}"
            ]
            weighted_score = local_numeric_score # 记录分数以便分析

        elif llm_active:
            # Case 3: 只有 LLM 有效
            fusion_strategy = f"LLM Only (Local Inactive/Uncertain)"
            final_result = llm_verdict_mapped
            final_confidence = llm_conf * 0.8 # 置信度折减
            fusion_details = [
                f"Local model inactive (Error: {local_error}, Verdict: {local_verdict})",
                f"LLM active (Mapped Verdict: {llm_verdict_mapped}, Conf: {llm_conf:.3f}, Raw: {llm_overall_verdict_str})",
                f"Confidence adjusted due to Local inactivity. Original LLM: {llm_conf:.3f}"
            ]
            weighted_score = llm_numeric_score # 记录分数以便分析

        else:
            # Case 4: 两个模型都无效/不确定
            fusion_strategy = "Both Models Failed/Unknown/Uncertain"
            final_result = Detection.RESULT_UNKNOWN
            final_confidence = 0.0  # 对于未知结果，置信度始终为0
            fusion_details = [
                f"Local model inactive (Error: {local_error}, Verdict: {local_verdict})",
                f"LLM inactive/uncertain (Error: {llm_error}, Mapped Verdict: {llm_verdict_mapped}, Raw: {llm_overall_verdict_str})"
            ]
            weighted_score = 0.5 # 默认为中性分数

        # 确保最终置信度在 [0, 1] 范围内
        final_confidence = max(0.0, min(1.0, final_confidence))

        logger.info(f"融合结果: {final_result}, 置信度: {final_confidence:.4f} (策略: {fusion_strategy})")
        logger.info(f"融合详情: {fusion_details}")

        # --- 4. 更新数据库 --- #
        analysis = {
            'timestamp': timezone.now().isoformat(),
            'local_model': local_model_result,
            'llm_verification': llm_result,
            'fusion': {
                'strategy': fusion_strategy,
                'details': fusion_details, 
                'weighted_score': weighted_score, 
                'final_verdict': final_result,
                'final_confidence': final_confidence
            }
        }
        self.detection.result = final_result
        self.detection.confidence_score = final_confidence
        self.detection.analysis_result = analysis
        self._update_status(Detection.STATUS_COMPLETED)

        end_time = time.time()
        logger.info(f"--- 检测完成 ID: {self.detection_id} (耗时: {end_time - start_time:.2f} 秒) ---")
        
        return {
            'result': final_result,
            'confidence': final_confidence,
            'analysis': analysis
        } 

================================================================================
文件路径: backend\detection\services\feature_extraction.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\services\feature_extraction.py
================================================================================




================================================================================
文件路径: backend\detection\services\llm_verifier.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\services\llm_verifier.py
================================================================================

# backend/detection/services/llm_verifier.py

import os
import logging
import time
import json
import numpy as np
from pathlib import Path
from PIL import Image
import base64
from io import BytesIO
import asyncio
from django.conf import settings # Import Django settings

# --- Use AsyncOpenAI library --- (Ensure installed: pip install openai)
try:
    from openai import AsyncOpenAI
except ImportError:
    logging.error("OpenAI library not installed. Please install it: pip install openai")
    AsyncOpenAI = None

logger = logging.getLogger(__name__)

# --- Configuration (Adapted from llm_cross_validation.py, uses Django settings) ---
API_KEY = settings.OPENROUTER_API_KEY
# Use environment variables for site URL/Name, or defaults
YOUR_SITE_URL = os.environ.get("YOUR_SITE_URL", "http://localhost")
YOUR_SITE_NAME = os.environ.get("YOUR_SITE_NAME", "MM-DFD-Backend")

# Define models (Consider making these configurable in settings.py too)
OR_TEXT_MODELS = [
    "perplexity/sonar-reasoning-pro",
    "perplexity/sonar",
    "google/gemini-2.0-flash-001", # Supports vision
    "deepseek/deepseek-r1",
    "deepseek/deepseek-chat-v3-0324",
]
OR_IMAGE_MODELS = [
    "google/gemini-2.0-flash-001",
]

MODEL_WEIGHTS = {
    "perplexity/sonar-reasoning-pro": 0.4,
    "perplexity/sonar": 0.2,
    "google/gemini-2.0-flash-001": 0.15,
    "deepseek/deepseek-r1": 0.15,
    "deepseek/deepseek-chat-v3-0324": 0.1,
}

DEFAULT_API_DELAY = 1.0 # Adjusted async delay

# --- Helper Functions (Mostly copied from llm_cross_validation.py) ---

def load_image_as_base64(image_path):
    """Loads an image file and returns its base64 encoded string."""
    if not image_path:
        logger.warning("No image path provided to load_image_as_base64.")
        return None
    abs_path = Path(image_path)
    if not abs_path.is_file():
        logger.error(f"Image file not found or is not a file: {abs_path}")
        return None
    try:
        logger.info(f"Loading image for LLM from: {abs_path}")
        with Image.open(abs_path) as img:
            output_format = "JPEG" if img.format != "PNG" else "PNG"
            buffered = BytesIO()
            if output_format == "JPEG" and img.mode == 'RGBA': img = img.convert('RGB')
            img.save(buffered, format=output_format)
            img_byte = buffered.getvalue()
            return base64.b64encode(img_byte).decode('utf-8')
    except Exception as e:
        logger.warning(f"Could not load or encode image {abs_path}: {e}")
        return None

def format_structured_llm_response(model_name, success, data=None, error=None):
    """Standardizes the response format."""
    base_response = {
        "model": model_name,
        "success": success,
        "verdict": "Error" if not success else "Parsing Error",
        "confidence": 0.0,
        "reason": None,
        "error": str(error) if error else (None if success else "Unknown error during processing"),
        "raw_response": None
    }
    if success and isinstance(data, dict):
        base_response.update({
            "verdict": data.get("verdict", "Parsing Error"),
            "confidence": data.get("confidence", 0.0),
            "reason": data.get("reason", "No reason provided or parsing failed."),
            "error": None
        })
        try:
            confidence_val = float(base_response["confidence"])
            base_response["confidence"] = max(0.0, min(1.0, confidence_val))
        except (ValueError, TypeError):
            logger.warning(f"Model {model_name} returned non-numeric confidence: {base_response['confidence']}. Setting to 0.0.")
            base_response["confidence"] = 0.0
    elif not success and isinstance(data, str):
        base_response["raw_response"] = data
        base_response["error"] = f"Failed to parse LLM response as JSON. {base_response['error'] if base_response['error'] else ''}".strip()
    return base_response


async def call_openrouter_api_async(prompt, model_name, image_base64=None):
    """ASYNC calls the specified model via the OpenRouter API."""
    if not AsyncOpenAI: return format_structured_llm_response(model_name, False, error="AsyncOpenAI client not available.")
    if not API_KEY: return format_structured_llm_response(model_name, False, error="OpenRouter API key not configured in settings.")

    client = AsyncOpenAI(base_url="https://openrouter.ai/api/v1", api_key=API_KEY)
    messages = [{"role": "user", "content": []}]
    messages[0]["content"].append({"type": "text", "text": prompt})

    if image_base64 and model_name in OR_IMAGE_MODELS:
        try:
            mime = "image/jpeg" if image_base64.startswith("/9j/") else "image/png"
            image_url = f"data:{mime};base64,{image_base64}"
            messages[0]["content"].append({"type": "image_url", "image_url": {"url": image_url}})
            logger.info(f"Preparing image for vision model: {model_name}")
        except Exception as img_err:
             logger.error(f"Error processing image for model {model_name}: {img_err}")
             # Proceed without image if processing fails
    elif image_base64:
        logger.warning(f"Image provided, but model {model_name} not in vision list. Sending text only.")

    try:
        logger.debug(f"Calling OpenRouter model: {model_name}")
        completion = await client.chat.completions.create(
            extra_headers={"HTTP-Referer": YOUR_SITE_URL, "X-Title": YOUR_SITE_NAME},
            model=model_name,
            messages=messages,
            max_tokens=700,
            temperature=0.3,
            # response_format={"type": "json_object"}, # Uncomment if models support JSON reliably
        )
        raw_content = completion.choices[0].message.content
        logger.debug(f"Raw response from {model_name}: {raw_content}")

        try:
            if raw_content.strip().startswith("```json"):
                 raw_content = raw_content.strip()[7:-3].strip()
            elif raw_content.strip().startswith("```"):
                 raw_content = raw_content.strip()[3:-3].strip()
            parsed_data = json.loads(raw_content)
            if not isinstance(parsed_data, dict):
                 raise ValueError("Response is not a JSON object.")
            return format_structured_llm_response(model_name, True, data=parsed_data)
        except json.JSONDecodeError as json_err:
            logger.warning(f"Failed to parse JSON from {model_name}: {json_err}. Raw: {raw_content}")
            return format_structured_llm_response(model_name, False, error=f"JSONDecodeError: {json_err}", data=raw_content)
        except ValueError as val_err:
             logger.warning(f"Parsed JSON structure invalid from {model_name}: {val_err}. Raw: {raw_content}")
             return format_structured_llm_response(model_name, False, error=f"Invalid JSON Structure: {val_err}", data=raw_content)

    except Exception as e:
        logger.error(f"OpenRouter API call failed for model {model_name}: {e}")
        error_detail = str(e)
        # Attempt to get more info if available (depends on the specific exception)
        if hasattr(e, 'response') and hasattr(e.response, 'text'): error_detail += f" | Response: {e.response.text}"
        return format_structured_llm_response(model_name, False, error=error_detail)


async def verify_news_with_llms_async(text_input, image_path_input=None):
    """
    ASYNC verifies a news item using multiple LLMs and aggregates results.
    Returns the aggregated result dictionary.
    """
    logger.info("--- Starting LLM Verification (Async) ---")
    if not API_KEY:
        logger.error("OpenRouter API key is not configured in settings.")
        return {"error": "API key not configured.", "overall_verdict": "Error", "aggregated_confidence": 0.0}

    img_b64 = None
    if image_path_input:
        img_b64 = load_image_as_base64(image_path_input)
        if not img_b64:
            logger.warning(f"Failed to load image {image_path_input}, proceeding without it.")

    tasks = []
    if text_input:
        text_prompt = f"""请对以下新闻内容进行事实核查。请严格按照以下 JSON 格式返回你的分析结果，不要添加任何额外的解释性文字或markdown标记：
{{ "verdict": "判断结果", "confidence": 置信度分数, "reason": "理由/证据摘要" }}
判断结果必须是"真实"、"虚假"、"无法核实"或"混合信息"之一。置信度分数是一个 0.0 到 1.0 之间的小数。理由请提供简洁客观的分析依据。
新闻内容："{text_input}"""
        for model_id in OR_TEXT_MODELS:
            tasks.append(asyncio.create_task(call_openrouter_api_async(text_prompt, model_id))) # Removed api_key arg, uses global
            await asyncio.sleep(0.05)

    if img_b64:
        image_prompt = f"""请分析提供的图片，并结合以下新闻文本进行判断。请严格按照以下 JSON 格式返回你的分析结果：
{{ "verdict": "综合判断结果", "confidence": 置信度分数, "reason": "图片与文本关联性分析及判断理由" }}
综合判断结果是对结合图片和文本后新闻整体真实性的判断（真实/虚假/无法核实/混合信息）。置信度分数是你对此判断的确信程度（0.0-1.0）。
新闻文本："{text_input if text_input else '（无文本提供）'}"""
        if not text_input:
            image_prompt = f"""请分析提供的图片，判断它所描绘的场景或事件的真实性。请严格按照以下 JSON 格式返回你的分析结果：
{{ "verdict": "图片真实性判断", "confidence": 置信度分数, "reason": "图片分析理由（例如：是否像真实照片、AI生成、拼接、摆拍等）" }}
图片真实性判断是"真实"、"疑似伪造"、"无法判断"之一。"""
        for model_id in OR_IMAGE_MODELS:
             tasks.append(asyncio.create_task(call_openrouter_api_async(image_prompt, model_id, image_base64=img_b64))) # Removed api_key arg
             await asyncio.sleep(0.05)

    if not tasks:
        logger.warning("No text or image provided, LLM verification skipped.")
        return {"error": "No text or image for LLM verification.", "overall_verdict": "Skipped", "aggregated_confidence": 0.0}

    logger.info(f"Sending {len(tasks)} LLM API requests concurrently...")
    individual_results = await asyncio.gather(*tasks)
    logger.info("LLM API responses received.")

    text_results_raw = [res for res in individual_results if res['model'] in OR_TEXT_MODELS]
    image_results_raw = [res for res in individual_results if res['model'] in OR_IMAGE_MODELS]

    # --- Aggregation Logic (Focus on Text) ---
    final_verdict = "Inconclusive"
    final_confidence = 0.5
    needs_review = False
    valid_confidences = []
    valid_text_results = [r for r in text_results_raw if r['success'] and isinstance(r.get('confidence'), (int, float))]

    if valid_text_results:
        total_weight = 0
        weighted_sum_conf = 0 # Weighted sum of confidences
        weighted_sum_fake_lean = 0 # Weighted sum of leaning towards fake (1=Fake, 0=True, 0.5=Uncertain)

        for result in valid_text_results:
            model = result['model']
            weight = MODEL_WEIGHTS.get(model, 0)
            if weight > 0:
                confidence = result['confidence']
                verdict_str = result.get('verdict', '').lower()
                verdict_score = 0.5 # Default uncertain
                if '虚假' in verdict_str or 'fake' in verdict_str:
                    verdict_score = 1.0
                elif '真实' in verdict_str or 'true' in verdict_str:
                    verdict_score = 0.0

                weighted_sum_conf += weight * confidence
                # Weighted lean: use verdict score, potentially modified by confidence?
                # Simple approach: use verdict_score directly
                weighted_sum_fake_lean += weight * verdict_score
                total_weight += weight
                valid_confidences.append(confidence)

        if total_weight > 0:
            final_confidence = weighted_sum_conf / total_weight # Average confidence
            avg_fake_lean = weighted_sum_fake_lean / total_weight # Average lean towards fake

            if len(valid_confidences) > 1:
                confidence_std_dev = np.std(valid_confidences)
                if confidence_std_dev > 0.25: needs_review = True

            # Determine verdict based on average lean
            if avg_fake_lean >= 0.75:
                final_verdict = "Likely Fake"
            elif avg_fake_lean <= 0.25:
                final_verdict = "Likely True"
            elif avg_fake_lean > 0.4 and avg_fake_lean < 0.6:
                final_verdict = "Uncertain / Mixed Signals"
                needs_review = True # Flag middle ground for review too
            else:
                 final_verdict = "Uncertain"
        else:
            logger.warning("No valid text results with weights found for LLM aggregation.")
            final_verdict = "Aggregation Error"

    aggregated_result = {
        "overall_verdict": final_verdict,
        "aggregated_confidence": round(final_confidence, 3),
        "needs_manual_review": needs_review,
        "text_verifications": text_results_raw,
        "image_verifications": image_results_raw,
    }
    logger.info("--- LLM Verification Finished ---")
    return aggregated_result 

================================================================================
文件路径: backend\detection\services\model_loader.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\services\model_loader.py
================================================================================




================================================================================
文件路径: backend\detection\services\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\detection\services\__init__.py
================================================================================

"""
检测服务模块
""" 

================================================================================
文件路径: backend\settings\admin.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\admin.py
================================================================================

from django.contrib import admin

# Register your models here.


================================================================================
文件路径: backend\settings\apps.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\apps.py
================================================================================

from django.apps import AppConfig


class SettingsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'settings'


================================================================================
文件路径: backend\settings\models.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\models.py
================================================================================

from django.db import models
from django.utils.translation import gettext_lazy as _

class SystemSettings(models.Model):
    """
    系统设置模型，用于存储全局设置
    使用键值对方式存储设置项
    """
    key = models.CharField(_('设置键名'), max_length=50, unique=True)
    value = models.TextField(_('设置值'))
    value_type = models.CharField(_('值类型'), max_length=20, choices=[
        ('string', _('字符串')),
        ('integer', _('整数')),
        ('float', _('浮点数')),
        ('boolean', _('布尔值')),
        ('json', _('JSON对象'))
    ], default='string')
    description = models.CharField(_('描述'), max_length=255, blank=True, null=True)
    created_at = models.DateTimeField(_('创建时间'), auto_now_add=True)
    updated_at = models.DateTimeField(_('更新时间'), auto_now=True)
    
    class Meta:
        verbose_name = _('系统设置')
        verbose_name_plural = _('系统设置')
        ordering = ['key']
    
    def __str__(self):
        return f"{self.key}: {self.value}"
    
    @classmethod
    def get_value(cls, key, default=None):
        """
        获取指定键的设置值
        
        Args:
            key: 设置键名
            default: 默认值，如果设置不存在返回此值
            
        Returns:
            根据值类型转换后的设置值
        """
        try:
            setting = cls.objects.get(key=key)
            if setting.value_type == 'integer':
                return int(setting.value)
            elif setting.value_type == 'float':
                return float(setting.value)
            elif setting.value_type == 'boolean':
                return setting.value.lower() in ('true', 'yes', '1')
            elif setting.value_type == 'json':
                import json
                return json.loads(setting.value)
            else:
                # 字符串类型
                return setting.value
        except cls.DoesNotExist:
            return default
    
    @classmethod
    def set_value(cls, key, value, value_type=None, description=None):
        """
        设置指定键的值
        
        Args:
            key: 设置键名
            value: 设置值
            value_type: 值类型，如果为None则自动推断
            description: 设置描述
            
        Returns:
            设置实例
        """
        # 自动推断值类型
        if value_type is None:
            if isinstance(value, bool):
                value_type = 'boolean'
                value = str(value).lower()
            elif isinstance(value, int):
                value_type = 'integer'
                value = str(value)
            elif isinstance(value, float):
                value_type = 'float'
                value = str(value)
            elif isinstance(value, (dict, list)):
                value_type = 'json'
                import json
                value = json.dumps(value)
            else:
                value_type = 'string'
                value = str(value)
        
        # 获取或创建设置
        setting, created = cls.objects.update_or_create(
            key=key,
            defaults={
                'value': value,
                'value_type': value_type
            }
        )
        
        # 如果提供了描述，则更新
        if description is not None:
            setting.description = description
            setting.save()
        
        return setting


================================================================================
文件路径: backend\settings\serializers.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\serializers.py
================================================================================

from rest_framework import serializers
from .models import SystemSettings

class SystemSettingsSerializer(serializers.ModelSerializer):
    """系统设置序列化器"""
    class Meta:
        model = SystemSettings
        fields = ['key', 'value', 'value_type', 'description', 'updated_at']
        read_only_fields = ['updated_at']

class ModelWeightsSerializer(serializers.Serializer):
    """模型权重配置序列化器"""
    local_model_weight = serializers.FloatField(min_value=0.0, max_value=1.0)
    llm_weight = serializers.FloatField(min_value=0.0, max_value=1.0)
    fake_threshold = serializers.FloatField(min_value=0.5, max_value=0.9)
    real_threshold = serializers.FloatField(min_value=0.1, max_value=0.5)
    
    def validate(self, data):
        """验证模型权重总和为1"""
        if abs(data['local_model_weight'] + data['llm_weight'] - 1.0) > 0.001:
            raise serializers.ValidationError("本地模型权重和LLM权重之和必须为1")
        
        if data['real_threshold'] >= data['fake_threshold'] - 0.1:
            raise serializers.ValidationError("真实新闻阈值必须小于虚假新闻阈值至少0.1")
        
        return data

class ApiConfigSerializer(serializers.Serializer):
    """API配置序列化器"""
    openrouter_api_key = serializers.CharField(allow_blank=True, max_length=100, required=False)
    use_gpu = serializers.BooleanField(required=False, default=False)
    
    def validate_openrouter_api_key(self, value):
        """验证API密钥格式"""
        if value and not value.startswith('sk-or-v1-'):
            raise serializers.ValidationError("无效的OpenRouter API密钥格式")
        return value 

================================================================================
文件路径: backend\settings\tests.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.


================================================================================
文件路径: backend\settings\urls.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\urls.py
================================================================================

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import SettingsViewSet

router = DefaultRouter()
router.register(r'settings', SettingsViewSet, basename='settings')

urlpatterns = [
    path('', include(router.urls)),
] 

================================================================================
文件路径: backend\settings\views.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\views.py
================================================================================

from django.shortcuts import render
import os
import logging
import glob
from django.conf import settings as django_settings
from django.utils.translation import gettext_lazy as _
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import SystemSettings
from .serializers import (
    SystemSettingsSerializer, ModelWeightsSerializer, 
    ApiConfigSerializer
)

logger = logging.getLogger(__name__)

# Create your views here.

# 权限类
class IsAdminUser(permissions.BasePermission):
    """
    只允许管理员访问的权限类
    """
    def has_permission(self, request, view):
        return bool(request.user and request.user.is_authenticated and request.user.is_staff)

class SettingsViewSet(viewsets.ViewSet):
    """
    系统设置视图集
    """
    permission_classes = [permissions.IsAuthenticated, IsAdminUser]
    
    # 设置键名常量
    LOCAL_MODEL_WEIGHT = 'local_model_weight'
    LLM_WEIGHT = 'llm_weight'
    FAKE_THRESHOLD = 'fake_threshold'
    REAL_THRESHOLD = 'real_threshold'
    OPENROUTER_API_KEY = 'openrouter_api_key'
    USE_GPU = 'use_gpu'
    
    # 默认值
    DEFAULT_LOCAL_MODEL_WEIGHT = 0.4
    DEFAULT_LLM_WEIGHT = 0.6
    DEFAULT_FAKE_THRESHOLD = 0.65
    DEFAULT_REAL_THRESHOLD = 0.35
    
    @action(detail=False, methods=['get'])
    def model_weights(self, request):
        """
        获取模型权重设置
        """
        # 获取当前设置
        local_model_weight = SystemSettings.get_value(self.LOCAL_MODEL_WEIGHT, self.DEFAULT_LOCAL_MODEL_WEIGHT)
        llm_weight = SystemSettings.get_value(self.LLM_WEIGHT, self.DEFAULT_LLM_WEIGHT)
        fake_threshold = SystemSettings.get_value(self.FAKE_THRESHOLD, self.DEFAULT_FAKE_THRESHOLD)
        real_threshold = SystemSettings.get_value(self.REAL_THRESHOLD, self.DEFAULT_REAL_THRESHOLD)
        openrouter_api_key = os.environ.get('OPENROUTER_API_KEY', '')  # 从环境变量获取API密钥
        use_gpu = getattr(django_settings, 'DEVICE', '') == 'cuda'
        
        data = {
            'local_model_weight': local_model_weight,
            'llm_weight': llm_weight,
            'fake_threshold': fake_threshold,
            'real_threshold': real_threshold,
            'openrouter_api_key': openrouter_api_key,
            'use_gpu': use_gpu
        }
        
        return Response(data)
    
    @model_weights.mapping.post
    def update_model_weights(self, request):
        """
        更新模型权重设置
        """
        serializer = ModelWeightsSerializer(data=request.data)
        if serializer.is_valid():
            data = serializer.validated_data
            
            # 保存设置到数据库
            SystemSettings.set_value(
                self.LOCAL_MODEL_WEIGHT, 
                data['local_model_weight'], 
                'float',
                '本地模型权重'
            )
            SystemSettings.set_value(
                self.LLM_WEIGHT, 
                data['llm_weight'], 
                'float',
                'LLM模型权重'
            )
            SystemSettings.set_value(
                self.FAKE_THRESHOLD, 
                data['fake_threshold'], 
                'float',
                '虚假新闻阈值'
            )
            SystemSettings.set_value(
                self.REAL_THRESHOLD, 
                data['real_threshold'], 
                'float',
                '真实新闻阈值'
            )
            
            # 记录日志
            logger.info(
                f"更新模型权重设置: 本地模型={data['local_model_weight']}, LLM={data['llm_weight']}, "
                f"虚假阈值={data['fake_threshold']}, 真实阈值={data['real_threshold']}"
            )
            
            return Response(data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=False, methods=['get'])
    def logs(self, request):
        """
        获取系统日志
        """
        try:
            # 获取日志文件路径
            log_dir = getattr(django_settings, 'LOG_DIR', os.path.join(django_settings.BASE_DIR, 'logs'))
            log_files = glob.glob(os.path.join(log_dir, '*.log'))
            
            if not log_files:
                return Response({'logs': []})
            
            # 默认读取最新的日志文件
            latest_log = max(log_files, key=os.path.getmtime)
            
            # 读取日志文件内容
            log_entries = []
            with open(latest_log, 'r', encoding='utf-8', errors='replace') as f:
                for line in f.readlines()[-500:]:  # 只读取最后500行
                    try:
                        # 尝试解析日志行
                        # 实际格式示例: INFO 2025-04-19 18:39:39,699 basehttp "GET /static/admin/css/responsive.css HTTP/1.1" 200 18559
                        line = line.strip()
                        parts = line.split(' ', 3)  # 最多分割3次，得到级别、时间戳+日志源、消息
                        
                        if len(parts) >= 2:
                            level = parts[0]  # 第一部分是日志级别
                            
                            # 处理第二部分（时间戳）和第三部分（日志源）
                            if len(parts) >= 3:
                                # 时间戳通常是固定格式：YYYY-MM-DD HH:MM:SS,SSS
                                timestamp_parts = parts[1].split(' ', 1)
                                if len(timestamp_parts) == 1 and len(parts) >= 3:
                                    # 日期和时间可能被分开了
                                    date_part = parts[1]
                                    time_part = parts[2].split(' ', 1)[0]
                                    timestamp = f"{date_part} {time_part}"
                                    
                                    # 日志源在时间后面
                                    log_source_parts = parts[2].split(' ', 1)
                                    if len(log_source_parts) > 1:
                                        log_source = log_source_parts[1]
                                        message = parts[3] if len(parts) >= 4 else ""
                                    else:
                                        log_source = log_source_parts[0]
                                        message = parts[3] if len(parts) >= 4 else ""
                                else:
                                    # 时间戳是一个完整的部分
                                    timestamp = parts[1]
                                    log_source = parts[2]
                                    message = parts[3] if len(parts) >= 4 else ""
                            else:
                                # 只有级别和内容，没有时间戳和日志源
                                timestamp = ""
                                log_source = ""
                                message = parts[1] if len(parts) >= 2 else ""
                        else:
                            # 无法解析，将整行作为消息
                            level = "INFO"
                            timestamp = ""
                            log_source = ""
                            message = line
                        
                        log_entries.append({
                            'timestamp': timestamp,
                            'level': level,
                            'logger': log_source,
                            'message': message
                        })
                    except Exception as e:
                        # 解析失败时添加原始行
                        log_entries.append({
                            'timestamp': '',
                            'level': 'ERROR',
                            'logger': 'log_parser',
                            'message': f'解析失败: {line.strip()}'
                        })
            
            return Response({'logs': log_entries})
        
        except Exception as e:
            logger.exception(f"获取日志失败: {str(e)}")
            return Response(
                {'error': f'获取日志失败: {str(e)}'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
    
    @action(detail=False, methods=['get'])
    def api_config(self, request):
        """
        获取API配置
        """
        openrouter_api_key = os.environ.get('OPENROUTER_API_KEY', '')
        use_gpu = getattr(django_settings, 'DEVICE', '') == 'cuda'
        
        data = {
            'openrouter_api_key': openrouter_api_key,
            'use_gpu': use_gpu
        }
        
        return Response(data)
    
    @api_config.mapping.post
    def update_api_config(self, request):
        """
        更新API配置
        """
        serializer = ApiConfigSerializer(data=request.data)
        if serializer.is_valid():
            data = serializer.validated_data
            
            try:
                # 获取.env文件路径
                env_path = os.path.join(django_settings.BASE_DIR, '.env')
                
                # 读取当前.env文件内容
                env_content = []
                if os.path.exists(env_path):
                    with open(env_path, 'r', encoding='utf-8') as f:
                        env_content = f.read().splitlines()
                
                # 更新或添加环境变量
                updated_env = []
                openrouter_key_found = False
                use_gpu_found = False
                
                for line in env_content:
                    if line.startswith('OPENROUTER_API_KEY='):
                        updated_env.append(f'OPENROUTER_API_KEY={data.get("openrouter_api_key", "")}')
                        openrouter_key_found = True
                    elif line.startswith('USE_GPU='):
                        updated_env.append(f'USE_GPU={str(data.get("use_gpu", False)).lower()}')
                        use_gpu_found = True
                    else:
                        updated_env.append(line)
                
                # 如果没找到相应的环境变量，添加它们
                if not openrouter_key_found:
                    updated_env.append(f'OPENROUTER_API_KEY={data.get("openrouter_api_key", "")}')
                
                if not use_gpu_found:
                    updated_env.append(f'USE_GPU={str(data.get("use_gpu", False)).lower()}')
                
                # 写回.env文件
                with open(env_path, 'w', encoding='utf-8') as f:
                    f.write('\n'.join(updated_env))
                
                # 更新当前进程的环境变量
                os.environ['OPENROUTER_API_KEY'] = data.get('openrouter_api_key', '')
                
                # 记录日志
                logger.info(f"更新API配置: OPENROUTER_API_KEY已更新, USE_GPU={data.get('use_gpu', False)}")
                
                return Response({
                    'openrouter_api_key': data.get('openrouter_api_key', ''),
                    'use_gpu': data.get('use_gpu', False)
                })
            except Exception as e:
                logger.exception(f"更新API配置失败: {str(e)}")
                return Response(
                    {'error': f'更新API配置失败: {str(e)}'},
                    status=status.HTTP_500_INTERNAL_SERVER_ERROR
                )
        
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)


================================================================================
文件路径: backend\settings\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\__init__.py
================================================================================



================================================================================
文件路径: backend\settings\management\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\management\__init__.py
================================================================================



================================================================================
文件路径: backend\settings\management\commands\initialize_settings.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\management\commands\initialize_settings.py
================================================================================

import os
from django.core.management.base import BaseCommand
from django.utils.translation import gettext_lazy as _
from settings.models import SystemSettings

class Command(BaseCommand):
    help = '初始化系统设置'

    def handle(self, *args, **options):
        # 模型权重设置
        defaults = [
            {
                'key': 'local_model_weight',
                'value': '0.4',
                'value_type': 'float',
                'description': '本地模型权重'
            },
            {
                'key': 'llm_weight',
                'value': '0.6',
                'value_type': 'float',
                'description': 'LLM模型权重'
            },
            {
                'key': 'fake_threshold',
                'value': '0.65',
                'value_type': 'float',
                'description': '虚假新闻阈值'
            },
            {
                'key': 'real_threshold',
                'value': '0.35',
                'value_type': 'float',
                'description': '真实新闻阈值'
            }
        ]
        
        for setting in defaults:
            _, created = SystemSettings.objects.update_or_create(
                key=setting['key'],
                defaults={
                    'value': setting['value'],
                    'value_type': setting['value_type'],
                    'description': setting['description']
                }
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f"Created setting: {setting['key']}"))
            else:
                self.stdout.write(self.style.WARNING(f"Updated existing setting: {setting['key']}"))
        
        self.stdout.write(self.style.SUCCESS('系统设置初始化完成')) 

================================================================================
文件路径: backend\settings\management\commands\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\management\commands\__init__.py
================================================================================



================================================================================
文件路径: backend\settings\migrations\0001_initial.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\migrations\0001_initial.py
================================================================================

# Generated by Django 4.2.9 on 2025-04-19 10:27

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='SystemSettings',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('key', models.CharField(max_length=50, unique=True, verbose_name='设置键名')),
                ('value', models.TextField(verbose_name='设置值')),
                ('value_type', models.CharField(choices=[('string', '字符串'), ('integer', '整数'), ('float', '浮点数'), ('boolean', '布尔值'), ('json', 'JSON对象')], default='string', max_length=20, verbose_name='值类型')),
                ('description', models.CharField(blank=True, max_length=255, null=True, verbose_name='描述')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
            ],
            options={
                'verbose_name': '系统设置',
                'verbose_name_plural': '系统设置',
                'ordering': ['key'],
            },
        ),
    ]


================================================================================
文件路径: backend\settings\migrations\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\settings\migrations\__init__.py
================================================================================



================================================================================
文件路径: backend\users\apps.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\apps.py
================================================================================

"""
用户应用配置
"""
from django.apps import AppConfig

class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'
    verbose_name = '用户管理'
    
    def ready(self):
        import users.signals


================================================================================
文件路径: backend\users\models.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\models.py
================================================================================

"""
用户模型定义
"""
from django.db import models
from django.contrib.auth.models import AbstractUser
from django.utils.translation import gettext_lazy as _

class User(AbstractUser):
    """
    自定义用户模型
    """
    email = models.EmailField(_('邮箱地址'), unique=True)
    phone = models.CharField(_('手机号码'), max_length=15, blank=True, null=True)
    avatar = models.ImageField(_('头像'), upload_to='avatars/', blank=True, null=True)
    bio = models.TextField(_('个人简介'), blank=True, null=True)
    
    # 管理员相关字段
    is_admin = models.BooleanField(_('管理员'), default=False)
    admin_role = models.CharField(_('管理员角色'), max_length=20, choices=[
        ('super', _('超级管理员')),
        ('content', _('内容管理员')),
        ('user', _('用户管理员'))
    ], blank=True, null=True)
    
    # 用于记录检测历史统计
    total_detections = models.PositiveIntegerField(_('检测总次数'), default=0)
    fake_detections = models.PositiveIntegerField(_('虚假新闻检测次数'), default=0)
    real_detections = models.PositiveIntegerField(_('真实新闻检测次数'), default=0)
    
    created_at = models.DateTimeField(_('创建时间'), auto_now_add=True)
    updated_at = models.DateTimeField(_('更新时间'), auto_now=True)
    
    class Meta:
        verbose_name = _('用户')
        verbose_name_plural = _('用户')
        ordering = ['-date_joined']
    
    def __str__(self):
        return self.username
    
    def get_full_name(self):
        """
        返回用户全名
        """
        full_name = f"{self.first_name} {self.last_name}"
        return full_name.strip() or self.username
    
    def update_detection_stats(self, is_fake):
        """
        更新用户的检测统计
        """
        self.total_detections += 1
        if is_fake:
            self.fake_detections += 1
        else:
            self.real_detections += 1
        self.save(update_fields=['total_detections', 'fake_detections', 'real_detections'])


================================================================================
文件路径: backend\users\serializers.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\serializers.py
================================================================================

"""
用户序列化器
"""
from rest_framework import serializers
from django.contrib.auth import get_user_model
from django.contrib.auth.password_validation import validate_password

User = get_user_model()

class UserSerializer(serializers.ModelSerializer):
    """
    用户基本信息序列化器
    """
    class Meta:
        model = User
        fields = ['id', 'username', 'email', 'first_name', 'last_name', 'phone', 
                'avatar', 'bio', 'total_detections', 'fake_detections', 
                'real_detections', 'date_joined', 'is_active', 'is_staff', 'is_superuser']
        read_only_fields = ['id', 'total_detections', 'fake_detections', 
                        'real_detections', 'date_joined', 'is_active', 'is_staff', 'is_superuser']

class UserRegistrationSerializer(serializers.ModelSerializer):
    """
    用户注册序列化器
    """
    password = serializers.CharField(write_only=True, required=True, validators=[validate_password])
    password2 = serializers.CharField(write_only=True, required=True)

    class Meta:
        model = User
        fields = ['username', 'email', 'password', 'password2', 'first_name', 'last_name']
        extra_kwargs = {
            'first_name': {'required': True},
            'last_name': {'required': True},
            'email': {'required': True}
        }

    def validate(self, attrs):
        if attrs['password'] != attrs['password2']:
            raise serializers.ValidationError({"password": "两次输入的密码不一致"})
        return attrs

    def create(self, validated_data):
        validated_data.pop('password2')
        user = User.objects.create_user(**validated_data)
        return user

class UserDetailSerializer(serializers.ModelSerializer):
    """
    用户详细信息序列化器
    """
    class Meta:
        model = User
        fields = ['id', 'username', 'email', 'first_name', 'last_name', 'phone', 
                'avatar', 'bio', 'total_detections', 'fake_detections', 
                'real_detections', 'date_joined', 'is_active', 'is_staff', 'is_superuser']
        read_only_fields = ['id', 'username', 'total_detections', 
                        'fake_detections', 'real_detections', 'date_joined', 'is_superuser']

class PasswordChangeSerializer(serializers.Serializer):
    """
    密码修改序列化器
    """
    old_password = serializers.CharField(required=True)
    new_password = serializers.CharField(required=True, validators=[validate_password])
    new_password2 = serializers.CharField(required=True)

    def validate(self, attrs):
        if attrs['new_password'] != attrs['new_password2']:
            raise serializers.ValidationError({"new_password": "两次输入的新密码不一致"})
        return attrs


================================================================================
文件路径: backend\users\signals.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\signals.py
================================================================================

"""
用户信号处理
"""
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth import get_user_model

User = get_user_model()

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """
    用户创建后的处理
    """
    if created:
        # 可以在这里添加自定义的用户创建后操作
        pass


================================================================================
文件路径: backend\users\urls.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\urls.py
================================================================================

"""
用户应用URL配置
"""
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from rest_framework_simplejwt.views import (
    TokenObtainPairView, TokenRefreshView, TokenVerifyView
)
from .views import UserViewSet

router = DefaultRouter()
router.register(r'', UserViewSet)

urlpatterns = [
    # JWT认证
    path('token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('token/verify/', TokenVerifyView.as_view(), name='token_verify'),
    
    # 用户API
    path('', include(router.urls)),
]


================================================================================
文件路径: backend\users\views.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\views.py
================================================================================

"""
用户视图
"""
from rest_framework import viewsets, status, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.contrib.auth import get_user_model
# 导入 django-filter backend
from django_filters.rest_framework import DjangoFilterBackend 
from .serializers import (
    UserSerializer, UserRegistrationSerializer, 
    UserDetailSerializer, PasswordChangeSerializer
)

User = get_user_model()

class IsOwnerOrReadOnly(permissions.BasePermission):
    """
    对象级权限，只允许对象的所有者编辑，但管理员可以编辑任何对象。
    """
    def has_object_permission(self, request, view, obj):
        # 读取权限允许任何请求
        if request.method in permissions.SAFE_METHODS:
            return True
        
        # 管理员具有所有写入权限
        if request.user and request.user.is_staff:
            return True
            
        # 写入权限只允许对象的所有者
        return obj == request.user

class UserViewSet(viewsets.ModelViewSet):
    """
    用户视图集，处理用户相关操作
    """
    queryset = User.objects.all().order_by('-date_joined') # 默认按加入时间降序
    serializer_class = UserSerializer
    permission_classes = [permissions.IsAuthenticated, IsOwnerOrReadOnly]
    # 添加过滤后端和过滤字段
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['username', 'email', 'is_active'] # 允许按这些字段过滤
    
    def get_serializer_class(self):
        """
        根据不同操作返回不同的序列化器
        """
        if self.action == 'create':
            return UserRegistrationSerializer
        elif self.action in ['retrieve', 'update', 'partial_update']:
            return UserDetailSerializer
        elif self.action == 'change_password':
            return PasswordChangeSerializer
        return UserSerializer
    
    def get_permissions(self):
        """
        根据不同操作设置不同的权限
        """
        if self.action == 'create':
            return [permissions.AllowAny()]
        return super().get_permissions()
    
    def create(self, request, *args, **kwargs):
        """
        用户注册
        """
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        self.perform_create(serializer)
        headers = self.get_success_headers(serializer.data)
        return Response(
            {"message": "用户注册成功", "user": serializer.data},
            status=status.HTTP_201_CREATED, 
            headers=headers
        )
    
    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def change_password(self, request, pk=None):
        """
        修改密码
        """
        user = self.get_object()
        if user != request.user:
            return Response(
                {"detail": "您没有权限修改此用户的密码"},
                status=status.HTTP_403_FORBIDDEN
            )
        
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        # 检查旧密码
        if not user.check_password(serializer.validated_data['old_password']):
            return Response(
                {"old_password": ["旧密码不正确"]},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # 设置新密码
        user.set_password(serializer.validated_data['new_password'])
        user.save()
        
        return Response({"message": "密码修改成功"})
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def me(self, request):
        """
        获取当前用户信息
        """
        serializer = UserDetailSerializer(request.user)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def stats(self, request):
        """
        获取用户统计信息（仅管理员可用）
        """
        if not request.user.is_staff:
            return Response(
                {"detail": "您没有权限访问此资源"},
                status=status.HTTP_403_FORBIDDEN
            )
        
        total_users = User.objects.count()
        active_users = User.objects.filter(is_active=True).count()
        
        return Response({
            "total_users": total_users,
            "active_users": active_users,
        })


================================================================================
文件路径: backend\users\migrations\0001_initial.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\migrations\0001_initial.py
================================================================================

# Generated by Django 4.2.9 on 2025-04-14 09:07

import django.contrib.auth.models
import django.contrib.auth.validators
from django.db import migrations, models
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
                ('first_name', models.CharField(blank=True, max_length=150, verbose_name='first name')),
                ('last_name', models.CharField(blank=True, max_length=150, verbose_name='last name')),
                ('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
                ('is_active', models.BooleanField(default=True, help_text='Designates whether this user should be treated as active. Unselect this instead of deleting accounts.', verbose_name='active')),
                ('date_joined', models.DateTimeField(default=django.utils.timezone.now, verbose_name='date joined')),
                ('email', models.EmailField(max_length=254, unique=True, verbose_name='邮箱地址')),
                ('phone', models.CharField(blank=True, max_length=15, null=True, verbose_name='手机号码')),
                ('avatar', models.ImageField(blank=True, null=True, upload_to='avatars/', verbose_name='头像')),
                ('bio', models.TextField(blank=True, null=True, verbose_name='个人简介')),
                ('total_detections', models.PositiveIntegerField(default=0, verbose_name='检测总次数')),
                ('fake_detections', models.PositiveIntegerField(default=0, verbose_name='虚假新闻检测次数')),
                ('real_detections', models.PositiveIntegerField(default=0, verbose_name='真实新闻检测次数')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'verbose_name': '用户',
                'verbose_name_plural': '用户',
                'ordering': ['-date_joined'],
            },
            managers=[
                ('objects', django.contrib.auth.models.UserManager()),
            ],
        ),
    ]


================================================================================
文件路径: backend\users\migrations\0001_user_admin_role_user_is_admin.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\migrations\0001_user_admin_role_user_is_admin.py
================================================================================

# Generated by Django 4.2.9 on 2025-04-19 10:27

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', 'create_admin_user'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='admin_role',
            field=models.CharField(blank=True, choices=[('super', '超级管理员'), ('content', '内容管理员'), ('user', '用户管理员')], max_length=20, null=True, verbose_name='管理员角色'),
        ),
        migrations.AddField(
            model_name='user',
            name='is_admin',
            field=models.BooleanField(default=False, verbose_name='管理员'),
        ),
    ]


================================================================================
文件路径: backend\users\migrations\create_admin_user.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\migrations\create_admin_user.py
================================================================================

from django.db import migrations
from django.contrib.auth.hashers import make_password

def create_initial_admin(apps, schema_editor):
    """
    创建初始管理员用户
    用户名: admin
    密码: admin
    """
    User = apps.get_model('users', 'User')
    
    # 检查admin用户是否已存在
    if not User.objects.filter(username='admin').exists():
        admin_user = User(
            username='admin',
            email='admin@example.com',
            password=make_password('admin123456'),  # 设置密码为admin123456
            is_superuser=True,
            is_staff=True,
            is_active=True,
            is_admin=True,
            admin_role='super'
        )
        admin_user.save()
        print("已创建超级管理员账号admin")


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0001_initial'),  # 确保这个依赖正确指向你的上一个迁移
    ]

    operations = [
        migrations.RunPython(create_initial_admin),
    ] 

================================================================================
文件路径: backend\users\migrations\__init__.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\backend\users\migrations\__init__.py
================================================================================

# 初始化migrations包 

================================================================================
文件路径: frontend\.eslintrc.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\.eslintrc.js
================================================================================

module.exports = {
  root: true,
  env: {
    node: true
  },
  extends: [
    'plugin:vue/essential',
    'eslint:recommended'
  ],
  parserOptions: {
    parser: '@babel/eslint-parser',
    requireConfigFile: false
  },
  rules: {
    'no-console': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'no-debugger': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'vue/no-parsing-error': [2, { 'x-invalid-end-tag': false }]
  }
} 

================================================================================
文件路径: frontend\babel.config.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\babel.config.js
================================================================================

module.exports = {
  presets: [
    '@vue/cli-plugin-babel/preset'
  ]
} 

================================================================================
文件路径: frontend\vue.config.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\vue.config.js
================================================================================

module.exports = {
  publicPath: process.env.NODE_ENV === 'production' ? '/' : '/',
  outputDir: 'dist',
  assetsDir: 'static',
  lintOnSave: process.env.NODE_ENV === 'development',
  productionSourceMap: false,
  devServer: {
    port: 8080,
    open: true,
    client: {
      overlay: {
        warnings: false,
        errors: true
      }
    },
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        pathRewrite: {
          '^/api': '/api'
        }
      }
    }
  },
  css: {
    loaderOptions: {
      sass: {
        // 这里使用的是sass的新API，与node-sass不同
        // 注意：sass-loader v8+需要这样写，v7-使用data
        additionalData: `@import "@/assets/css/variables.scss";`
      }
    }
  }
} 

================================================================================
文件路径: frontend\src\App.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\App.vue
================================================================================

<template>
  <div id="app">
    <router-view />
  </div>
</template>

<script>
export default {
  name: 'App'
}
</script>

<style>
@import '@/assets/css/global.css';

#app {
  font-family: 'Poppins', 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  height: 100%;
  width: 100%;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

/* 全局滚动条样式 */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* 全局过渡效果 */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s;
}
.fade-enter,
.fade-leave-to {
  opacity: 0;
}

.slide-fade-enter-active {
  transition: all 0.3s ease-out;
}
.slide-fade-leave-active {
  transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1);
}
.slide-fade-enter-from,
.slide-fade-leave-to {
  transform: translateX(20px);
  opacity: 0;
}
</style>


================================================================================
文件路径: frontend\src\main.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\main.js
================================================================================

import Vue from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'
import ElementUI from 'element-ui'
import 'element-ui/lib/theme-chalk/index.css'
import './assets/css/global.css'
import axios from 'axios'

// 提供默认logo
import DefaultLogo from './assets/logo.svg'
Vue.prototype.$defaultLogo = DefaultLogo

// 配置ElementUI
Vue.use(ElementUI, { size: 'medium' })

// 配置axios
axios.defaults.baseURL = process.env.VUE_APP_API_URL || 'http://localhost:8000/api'
// 请求拦截器，添加token到请求头
axios.interceptors.request.use(config => {
  const token = store.getters.token
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
}, error => {
  return Promise.reject(error)
})

// 响应拦截器，处理token过期等问题
axios.interceptors.response.use(response => {
  return response
}, error => {
  if (error.response && error.response.status === 401) {
    // token过期，清除用户信息并跳转到登录页
    store.dispatch('user/logout')
    router.push('/login')
  }
  return Promise.reject(error)
})

Vue.prototype.$http = axios
Vue.config.productionTip = false

new Vue({
  router,
  store,
  render: h => h(App)
}).$mount('#app')


================================================================================
文件路径: frontend\src\api\auth.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\api\auth.js
================================================================================




================================================================================
文件路径: frontend\src\api\detection.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\api\detection.js
================================================================================

import axios from 'axios'

// 获取检测历史
export function getDetectionHistory() {
  return axios.get('/detection/detections/my_detections/')
}

// 获取检测详情
export function getDetectionDetail(id) {
  return axios.get(`/detection/detections/${id}/`)
}

// 创建新检测
export function createDetection(data) {
  const formData = new FormData()
  formData.append('title', data.title)
  formData.append('content', data.content)
  
  if (data.image) {
    formData.append('image', data.image)
  }
  
  return axios.post('/detection/detections/', formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}

// 获取检测结果
export function getDetectionResult(id) {
  return axios.get(`/detection/detections/${id}/result/`)
}

// 获取检测统计信息
export function getDetectionStats(isAdmin = false) {
  const url = isAdmin ? '/detection/detections/get_stats/?all=true' : '/detection/detections/get_stats/'
  return axios.get(url)
}

// 删除检测记录
export function deleteDetection(id) {
  return axios.delete(`/detection/detections/${id}/`, {
    headers: {
      'X-CSRFToken': document.cookie.replace(/(?:(?:^|.*;\s*)csrftoken\s*=\s*([^;]*).*$)|^.*$/, '$1')
    }
  })
}


================================================================================
文件路径: frontend\src\api\index.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\api\index.js
================================================================================




================================================================================
文件路径: frontend\src\api\news.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\api\news.js
================================================================================




================================================================================
文件路径: frontend\src\api\user.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\api\user.js
================================================================================

import axios from 'axios'

// 登录
export function login(data) {
  return axios.post('/users/token/', data)
}

// 获取用户信息
export function getUserInfo() {
  return axios.get('/users/me/')
}

// 注册
export function register(data) {
  return axios.post('/users/', data)
}

// 修改用户信息
export function updateUserInfo(id, data) {
  return axios.patch(`/users/${id}/`, data)
}

// 修改密码
export function changePassword(id, data) {
  return axios.post(`/users/${id}/change_password/`, data)
}

// 获取用户统计
export function getUserStats() {
  return axios.get('/users/stats/')
}


================================================================================
文件路径: frontend\src\assets\css\global.css
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\assets\css\global.css
================================================================================

/* 全局样式 */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

:root {
  --primary: #4361ee;
  --success: #4cc9f0;
  --warning: #f72585;
  --danger: #f15bb5;
  --info: #4895ef;
  --dark: #2b2d42;
  --light: #f8f9fa;
  --gray: #6c757d;
  --border-radius: 8px;
  --transition: all 0.3s ease;
  --box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.08);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: var(--dark);
  background-color: var(--light);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  padding: 24px;
  max-width: 1200px;
  margin: 0 auto;
}

.page-title {
  margin-bottom: 24px;
  font-size: 24px;
  font-weight: 600;
  color: var(--dark);
}

.card-container {
  background: #fff;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  padding: 24px;
  margin-bottom: 24px;
  transition: var(--transition);
}

.card-container:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

/* 按钮样式 */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
  border-radius: var(--border-radius);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  border: none;
  outline: none;
}

.btn-primary {
  background-color: var(--primary);
  color: white;
}

.btn-primary:hover {
  background-color: #3a56d4;
}

/* 新增现代按钮样式 */
.btn-gradient {
  background: linear-gradient(90deg, var(--primary), var(--info));
  color: white;
  border: none;
}

.btn-gradient:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4);
}

.btn-outline {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary);
}

.btn-outline:hover {
  background-color: var(--primary);
  color: white;
}

.btn-rounded {
  border-radius: 50px;
}

.btn-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-icon i {
  margin-right: 8px;
}

.btn-icon-only {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50%;
}

.btn-floating {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99;
}

.btn-floating:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

.btn-lg {
  padding: 12px 24px;
  font-size: 16px;
}

/* 颜色工具类 */
.text-primary {
  color: var(--primary);
}

.text-success {
  color: var(--success);
}

.text-warning {
  color: var(--warning);
}

.text-danger {
  color: var(--danger);
}

.text-info {
  color: var(--info);
}

.text-center {
  text-align: center;
}

.flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Margin utilities */
.m-0 { margin: 0; }
.mt-10 { margin-top: 10px; }
.mt-20 { margin-top: 20px; }
.mt-30 { margin-top: 30px; }
.mb-10 { margin-bottom: 10px; }
.mb-20 { margin-bottom: 20px; }
.mb-30 { margin-bottom: 30px; }
.ml-10 { margin-left: 10px; }
.mr-10 { margin-right: 10px; }

/* Padding utilities */
.p-0 { padding: 0; }
.p-10 { padding: 10px; }
.p-20 { padding: 20px; }
.pt-10 { padding-top: 10px; }
.pb-10 { padding-bottom: 10px; }
.pl-10 { padding-left: 10px; }
.pr-10 { padding-right: 10px; }

/* Animation utilities */
.fade-enter-active, .fade-leave-active {
  transition: opacity 0.3s;
}
.fade-enter, .fade-leave-to {
  opacity: 0;
}

/* Form styles */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #dee2e6;
  border-radius: var(--border-radius);
  transition: var(--transition);
}

.form-control:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
  outline: none;
} 

================================================================================
文件路径: frontend\src\router\index.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\router\index.js
================================================================================

import Vue from 'vue'
import VueRouter from 'vue-router'
import store from '@/store'

Vue.use(VueRouter)

// 路由懒加载
const Home = () => import('@/views/Home.vue')
const Login = () => import('@/views/Login.vue')
const Register = () => import('@/views/Register.vue')
const Layout = () => import('@/views/layout/Layout.vue')
const Dashboard = () => import('@/views/dashboard/Dashboard.vue')
const DetectionCreate = () => import('@/views/detection/Create.vue')
const DetectionHistory = () => import('@/views/detection/History.vue')
const DetectionDetail = () => import('@/views/detection/Detail.vue')
const Profile = () => import('@/views/user/Profile.vue')
const NotFound = () => import('@/views/NotFound.vue')

// 管理员相关组件
const AdminLayout = () => import('@/views/admin/AdminLayout.vue')
const AdminDashboard = () => import('@/views/admin/Dashboard.vue')
const AdminUsers = () => import('@/views/admin/Users.vue')
const AdminSettings = () => import('@/views/admin/Settings.vue')
const DetectionStatistics = () => import('@/views/admin/DetectionStatistics.vue')
// 系统日志页面 - 懒加载
const SystemLogs = () => import('@/views/admin/SystemLogs.vue')

const routes = [
  {
    path: '/',
    name: 'Home',
    component: Home,
    meta: { title: '首页', noAuth: true }
  },
  {
    path: '/login',
    name: 'Login',
    component: Login,
    meta: { title: '登录', noAuth: true }
  },
  {
    path: '/register',
    name: 'Register',
    component: Register,
    meta: { title: '注册', noAuth: true }
  },
  {
    path: '/dashboard',
    component: Layout,
    redirect: '/dashboard/index',
    children: [
      {
        path: 'index',
        name: 'Dashboard',
        component: Dashboard,
        meta: { title: '仪表盘', icon: 'el-icon-data-analysis' }
      },
      {
        path: 'detection/create',
        name: 'DetectionCreate',
        component: DetectionCreate,
        meta: { title: '新闻检测', icon: 'el-icon-search' }
      },
      {
        path: 'detection/history',
        name: 'DetectionHistory',
        component: DetectionHistory,
        meta: { title: '检测历史', icon: 'el-icon-time' }
      },
      {
        path: 'detection/detail/:id',
        name: 'DetectionDetail',
        component: DetectionDetail,
        meta: { title: '检测详情', hideInMenu: true }
      },
      {
        path: 'profile',
        name: 'Profile',
        component: Profile,
        meta: { title: '个人中心', icon: 'el-icon-user' }
      }
    ]
  },
  // 添加管理员路由
  {
    path: '/admin',
    component: AdminLayout,
    redirect: '/admin/dashboard',
    meta: { requiresAdmin: true },
    children: [
      {
        path: 'dashboard',
        name: 'AdminDashboard',
        component: AdminDashboard,
        meta: { title: '控制面板' }
      },
      {
        path: 'users',
        name: 'AdminUsers',
        component: AdminUsers,
        meta: { title: '用户列表' }
      },
      {
        path: 'settings',
        name: 'AdminSettings',
        component: AdminSettings,
        meta: { title: '系统设置' }
      },
      {
        path: 'detection/list',
        name: 'AdminDetectionList',
        component: DetectionHistory,
        meta: { title: '检测列表' }
      },
      {
        path: 'detection/detail/:id',
        name: 'AdminDetectionDetail',
        component: DetectionDetail,
        meta: { title: '检测详情', hideInMenu: true }
      },
      {
        path: 'detection-stats',
        name: 'AdminDetectionStats',
        component: DetectionStatistics,
        meta: { title: '检测统计' }
      },
      {
        path: 'logs',
        name: 'AdminLogs',
        component: SystemLogs,
        meta: { title: '系统日志' }
      }
    ]
  },
  {
    path: '/404',
    name: 'NotFound',
    component: NotFound,
    meta: { title: '页面不存在', noAuth: true, hideInMenu: true }
  },
  // 重定向到404
  { path: '*', redirect: '/404' }
]

const router = new VueRouter({
  mode: 'history',
  base: process.env.BASE_URL,
  routes,
  // 页面切换时滚动到顶部
  scrollBehavior() {
    return { x: 0, y: 0 }
  }
})

// 避免重复导航错误
const originalPush = VueRouter.prototype.push
VueRouter.prototype.push = function push(location) {
  return originalPush.call(this, location).catch(err => {
    if (err.name !== 'NavigationDuplicated') throw err
  })
}

// 全局前置守卫
router.beforeEach((to, from, next) => {
  // 设置页面标题
  document.title = to.meta.title ? `${to.meta.title} - 虚假新闻检测系统` : '虚假新闻检测系统'
  
  // 获取token状态
  const token = store.getters.token
  const isAdmin = store.getters.isAdmin
  
  // 首页特殊处理：已登录用户访问首页时自动跳转到仪表盘
  if (to.path === '/' && token) {
    next({ path: '/dashboard/index' })
    return
  }
  
  // 管理员页面检查
  if (to.matched.some(record => record.meta.requiresAdmin)) {
    if (!token) {
      next({ path: '/login', query: { redirect: to.fullPath } })
      return
    }
    
    if (!isAdmin) {
      next({ path: '/404' })
      return
    }
    
    // 管理员有权限访问，正常通过
    next()
    return
  }
  
  // 不需要登录的页面
  if (to.meta.noAuth) {
    next()
    return
  }
  
  // 判断是否已登录
  if (!token) {
    next({ path: '/login', query: { redirect: to.fullPath } })
    return
  }
  
  next()
})

export default router


================================================================================
文件路径: frontend\src\store\getters.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\store\getters.js
================================================================================

const getters = {
  // 用户信息
  token: state => state.user.token,
  user: state => state.user.user,
  roles: state => state.user.roles,
  isAdmin: state => state.user.user ? state.user.user.is_staff : false,
  currentUser: state => state.user.user,
  
  // 检测相关
  detectionHistory: state => state.detection.detectionHistory,
  detectionStats: state => state.detection.stats,
  detections: state => state.detection.list,
  detectionCount: state => state.detection.count,
  currentDetection: state => state.detection.currentDetection
}

export default getters 

================================================================================
文件路径: frontend\src\store\index.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\store\index.js
================================================================================

import Vue from 'vue'
import Vuex from 'vuex'
import user from './modules/user'
import detection from './modules/detection'
import getters from './getters'

Vue.use(Vuex)

const store = new Vuex.Store({
  modules: {
    user,
    detection
  },
  getters
})

export default store


================================================================================
文件路径: frontend\src\store\modules\auth.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\store\modules\auth.js
================================================================================




================================================================================
文件路径: frontend\src\store\modules\detection.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\store\modules\detection.js
================================================================================

import axios from 'axios'

const state = {
  detectionHistory: [],
  currentDetection: null,
  stats: {
    total_count: 0,
    fake_count: 0,
    real_count: 0,
    pending_count: 0,
    completed_count: 0,
    failed_count: 0,
    fake_percentage: 0,
    real_percentage: 0,
    average_confidence: 0
  }
}

const mutations = {
  SET_DETECTION_HISTORY: (state, history) => {
    state.detectionHistory = history
  },
  SET_CURRENT_DETECTION: (state, detection) => {
    state.currentDetection = detection
  },
  ADD_DETECTION: (state, detection) => {
    state.detectionHistory.unshift(detection)
  },
  SET_STATS: (state, stats) => {
    state.stats = stats
  }
}

const actions = {
  // 获取检测历史
  getDetectionHistory({ commit }) {
    return new Promise((resolve, reject) => {
      axios.get('/detection/detections/my_detections/')
        .then(response => {
          const history = response.data.results || response.data
          commit('SET_DETECTION_HISTORY', history)
          resolve(history)
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 获取检测详情
  getDetectionDetail({ commit }, id) {
    console.log(`Fetching detection detail for ID: ${id}`);
    if (!id || id === 'undefined') {
      console.error('Attempted to fetch detail with invalid ID:', id);
      return Promise.reject(new Error('Invalid ID for detection detail'));
    }
    return new Promise((resolve, reject) => {
      axios.get(`/detection/detections/${id}/`)
        .then(response => {
          console.log('Backend response from getDetectionDetail:', response.data);
          commit('SET_CURRENT_DETECTION', response.data)
          resolve(response.data)
        })
        .catch(error => {
          console.error(`getDetectionDetail API call failed for ID ${id}:`, error.response || error);
          reject(error)
        })
    })
  },

  // 创建新检测
  createDetection({ commit }, detectionData) {
    return new Promise((resolve, reject) => {
      const formData = new FormData()
      formData.append('title', detectionData.title)
      formData.append('content', detectionData.content)
      if (detectionData.image) {
        formData.append('image', detectionData.image)
      }
      
      axios.post('/detection/detections/', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
        .then(response => {
          console.log('Backend response from createDetection:', response.data);
          commit('ADD_DETECTION', response.data)
          commit('SET_CURRENT_DETECTION', response.data)
          resolve(response.data)
        })
        .catch(error => {
          console.error('createDetection API call failed:', error.response || error);
          reject(error)
        })
    })
  },

  // 获取检测结果
  getDetectionResult({ commit }, id) {
    return new Promise((resolve, reject) => {
      axios.get(`/detection/detections/${id}/result/`)
        .then(response => {
          commit('SET_CURRENT_DETECTION', response.data)
          resolve(response.data)
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 获取检测统计信息
  getDetectionStats({ commit }, isAdmin = false) {
    return new Promise((resolve, reject) => {
      const url = `/detection/detections/get_stats/${isAdmin ? '?all=true' : ''}`
      axios.get(url)
        .then(response => {
          commit('SET_STATS', response.data)
          resolve(response.data)
        })
        .catch(error => {
          reject(error)
        })
    })
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}


================================================================================
文件路径: frontend\src\store\modules\news.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\store\modules\news.js
================================================================================




================================================================================
文件路径: frontend\src\store\modules\user.js
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\store\modules\user.js
================================================================================

import axios from 'axios'
import router from '@/router'
import Cookies from 'js-cookie'

const TOKEN_KEY = 'mm_dfd_token'
const USER_KEY = 'mm_dfd_user'

const state = {
  token: Cookies.get(TOKEN_KEY),
  user: JSON.parse(localStorage.getItem(USER_KEY) || '{}'),
  roles: []
}

const mutations = {
  SET_TOKEN: (state, token) => {
    state.token = token
  },
  SET_USER: (state, user) => {
    state.user = user
  },
  SET_ROLES: (state, roles) => {
    state.roles = roles
  }
}

const actions = {
  // 用户登录
  login({ commit }, userInfo) {
    const { username, password } = userInfo
    return new Promise((resolve, reject) => {
      axios.post('/users/token/', { username, password })
        .then(response => {
          const { access } = response.data
          commit('SET_TOKEN', access)
          Cookies.set(TOKEN_KEY, access, { expires: 7 }) // 保存7天
          resolve()
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 获取用户信息
  getUserInfo({ commit }) {
    return new Promise((resolve, reject) => {
      axios.get('/users/me/')
        .then(response => {
          const user = response.data
          commit('SET_USER', user)
          localStorage.setItem(USER_KEY, JSON.stringify(user))
          
          // 设置用户角色
          const roles = ['user']
          if (user.is_staff) {
            roles.push('admin')
          }
          commit('SET_ROLES', roles)
          resolve(user)
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 用户注册
  register({}, userInfo) {
    return new Promise((resolve, reject) => {
      axios.post('/users/', userInfo)
        .then(response => {
          resolve(response.data)
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 更新用户信息
  updateUserInfo({ commit, state }, userInfo) {
    return new Promise((resolve, reject) => {
      axios.patch(`/users/${state.user.id}/`, userInfo)
        .then(response => {
          const updatedUser = { ...state.user, ...response.data }
          commit('SET_USER', updatedUser)
          localStorage.setItem(USER_KEY, JSON.stringify(updatedUser))
          resolve(updatedUser)
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 修改密码
  changePassword({ state }, passwordInfo) {
    return new Promise((resolve, reject) => {
      axios.post(`/users/${state.user.id}/change_password/`, passwordInfo)
        .then(response => {
          resolve(response.data)
        })
        .catch(error => {
          reject(error)
        })
    })
  },

  // 用户登出
  logout({ commit }) {
    commit('SET_TOKEN', '')
    commit('SET_USER', {})
    commit('SET_ROLES', [])
    Cookies.remove(TOKEN_KEY)
    localStorage.removeItem(USER_KEY)
    router.push('/login')
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}


================================================================================
文件路径: frontend\src\views\Home.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\Home.vue
================================================================================

<template>
  <div class="home-container">
    <!-- 导航栏 -->
    <header class="navbar">
      <div class="container navbar-container">
        <div class="logo-section">
          <el-image :src="logoSrc" alt="Logo" class="logo"></el-image>
          <h1 class="brand-name">MM-DFD</h1>
        </div>
        <div class="nav-links">
          <a href="#hero" class="nav-link">首页</a>
          <a href="#features" class="nav-link">功能</a>
          <a href="#about" class="nav-link">关于我们</a>
          <a href="#contact" class="nav-link">联系我们</a>
        </div>
        <div class="auth-buttons">
          <el-button type="text" class="login-btn" @click="goToLogin">登录</el-button>
          <el-button type="primary" class="register-btn btn-gradient btn-rounded" @click="goToRegister">免费注册</el-button>
        </div>
      </div>
    </header>

    <!-- 英雄区 -->
    <section id="hero" class="hero-section">
      <div class="container hero-container">
        <div class="hero-content">
          <h1 class="hero-title">多模态深度学习社交媒体虚假新闻检测系统</h1>
          <p class="hero-description">
            基于先进的深度学习技术，结合文本、图像等多模态数据，精准识别社交媒体上的虚假新闻，提供专业的真伪鉴别服务
          </p>
          <div class="hero-buttons">
            <el-button type="primary" class="btn-gradient btn-rounded btn-lg" @click="goToRegister">
              <i class="el-icon-s-promotion"></i> 开始免费体验
            </el-button>
            <el-button class="btn-outline btn-rounded btn-lg" @click="scrollToFeatures">
              <i class="el-icon-view"></i> 了解更多
            </el-button>
          </div>
        </div>
        <div class="hero-image">
          <div class="image-placeholder">
            <div class="detection-illustration"></div>
          </div>
        </div>
      </div>
      <div class="hero-background">
        <div class="bg-blob blob-1"></div>
        <div class="bg-blob blob-2"></div>
        <div class="bg-blob blob-3"></div>
      </div>
    </section>

    <!-- 统计数据 -->
    <section class="stats-section">
      <div class="container stats-container">
        <div class="stat-item">
          <div class="stat-number">90.3%</div>
          <div class="stat-label">检测准确率</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">200+</div>
          <div class="stat-label">每日检测次数</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">100+</div>
          <div class="stat-label">注册用户</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">24/7</div>
          <div class="stat-label">全天候服务</div>
        </div>
      </div>
    </section>

    <!-- 功能特点 -->
    <section id="features" class="features-section">
      <div class="container">
        <h2 class="section-title">强大功能<span class="highlight">特性</span></h2>
        <p class="section-subtitle">我们的系统采用最先进的技术，为您提供全方位的虚假新闻检测服务</p>
        
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">
              <i class="el-icon-picture"></i>
            </div>
            <h3 class="feature-title">多模态分析</h3>
            <p class="feature-description">
              同时分析文本、图像等多种信息，全方位评估新闻内容的真实性，提高检测准确率
            </p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">
              <i class="el-icon-cpu"></i>
            </div>
            <h3 class="feature-title">深度学习技术</h3>
            <p class="feature-description">
              采用前沿的深度学习算法，不断学习和适应新的虚假信息传播模式和技术
            </p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">
              <i class="el-icon-lightning"></i>
            </div>
            <h3 class="feature-title">实时检测</h3>
            <p class="feature-description">
              快速响应，在几秒钟内完成新闻检测，及时辨别虚假信息，防止其传播
            </p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">
              <i class="el-icon-data-line"></i>
            </div>
            <h3 class="feature-title">详细分析报告</h3>
            <p class="feature-description">
              提供全面的分析报告，包括可信度评分、可疑内容标记和详细分析解释
            </p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">
              <i class="el-icon-refresh"></i>
            </div>
            <h3 class="feature-title">持续更新</h3>
            <p class="feature-description">
              系统不断学习新的虚假信息模式，更新检测算法，确保始终保持高准确率
            </p>
          </div>
          
          <div class="feature-card">
            <div class="feature-icon">
              <i class="el-icon-lock"></i>
            </div>
            <h3 class="feature-title">隐私保护</h3>
            <p class="feature-description">
              严格保护用户数据和检测内容的隐私，确保信息安全不被泄露或滥用
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- 关于我们 -->
    <section id="about" class="about-section">
      <div class="container">
        <div class="about-content">
          <div class="about-text">
            <h2 class="section-title">关于<span class="highlight">我们</span></h2>
            <p class="about-description">
              MM-DFD (多模态深度学习虚假新闻检测系统) 是一个专注于识别和防范虚假新闻传播的先进平台。我们的团队由人工智能专家、数据科学家和媒体研究人员组成，致力于创建更可信的信息环境。
            </p>
            <p class="about-description">
              在当今信息爆炸的时代，虚假新闻的快速传播对社会造成了严重影响。我们的使命是通过技术手段帮助用户快速识别虚假信息，提高社会媒体素养，促进健康信息生态系统的形成。
            </p>
            <p class="about-description">
              我们的系统不断学习和进化，适应新的虚假信息传播技术和模式，为用户提供最准确、最及时的检测服务。
            </p>
          </div>
          <div class="about-image">
            <div class="image-placeholder">
              <div class="about-illustration"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 如何使用 -->
    <section class="how-section">
      <div class="container">
        <h2 class="section-title">如何<span class="highlight">使用</span></h2>
        <p class="section-subtitle">简单几步，即可开始使用我们的虚假新闻检测服务</p>
        
        <div class="steps-container">
          <div class="step-item">
            <div class="step-number">1</div>
            <div class="step-content">
              <h3 class="step-title">注册账号</h3>
              <p class="step-description">
                简单注册，创建您的个人账号，即可访问完整功能
              </p>
            </div>
          </div>
          
          <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-content">
              <h3 class="step-title">提交内容</h3>
              <p class="step-description">
                上传需要检测的新闻内容，包括文本、图片等多媒体资料
              </p>
            </div>
          </div>
          
          <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-content">
              <h3 class="step-title">获取结果</h3>
              <p class="step-description">
                系统快速分析并生成详细的检测报告，帮助您判断真伪
              </p>
            </div>
          </div>
          
          <div class="step-item">
            <div class="step-number">4</div>
            <div class="step-content">
              <h3 class="step-title">查看历史</h3>
              <p class="step-description">
                随时查看您的检测历史记录，便于追踪和管理
              </p>
            </div>
          </div>
        </div>
        
        <div class="cta-container">
          <el-button type="primary" class="btn-gradient btn-rounded btn-lg" @click="goToRegister">
            立即开始使用
          </el-button>
        </div>
      </div>
    </section>

    <!-- 联系我们 -->
    <section id="contact" class="contact-section">
      <div class="container">
        <h2 class="section-title">联系<span class="highlight">我们</span></h2>
        <p class="section-subtitle">如有任何问题或建议，请随时与我们联系</p>
        
        <div class="contact-info">
          <div class="contact-card">
            <div class="contact-icon">
              <i class="el-icon-message"></i>
            </div>
            <h3 class="contact-title">电子邮件</h3>
            <p class="contact-detail">lateyoung1@gmail.com</p>
          </div>
          
          <div class="contact-card">
            <div class="contact-icon">
              <i class="el-icon-phone"></i>
            </div>
            <h3 class="contact-title">电话</h3>
            <p class="contact-detail">+86 123 4567 8910</p>
          </div>
          
          <div class="contact-card">
            <div class="contact-icon">
              <i class="el-icon-location"></i>
            </div>
            <h3 class="contact-title">地址</h3>
            <p class="contact-detail">昆明市呈贡区景明南路</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 页脚 -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo">
            <el-image :src="logoSrc" alt="Logo" class="footer-logo-img"></el-image>
            <span class="footer-brand">MM-DFD</span>
          </div>
          
          <div class="footer-links">
            <div class="footer-links-column">
              <h3 class="footer-links-title">产品</h3>
              <a href="#features" class="footer-link">功能</a>
              <a href="#" class="footer-link">价格</a>
              <a href="#" class="footer-link">API</a>
            </div>
            
            <div class="footer-links-column">
              <h3 class="footer-links-title">资源</h3>
              <a href="#" class="footer-link">文档</a>
              <a href="#" class="footer-link">博客</a>
              <a href="#" class="footer-link">常见问题</a>
            </div>
            
            <div class="footer-links-column">
              <h3 class="footer-links-title">公司</h3>
              <a href="#about" class="footer-link">关于我们</a>
              <a href="#contact" class="footer-link">联系我们</a>
              <a href="#" class="footer-link">加入我们</a>
            </div>
            
            <div class="footer-links-column">
              <h3 class="footer-links-title">法律</h3>
              <a href="#" class="footer-link">隐私政策</a>
              <a href="#" class="footer-link">服务条款</a>
            </div>
          </div>
        </div>
        
        <div class="footer-bottom">
          <p class="copyright">© 2025 MM-DFD (多模态深度学习虚假新闻检测系统). 保留所有权利。</p>
          <div class="social-links">
            <a href="#" class="social-link">
              <i class="el-icon-s-platform"></i>
            </a>
            <a href="#" class="social-link">
              <i class="el-icon-s-marketing"></i>
            </a>
            <a href="#" class="social-link">
              <i class="el-icon-s-promotion"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>
  </div>
</template>

<script>
export default {
  name: 'HomePage',
  data() {
    return {
      
    }
  },
  computed: {
    logoSrc() {
      try {
        return require('@/assets/logo.svg')
      } catch (e) {
        return ''
      }
    }
  },
  methods: {
    goToLogin() {
      this.$router.push('/login')
    },
    goToRegister() {
      this.$router.push('/register')
    },
    scrollToFeatures() {
      const featuresSection = document.getElementById('features')
      if (featuresSection) {
        featuresSection.scrollIntoView({ behavior: 'smooth' })
      }
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

/* 全局样式 */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.section-title {
  font-size: 36px;
  font-weight: 700;
  margin-bottom: 20px;
  text-align: center;
  color: $main-font-color;
  
  .highlight {
    color: $primary-color;
    position: relative;
    
    &::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba($primary-color, 0.2);
      z-index: -1;
    }
  }
}

.section-subtitle {
  font-size: 18px;
  line-height: 1.6;
  text-align: center;
  color: $secondary-font-color;
  max-width: 700px;
  margin: 0 auto 60px;
}

/* 导航栏 */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background-color: rgba(255, 255, 255, 0.95);
  box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
  z-index: 100;
  backdrop-filter: blur(10px);
  padding: 10px 0;
}

.navbar-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo-section {
  display: flex;
  align-items: center;
}

.logo {
  width: 40px;
  height: 40px;
}

.brand-name {
  margin: 0 0 0 10px;
  font-size: 24px;
  font-weight: 700;
  color: $main-font-color;
}

.nav-links {
  display: flex;
  gap: 30px;
}

.nav-link {
  color: $regular-font-color;
  text-decoration: none;
  font-weight: 500;
  font-size: 16px;
  transition: $transition-base;
  position: relative;
  
  &::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 0;
    height: 2px;
    background-color: $primary-color;
    transition: $transition-base;
  }
  
  &:hover {
    color: $primary-color;
    
    &::after {
      width: 100%;
    }
  }
}

.auth-buttons {
  display: flex;
  align-items: center;
  gap: 15px;
}

.login-btn {
  color: $primary-color;
  font-weight: 500;
  
  &:hover {
    color: darken($primary-color, 10%);
  }
}

.register-btn {
  padding: 10px 20px;
}

/* 英雄区 */
.hero-section {
  padding: 160px 0 100px;
  position: relative;
  overflow: hidden;
}

.hero-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 60px;
}

.hero-content {
  flex: 1;
  max-width: 600px;
}

.hero-title {
  font-size: 48px;
  font-weight: 700;
  line-height: 1.2;
  margin-bottom: 24px;
  color: $main-font-color;
  animation: fadeInUp 0.8s ease-out;
}

.hero-description {
  font-size: 18px;
  line-height: 1.6;
  color: $secondary-font-color;
  margin-bottom: 40px;
  animation: fadeInUp 1s ease-out;
}

.hero-buttons {
  display: flex;
  gap: 20px;
  animation: fadeInUp 1.2s ease-out;
}

.hero-image {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  animation: fadeIn 1.2s ease-out;
}

.image-placeholder {
  width: 100%;
  height: 400px;
  position: relative;
}

.detection-illustration {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: url('data:image/svg+xml;base64,PHN2ZyBpZD0iYjY1ODhjYTUtNjIzYy00YjJlLTljOGEtODVkYzRkMGM2ZGJmIiBkYXRhLW5hbWU9IkxheWVyIDEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9Ijg4NS45MzQ3MyIgaGVpZ2h0PSI1OTAuMDAwMDEiIHZpZXdCb3g9IjAgMCA4ODUuOTM0NzMgNTkwLjAwMDAxIj48cGF0aCBkPSJNOTk1LjExOTQxLDY5NWwtLjk5OTc0LjAwMDMxVjI5NGExOTYuMDAwNDMsMTk2LjAwMDQzLDAsMCwwLTE5Ni0xOTZIMzA4LjExOTQxYTE5Ni4wMDA0MywxOTYuMDAwNDMsMCwwLDAtMTk2LDE5NnYyNzZhMTk2LjAwMDQyLDE5Ni4wMDA0MiwwLDAsMCwxOTYsMTk2aDQ5MVYWPSI+PC9wYXRoPjxwYXRoIGQ9Ik01MDEuNzE0NTUsNDYzLjQ0NTVjLTY0LjAwODczLDAtMTE2LjExNzc2LTUyLjEwOTM3LTExNi4xMTc3Ni0xMTYuMTE4MTFzNTIuMTA5LTExNi4xMTc3NiwxMTYuMTE3NzYtMTE2LjExNzc2UzYxNy44MzIzMSwyODMuMzE4NjYsNjE3LjgzMjMxLDM0Ny4zMjczOSw1NjUuNzIzMjgsNDYzLjQ0NTUsNTAxLjcxNDU1LDQ2My40NDU1Wm0wLTIwMi4xMTc3NmMtNDcuNDM2LDAtODYuMTE3NzYsMzguNjgxNzYtODYuMTE3NzYsODYuMTE3NzUsMCw0Ny40MzY1MiwzOC42ODE3Niw4Ni4xMTgxMSw4Ni4xMTc3Niw4Ni4xMTgxMXM4Ni4xMTc3Ni0zOC42ODE1OSw4Ni4xMTc3Ni04Ni4xMTgxMUM1ODcuODMyMzEsMzAwLjAwOTUsNTQ5LjE1MDU1LDI2MS4zMjc3NCw1MDEuNzE0NTUsMjYxLjMyNzc0WiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1Ny4wMzI2MyAtMTU1KSIgZmlsbD0iIzJiMmQ0MiI+PC9wYXRoPjxjaXJjbGUgY3g9IjM0NC42ODE5MyIgY3k9IjE5Mi4zMjczOSIgcj0iMTUiIGZpbGw9IiM0MzYxZWUiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjM0NC42ODE5MyIgY3k9IjE5Mi4zMjczOSIgcj0iMTUiIGZpbGw9IiM0MzYxZWUiPjwvY2lyY2xlPjwvc3ZnPg==');
  background-size: cover;
  background-position: center;
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
  
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba($primary-color, 0.3), rgba($info-color, 0.3));
    border-radius: $border-radius-large;
  }
}

.hero-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -1;
}

.bg-blob {
  position: absolute;
  border-radius: 50%;
  filter: blur(70px);
  opacity: 0.1;
}

.blob-1 {
  width: 500px;
  height: 500px;
  background: linear-gradient(135deg, $primary-color, $info-color);
  top: -200px;
  right: -100px;
  animation: float 20s infinite alternate ease-in-out;
}

.blob-2 {
  width: 600px;
  height: 600px;
  background: linear-gradient(135deg, $success-color, $info-color);
  bottom: -300px;
  left: -200px;
  animation: float 25s infinite alternate-reverse ease-in-out;
}

.blob-3 {
  width: 300px;
  height: 300px;
  background: linear-gradient(135deg, $warning-color, $primary-color);
  top: 40%;
  left: 40%;
  animation: float 15s infinite alternate ease-in-out;
}

/* 统计数据 */
.stats-section {
  padding: 60px 0;
  background-color: #fff;
  box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.03);
}

.stats-container {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: 30px;
}

.stat-item {
  text-align: center;
  padding: 20px;
}

.stat-number {
  font-size: 48px;
  font-weight: 700;
  color: $primary-color;
  margin-bottom: 10px;
  background: linear-gradient(135deg, $primary-color, $info-color);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  font-size: 18px;
  color: $regular-font-color;
  font-weight: 500;
}

/* 功能特点 */
.features-section {
  padding: 100px 0;
  background-color: $background-color;
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  margin-top: 60px;
}

.feature-card {
  background-color: white;
  border-radius: $border-radius-large;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  transition: $transition-base;
  
  &:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
  }
}

.feature-icon {
  font-size: 40px;
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, rgba($primary-color, 0.1), rgba($info-color, 0.1));
  border-radius: 20px;
  margin-bottom: 20px;
  color: $primary-color;
}

.feature-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 15px;
  color: $main-font-color;
}

.feature-description {
  color: $regular-font-color;
  line-height: 1.6;
}

/* 关于我们 */
.about-section {
  padding: 100px 0;
}

.about-content {
  display: flex;
  align-items: center;
  gap: 60px;
}

.about-text {
  flex: 1;
}

.about-description {
  margin-bottom: 20px;
  color: $regular-font-color;
  font-size: 16px;
  line-height: 1.8;
}

.about-image {
  flex: 1;
}

.about-illustration {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: url('data:image/svg+xml;base64,PHN2ZyBpZD0iZTU1Y2QxOTUtYmI5ZC00ODI2LWFlNDktNzVlMzZkYTQ1ZTk3IiBkYXRhLW5hbWU9IkxheWVyIDEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9Ijg5My42Mjg4MSIgaGVpZ2h0PSI3NDcuMTI2MjYiIHZpZXdCb3g9IjAgMCA4OTMuNjI4ODEgNzQ3LjEyNjI2Ij48cGF0aCBkPSJNMzg5Ljc3OTEyLDI2MC41OTg5NGMtMzQuNjYyOTQsMC03Mi45NTI4LDEuMzY4OS0xMTMuODY1NzgsNC4wOTk2MS0yMC44OTk5LDEuMzk0NTMtNDIuMTU3MjYsMy4xMjQ5MS02My4yMTE2Myw1LjE1MjM5LTM5LjUxOTc0LDMuODA0LTc2Ljg0MzczLDguMzg3NDUtMTExLjA4MTQyLDEzLjYzNDgtNS40OTgwNS44NDIyOS0xMS4wMjc4MywxLjcxMzg3LTE2LjQ3MDIxLDIuNjA3NDJhMTU1MS4wMjk2MywxNTUxLjAyOTYzLDAsMCwwLTE1Ny42OTQ3MywzMy43OTE3NmwtNC44OTY3MiwxLjI0OC45NzkzNSw3LjkyMzg5YTQ0MS4xNDcwOSw0NDEuMTQ3MDksMCwwLDAsNjguNjQ0ODQsMTgyLjgwNTY3bDEuMzgxODQsMi4yNDY1OCwyLjYxNjIxLS43NjUxM2E1ODMuNDIzNCw1ODMuNDIzNCwwLDAsMSw4MS4wMzgtMTcuOTQ1MzFsLjI4LTIuNjA3NGMzLjAxNzU4LTI4LjAwNDUsMTUuNTM3NTktNTkuODg0NzYsMzUuMjE3NzQtODkuODI5MzUsMTYuMDcyMjctMjQuMzkyNTgsMzMuNjY4NDUtNDQuMDcwMzcsNDkuMzE0LTU5LjE3OTJsMTAuMzcyLTkuNDkyMTktLjA1NjE1LS42MTc2NGMtMS4yNzY2MS0xNC4wMTM2Nyw1LjExNjctMjcuOTIwOSwxOS44NTgyLTQ0LjU0NTlDMjE3LjYzMjI1LDIzOS45MDYsODM2LjAwMDczLDI2MC41OTg5NCwzODkuNzc5MTIsMjYwLjU5ODk0WiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1My4xODU1OSAtNzYuNDM2ODcpIiBmaWxsPSIjZjJmMmYyIj48L3BhdGg+PHBhdGggZD0iTTE4Ni44NDY0NSwzMzIuNjM4MzVjNDYuODg5LTM3LjExMzgxLDE0MC44MDUzLTI4LjY0OTMsMjA2LjU0MzY3LTIwLjE3NDhDNDY0LjcxNywzMjIuNTQzNDksNTM2LjMzOTcyLDM0MS41NjY3MSw2MTAuMTAxLDM0MS41NjY3MVYzMzkuNTE3QzUzNi43MzUsMzM5LjUxNyw0NjUuNDQsNzYuNDM2ODcsMTUzLjE4NTU5LDc2LjQzNjg3WiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1My4xODU1OSAtNzYuNDM2ODcpIiBmaWxsPSIjNDM2MWVlIj48L3BhdGg+PHBhdGggZD0iTTQ5OC4zNzM1Miw1NDYuMTI0MDdhODcuMjQ1Nyw4Ny4yNDU3LDAsMCwxLTM2LjU4ODA3LDE3LjM5MzMxLDE5Ljg4Mjg1LDE5Ljg4Mjg1LDAsMCwxLTUuNjE2MDcuMDM5MTUsMTAuNjQ0MSwxMC42NDQxLDAsMCwxLTguNDAzLTUuNzgyNzksMTYuMDQzNzQsMTYuMDQzNzQsMCwwLDEtLjkyMTQ5LTEzLjAyMzcxYzIuNjAyLTguODk2NDgsMTAuNjY2ODUtMTUuOTE3MjQsMTguNDk5NzYtMjAuNzMxNzNhNzcuMDAxNDksNzcuMDAxNDksMCwwLDEsMzQuODE1NjctOS43NzgxYzUuMzU3NTItLjM5Mjc0LDExLjQ5MDUuOTA3NjksMTMuMjk0Nyw1Ljk2OTY5YTkuNTMyMTMsOS41MzIxMywwLDAsMS0xLjA1NTg1LDguNjc0MSwxNi41ODM0OSwxNi41ODM0OSwwLDAsMS03LjcyMTgxLDUuNzQzMDZaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTUzLjE4NTU5IC03Ni40MzY4NykiIGZpbGw9IiNmYmJlYmUiPjwvcGF0aD48cGF0aCBkPSJNNDYwLjAxNjMzLDU3OC45OTM0N2EzOS4zNDUzNCwzOS4zNDUzNCwwLDAsMCwyLjQ2OTc3LTUuNzM4MjZsMTUuNzcyNy0xLjY5OTE0LTEyLjc2MzcxLTguNDUzLDEwLjk2NDExLTEzLjA3MjQ0LTU4LjY0MjA3LDcuMzg0MzFhMjcuMDM5NTUsMjcuMDM5NTUsMCwwLDAtMTMuMjMwMjEsMTEuNDEwNDVsLjIzNTQ1LS43ODUxNWEyNC40NTgzNCwyNC40NTgzNCwwLDAsMC00LjE1OTg4LDEzLjMyNTQxYy0uMTQ0NDksNC43NDk1MywxLjMzMDkyLDkuNjEwNTYsNC40MDQ2MSwxMy4xNDI3MWEyOC4zOTgsMjguMzk4LDAsMCwwLDkuMTAxMDksNi4yNTk4MmM3LjYyMzI3LDMuMjE0NTgsMTYuMDkxNTYsNS4yMjY3NCwyNC4yNzkzLDUuNzY0Myw0LjAzNjg2LjM2NjU2LDguMzg1NTMuNDA3ODcsMTEuOTAwOTEtMS43MzE5NHMyLjA2MjgzLTUuOTc2ODUtLjU2NDQ5LTcuOTc0NDRhMTIuMzE4NjMsMTIuMzE4NjMsMCwwLDAtMi43NDItMS4yMjg3M2MtMTAuMTM4MjctMy40Mjk2LTIwLjUyODQ4LTcuNTExMzQtMjguNzE2NTYtMTQuNTExNzJhMzUuMTMzNDcsMzUuMTMzNDcsMCwwLDEtNy42MDA5MS04LjYyMDU1LDM4LjAxNDYzLDM4LjAxNDYzLDAsMCwxLTMuMDIzLTYuNDQ3MTkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xNTMuMTg1NTkgLTc2LjQzNjg3KSIgZmlsbD0iIzJiMmQ0MiI+PC9wYXRoPjwvc3ZnPg==');
  background-size: cover;
  background-position: center;
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
  
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba($info-color, 0.3), rgba($primary-color, 0.3));
    border-radius: $border-radius-large;
  }
}

/* 如何使用 */
.how-section {
  padding: 100px 0;
  background-color: $background-color;
}

.steps-container {
  max-width: 800px;
  margin: 60px auto;
}

.step-item {
  display: flex;
  gap: 30px;
  align-items: flex-start;
  margin-bottom: 50px;
  position: relative;
  
  &:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 80px;
    left: 30px;
    width: 2px;
    height: calc(100% - 30px);
    background-color: rgba($primary-color, 0.2);
  }
}

.step-number {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, $primary-color, $info-color);
  color: white;
  font-size: 24px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 20px rgba($primary-color, 0.3);
  z-index: 1;
}

.step-title {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 10px;
  color: $main-font-color;
}

.step-description {
  color: $regular-font-color;
  line-height: 1.6;
}

.cta-container {
  text-align: center;
  margin-top: 60px;
}

/* 联系我们 */
.contact-section {
  padding: 100px 0;
}

.contact-info {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 30px;
  margin-top: 60px;
}

.contact-card {
  background-color: white;
  border-radius: $border-radius-large;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  text-align: center;
  flex: 1;
  min-width: 250px;
  max-width: 300px;
  transition: $transition-base;
  
  &:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
  }
}

.contact-icon {
  font-size: 30px;
  color: $primary-color;
  margin-bottom: 20px;
}

.contact-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 15px;
  color: $main-font-color;
}

.contact-detail {
  color: $regular-font-color;
  line-height: 1.6;
}

/* 页脚 */
.footer {
  background-color: #2b2d42;
  color: white;
  padding: 80px 0 30px;
}

.footer-content {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 60px;
  margin-bottom: 60px;
}

.footer-logo {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.footer-logo-img {
  width: 40px;
  height: 40px;
}

.footer-brand {
  font-size: 24px;
  font-weight: 700;
  margin-left: 10px;
}

.footer-links {
  display: flex;
  flex-wrap: wrap;
  gap: 60px;
}

.footer-links-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  color: white;
}

.footer-link {
  display: block;
  color: rgba(255, 255, 255, 0.7);
  text-decoration: none;
  margin-bottom: 10px;
  transition: $transition-base;
  
  &:hover {
    color: white;
  }
}

.footer-bottom {
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding-top: 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
}

.copyright {
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
}

.social-links {
  display: flex;
  gap: 15px;
}

.social-link {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.1);
  color: white;
  text-decoration: none;
  transition: $transition-base;
  
  &:hover {
    background-color: $primary-color;
    transform: translateY(-3px);
  }
}

/* 动画 */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes float {
  0% {
    transform: translate(0, 0);
  }
  50% {
    transform: translate(30px, -30px);
  }
  100% {
    transform: translate(0, 0);
  }
}

/* 响应式 */
@media (max-width: $lg) {
  .hero-container {
    flex-direction: column;
  }
  
  .hero-content {
    text-align: center;
    max-width: 100%;
  }
  
  .hero-buttons {
    justify-content: center;
  }
  
  .image-placeholder {
    max-width: 500px;
    margin: 0 auto;
  }
  
  .about-content {
    flex-direction: column-reverse;
  }
  
  .section-title {
    font-size: 32px;
  }
  
  .hero-title {
    font-size: 36px;
  }
}

@media (max-width: $md) {
  .navbar-container {
    flex-direction: column;
    gap: 15px;
  }
  
  .nav-links {
    gap: 15px;
  }
  
  .features-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
  
  .footer-content {
    flex-direction: column;
    gap: 40px;
  }
  
  .footer-links {
    gap: 30px;
  }
  
  .footer-bottom {
    flex-direction: column;
    text-align: center;
  }
}

@media (max-width: $sm) {
  .hero-section {
    padding: 120px 0 60px;
  }
  
  .nav-links {
    flex-direction: column;
    align-items: center;
  }
  
  .auth-buttons {
    flex-direction: column;
    width: 100%;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\Login.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\Login.vue
================================================================================

<template>
  <div class="login-container">
    <div class="login-content">
      <div class="login-card">
        <div class="logo-container">
          <el-image :src="logoSrc" alt="Logo" class="logo"></el-image>
          <h2 class="title">多模态虚假新闻检测系统</h2>
        </div>
        
        <el-form ref="loginForm" :model="loginForm" :rules="loginRules" class="login-form">
          <el-form-item prop="username">
            <el-input 
              v-model="loginForm.username" 
              prefix-icon="el-icon-user" 
              placeholder="用户名"
              class="custom-input"
              @keyup.enter.native="handleLogin"
            />
          </el-form-item>
          
          <el-form-item prop="password">
            <el-input 
              v-model="loginForm.password" 
              prefix-icon="el-icon-lock" 
              type="password" 
              placeholder="密码"
              class="custom-input"
              @keyup.enter.native="handleLogin"
            />
          </el-form-item>
          
          <el-button 
            :loading="loading" 
            type="primary" 
            class="login-button" 
            @click="handleLogin"
          >
            登 录
          </el-button>
          
          <div class="login-options">
            <span class="register-link" @click="goToRegister">注册账号</span>
          </div>
        </el-form>
      </div>
    </div>
    <div class="login-background">
      <div class="bg-decoration bg-decoration-1"></div>
      <div class="bg-decoration bg-decoration-2"></div>
      <div class="bg-decoration bg-decoration-3"></div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'LoginView',
  data() {
    return {
      loginForm: {
        username: '',
        password: ''
      },
      loginRules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' }
        ],
        password: [
          { required: true, message: '请输入密码', trigger: 'blur' },
          { min: 6, message: '密码长度不能小于6个字符', trigger: 'blur' }
        ]
      },
      loading: false
    }
  },
  computed: {
    logoSrc() {
      try {
        return require('@/assets/logo.svg')
      } catch (e) {
        return this.$defaultLogo || ''
      }
    }
  },
  methods: {
    handleLogin() {
      this.$refs.loginForm.validate(valid => {
        if (valid) {
          this.loading = true
          this.$store.dispatch('user/login', this.loginForm)
            .then(() => {
              this.$message.success('登录成功')
              // 获取用户信息
              return this.$store.dispatch('user/getUserInfo')
            })
            .then(() => {
              // 重定向到仪表盘或指定页面
              const redirect = this.$route.query.redirect || '/dashboard/index'
              this.$router.push(redirect)
            })
            .catch(error => {
              console.error('登录失败:', error)
              this.$message.error('登录失败: ' + (error.response?.data?.detail || '用户名或密码错误'))
            })
            .finally(() => {
              this.loading = false
            })
        } else {
          return false
        }
      })
    },
    goToRegister() {
      this.$router.push('/register')
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.login-container {
  display: flex;
  height: 100vh;
  width: 100vw;
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.login-content {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  position: relative;
  z-index: 2;
}

.login-card {
  width: 400px;
  padding: 40px;
  background-color: rgba(255, 255, 255, 0.95);
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
  backdrop-filter: blur(10px);
  animation: fadeIn 0.6s ease-out;
}

.logo-container {
  text-align: center;
  margin-bottom: 30px;
}

.logo {
  width: 80px;
  height: 80px;
  transition: transform 0.3s;
  
  &:hover {
    transform: scale(1.05);
  }
}

.title {
  color: $main-font-color;
  margin-top: 16px;
  font-weight: 600;
  font-size: 24px;
}

.login-form {
  margin-top: 30px;
}

.custom-input {
  :deep(.el-input__inner) {
    height: 50px;
    border-radius: $border-radius-base;
    border: 1px solid $border-light-color;
    transition: all 0.3s;
    
    &:hover, &:focus {
      border-color: $primary-color;
      box-shadow: 0 0 0 2px rgba($primary-color, 0.2);
    }
  }
}

.login-button {
  width: 100%;
  margin-top: 24px;
  height: 50px;
  border-radius: $border-radius-base;
  font-size: 16px;
  font-weight: 500;
  background: linear-gradient(90deg, $primary-color, $info-color);
  border: none;
  transition: transform 0.3s, box-shadow 0.3s;
  
  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba($primary-color, 0.4);
  }
  
  &:active {
    transform: translateY(0);
  }
}

.login-options {
  margin-top: 24px;
  display: flex;
  justify-content: flex-end;
}

.register-link {
  color: $primary-color;
  cursor: pointer;
  transition: color 0.3s;
  font-weight: 500;

  &:hover {
    color: darken($primary-color, 10%);
    text-decoration: underline;
  }
}

.login-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
}

.bg-decoration {
  position: absolute;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba($primary-color, 0.6), rgba($info-color, 0.6));
  opacity: 0.1;
  filter: blur(60px);
}

.bg-decoration-1 {
  width: 600px;
  height: 600px;
  top: -100px;
  right: -100px;
  animation: float 10s ease-in-out infinite;
}

.bg-decoration-2 {
  width: 400px;
  height: 400px;
  bottom: -50px;
  left: -50px;
  animation: float 14s ease-in-out infinite reverse;
}

.bg-decoration-3 {
  width: 300px;
  height: 300px;
  top: 40%;
  left: 40%;
  animation: pulse 8s ease-in-out infinite;
}

@keyframes float {
  0% {
    transform: translate(0, 0);
  }
  50% {
    transform: translate(30px, 20px);
  }
  100% {
    transform: translate(0, 0);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 0.1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.2;
  }
  100% {
    transform: scale(1);
    opacity: 0.1;
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: $sm) {
  .login-card {
    width: 90%;
    max-width: 360px;
    padding: 30px;
  }
  
  .logo {
    width: 60px;
    height: 60px;
  }
  
  .title {
    font-size: 20px;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\NotFound.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\NotFound.vue
================================================================================

<template>
  <div class="not-found-container">
    <div class="background-decoration"></div>
    <div class="not-found-content">
      <div class="not-found-icon">404</div>
      <h2>页面不存在</h2>
      <p>抱歉，您访问的页面不存在或已被移除</p>
      <el-button type="primary" class="home-button" @click="goHome">
        <i class="el-icon-s-home"></i> 返回首页
      </el-button>
    </div>
  </div>
</template>

<script>
export default {
  name: 'NotFound',
  methods: {
    goHome() {
      this.$router.push('/')
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.not-found-container {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  position: relative;
  overflow: hidden;
}

.background-decoration {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 10% 20%, rgba($primary-color, 0.03) 0%, transparent 20%),
    radial-gradient(circle at 90% 80%, rgba($primary-color, 0.03) 0%, transparent 20%),
    radial-gradient(circle at 50% 50%, rgba($primary-color, 0.06) 0%, transparent 30%),
    radial-gradient(circle at 80% 10%, rgba($info-color, 0.04) 0%, transparent 20%);
  z-index: 0;
}

.not-found-content {
  text-align: center;
  padding: 60px;
  background-color: rgba(255, 255, 255, 0.95);
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
  max-width: 500px;
  position: relative;
  z-index: 1;
  animation: fadeInUp 0.6s ease-out;
  backdrop-filter: blur(10px);
}

.not-found-icon {
  font-size: 120px;
  font-weight: 800;
  background: linear-gradient(135deg, $primary-color, $info-color);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  margin-bottom: 20px;
  line-height: 1;
  animation: pulse 3s infinite;
  text-shadow: 0 10px 30px rgba($primary-color, 0.2);
}

h2 {
  margin: 20px 0;
  color: $main-font-color;
  font-size: 28px;
  font-weight: 600;
}

p {
  margin-bottom: 30px;
  color: $regular-font-color;
  font-size: 16px;
  line-height: 1.6;
}

.home-button {
  height: 48px;
  padding: 0 30px;
  font-size: 16px;
  font-weight: 500;
  border-radius: $border-radius-base;
  background: linear-gradient(90deg, $primary-color, $info-color);
  border: none;
  transition: transform 0.3s, box-shadow 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  
  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba($primary-color, 0.4);
  }
  
  i {
    margin-right: 8px;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0% {
    text-shadow: 0 5px 20px rgba($primary-color, 0.2);
  }
  50% {
    text-shadow: 0 5px 30px rgba($primary-color, 0.5);
  }
  100% {
    text-shadow: 0 5px 20px rgba($primary-color, 0.2);
  }
}

@media (max-width: $sm) {
  .not-found-content {
    padding: 40px 20px;
    max-width: 90%;
  }
  
  .not-found-icon {
    font-size: 100px;
  }
  
  h2 {
    font-size: 24px;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\Register.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\Register.vue
================================================================================

<template>
  <div class="register-container">
    <div class="register-content">
      <div class="register-card">
        <div class="logo-container">
          <el-image :src="logoSrc" alt="Logo" class="logo"></el-image>
          <h2 class="title">用户注册</h2>
        </div>
        
        <el-form ref="registerForm" :model="registerForm" :rules="registerRules" class="register-form">
          <el-form-item prop="username">
            <el-input 
              v-model="registerForm.username" 
              prefix-icon="el-icon-user" 
              placeholder="用户名 (4-20个字符)"
              class="custom-input"
            />
          </el-form-item>
          
          <el-form-item prop="email">
            <el-input 
              v-model="registerForm.email" 
              prefix-icon="el-icon-message" 
              placeholder="邮箱"
              class="custom-input"
            />
          </el-form-item>
          
          <el-form-item prop="first_name">
            <el-input 
              v-model="registerForm.first_name" 
              prefix-icon="el-icon-user" 
              placeholder="名字"
              class="custom-input"
            />
          </el-form-item>
          
          <el-form-item prop="last_name">
            <el-input 
              v-model="registerForm.last_name" 
              prefix-icon="el-icon-user" 
              placeholder="姓氏"
              class="custom-input"
            />
          </el-form-item>
          
          <el-form-item prop="password">
            <el-input 
              v-model="registerForm.password" 
              prefix-icon="el-icon-lock" 
              type="password" 
              placeholder="密码 (至少8位)"
              class="custom-input"
            />
          </el-form-item>
          
          <el-form-item prop="password2">
            <el-input 
              v-model="registerForm.password2" 
              prefix-icon="el-icon-lock" 
              type="password" 
              placeholder="确认密码"
              class="custom-input"
            />
          </el-form-item>
          
          <el-button 
            :loading="loading" 
            type="primary" 
            class="register-button" 
            @click="handleRegister"
          >
            注 册
          </el-button>
          
          <div class="register-options">
            <span>已有账号？</span>
            <span class="login-link" @click="goToLogin">立即登录</span>
          </div>
        </el-form>
      </div>
    </div>
    <div class="register-background">
      <div class="bg-decoration bg-decoration-1"></div>
      <div class="bg-decoration bg-decoration-2"></div>
      <div class="bg-decoration bg-decoration-3"></div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'RegisterView',
  data() {
    const validatePass = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请输入密码'))
      } else if (value.length < 8) {
        callback(new Error('密码长度不能小于8个字符'))
      } else {
        if (this.registerForm.password2 !== '') {
          this.$refs.registerForm.validateField('password2')
        }
        callback()
      }
    }
    const validateConfirmPass = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请再次输入密码'))
      } else if (value !== this.registerForm.password) {
        callback(new Error('两次输入密码不一致!'))
      } else {
        callback()
      }
    }
    return {
      registerForm: {
        username: '',
        email: '',
        first_name: '',
        last_name: '',
        password: '',
        password2: ''
      },
      registerRules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' },
          { min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur' }
        ],
        email: [
          { required: true, message: '请输入邮箱地址', trigger: 'blur' },
          { type: 'email', message: '请输入正确的邮箱地址', trigger: 'blur' }
        ],
        first_name: [
          { required: true, message: '请输入名字', trigger: 'blur' }
        ],
        last_name: [
          { required: true, message: '请输入姓氏', trigger: 'blur' }
        ],
        password: [
          { required: true, validator: validatePass, trigger: 'blur' }
        ],
        password2: [
          { required: true, validator: validateConfirmPass, trigger: 'blur' }
        ]
      },
      loading: false
    }
  },
  computed: {
    logoSrc() {
      try {
        return require('@/assets/logo.svg')
      } catch (e) {
        return this.$defaultLogo || ''
      }
    }
  },
  methods: {
    handleRegister() {
      this.$refs.registerForm.validate(valid => {
        if (valid) {
          this.loading = true
          this.$store.dispatch('user/register', this.registerForm)
            .then(() => {
              this.$message.success('注册成功，请登录')
              this.$nextTick(() => {
                this.$router.push('/login')
              })
            })
            .catch(error => {
              console.error('注册失败:', error)
              if (error.response && error.response.data) {
                const errorData = error.response.data;
                if (errorData.password && Array.isArray(errorData.password)) {
                  this.$message.error('密码错误: ' + errorData.password.join(', '));
                } else if (errorData.detail) {
                  this.$message.error(errorData.detail);
                } else if (errorData.username) {
                  this.$message.error('用户名错误: ' + errorData.username.join(', '));
                } else if (errorData.email) {
                  this.$message.error('邮箱错误: ' + errorData.email.join(', '));
                } else {
                  this.$message.error('注册失败，请检查输入信息');
                }
              } else {
                this.$message.error('注册失败，请稍后重试');
              }
            })
            .finally(() => {
              this.loading = false
            })
        } else {
          return false
        }
      })
    },
    goToLogin() {
      this.$router.push('/login')
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.register-container {
  display: flex;
  height: 100vh;
  width: 100vw;
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.register-content {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  position: relative;
  z-index: 2;
}

.register-card {
  width: 450px;
  padding: 40px;
  background-color: rgba(255, 255, 255, 0.95);
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
  backdrop-filter: blur(10px);
  animation: fadeIn 0.6s ease-out;
}

.logo-container {
  text-align: center;
  margin-bottom: 30px;
}

.logo {
  width: 80px;
  height: 80px;
  transition: transform 0.3s;
  
  &:hover {
    transform: scale(1.05);
  }
}

.title {
  color: $main-font-color;
  margin-top: 16px;
  font-weight: 600;
  font-size: 24px;
}

.register-form {
  margin-top: 20px;
}

.custom-input {
  :deep(.el-input__inner) {
    height: 50px;
    border-radius: $border-radius-base;
    border: 1px solid $border-light-color;
    transition: all 0.3s;
    
    &:hover, &:focus {
      border-color: $primary-color;
      box-shadow: 0 0 0 2px rgba($primary-color, 0.2);
    }
  }
}

.register-button {
  width: 100%;
  margin-top: 24px;
  height: 50px;
  border-radius: $border-radius-base;
  font-size: 16px;
  font-weight: 500;
  background: linear-gradient(90deg, $primary-color, $info-color);
  border: none;
  transition: transform 0.3s, box-shadow 0.3s;
  
  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba($primary-color, 0.4);
  }
  
  &:active {
    transform: translateY(0);
  }
}

.register-options {
  margin-top: 24px;
  display: flex;
  justify-content: center;
  gap: 5px;
}

.login-link {
  color: $primary-color;
  cursor: pointer;
  transition: color 0.3s;
  font-weight: 500;

  &:hover {
    color: darken($primary-color, 10%);
    text-decoration: underline;
  }
}

.register-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
}

.bg-decoration {
  position: absolute;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba($primary-color, 0.6), rgba($info-color, 0.6));
  opacity: 0.1;
  filter: blur(60px);
}

.bg-decoration-1 {
  width: 600px;
  height: 600px;
  top: -100px;
  right: -100px;
  animation: float 10s ease-in-out infinite;
}

.bg-decoration-2 {
  width: 400px;
  height: 400px;
  bottom: -50px;
  left: -50px;
  animation: float 14s ease-in-out infinite reverse;
}

.bg-decoration-3 {
  width: 300px;
  height: 300px;
  top: 40%;
  left: 40%;
  animation: pulse 8s ease-in-out infinite;
}

@keyframes float {
  0% {
    transform: translate(0, 0);
  }
  50% {
    transform: translate(30px, 20px);
  }
  100% {
    transform: translate(0, 0);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 0.1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.2;
  }
  100% {
    transform: scale(1);
    opacity: 0.1;
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: $sm) {
  .register-card {
    width: 90%;
    max-width: 400px;
    padding: 30px;
  }
  
  .logo {
    width: 60px;
    height: 60px;
  }
  
  .title {
    font-size: 20px;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\AdminLayout.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\AdminLayout.vue
================================================================================

<template>
  <div class="admin-layout">
    <el-container>
      <el-aside width="220px">
        <div class="admin-logo">
          <h2>后台管理系统</h2>
        </div>
        <el-menu
          :default-active="$route.path"
          class="admin-menu"
          background-color="#304156"
          text-color="#bfcbd9"
          active-text-color="#409EFF"
          router
        >
          <el-menu-item index="/admin/dashboard">
            <i class="el-icon-s-data"></i>
            <span>控制面板</span>
          </el-menu-item>
          
          <el-submenu index="users">
            <template slot="title">
              <i class="el-icon-user"></i>
              <span>用户管理</span>
            </template>
            <el-menu-item index="/admin/users">
              <i class="el-icon-user-solid"></i>
              <span>用户列表</span>
            </el-menu-item>
          </el-submenu>
          
          <el-submenu index="detections">
            <template slot="title">
              <i class="el-icon-search"></i>
              <span>检测管理</span>
            </template>
            <el-menu-item index="/admin/detection/list">
              <i class="el-icon-document"></i>
              <span>检测列表</span>
            </el-menu-item>
            <el-menu-item index="/admin/detection-stats">
              <i class="el-icon-data-analysis"></i>
              <span>统计分析</span>
            </el-menu-item>
          </el-submenu>
          
          <el-submenu index="system">
            <template slot="title">
              <i class="el-icon-setting"></i>
              <span>系统设置</span>
            </template>
            <el-menu-item index="/admin/settings">
              <i class="el-icon-s-tools"></i>
              <span>参数设置</span>
            </el-menu-item>
            <el-menu-item index="/admin/logs">
              <i class="el-icon-notebook-2"></i>
              <span>系统日志</span>
            </el-menu-item>
          </el-submenu>
        </el-menu>
      </el-aside>
      
      <el-container>
        <el-header>
          <div class="admin-header">
            <div class="breadcrumb">
              <el-breadcrumb separator="/">
                <el-breadcrumb-item :to="{ path: '/admin/dashboard' }">首页</el-breadcrumb-item>
                <el-breadcrumb-item v-for="(item, index) in breadcrumbs" :key="index">
                  {{ item }}
                </el-breadcrumb-item>
              </el-breadcrumb>
            </div>
            
            <div class="user-info">
              <el-dropdown trigger="click" @command="handleCommand">
                <span class="el-dropdown-link">
                  <el-avatar :size="32" icon="el-icon-user-solid"></el-avatar>
                  <span class="username">{{ currentUser.username }}</span>
                  <i class="el-icon-arrow-down el-icon--right"></i>
                </span>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item command="profile">个人资料</el-dropdown-item>
                  <el-dropdown-item command="settings">偏好设置</el-dropdown-item>
                  <el-dropdown-item divided command="logout">退出登录</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </div>
          </div>
        </el-header>
        
        <el-main>
          <router-view />
        </el-main>
        
        <el-footer>
          <div class="admin-footer">
            <p>© {{ new Date().getFullYear() }} 虚假新闻检测系统 - 后台管理</p>
          </div>
        </el-footer>
      </el-container>
    </el-container>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'

export default {
  name: 'AdminLayout',
  data() {
    return {
      breadcrumbs: []
    }
  },
  computed: {
    ...mapGetters(['currentUser'])
  },
  watch: {
    $route: {
      handler: function(route) {
        this.updateBreadcrumbs(route)
      },
      immediate: true
    }
  },
  methods: {
    handleCommand(command) {
      if (command === 'logout') {
        this.$store.dispatch('user/logout')
          .then(() => {
            this.$router.push('/login')
            this.$message.success('已成功退出登录')
          })
      } else if (command === 'profile') {
        this.$router.push('/admin/profile')
      } else if (command === 'settings') {
        this.$router.push('/admin/settings')
      }
    },
    
    updateBreadcrumbs(route) {
      const paths = route.path.split('/').filter(Boolean)
      const breadcrumbs = []
      
      if (paths.length > 1 && paths[0] === 'admin') {
        for (let i = 1; i < paths.length; i++) {
          let path = paths[i].charAt(0).toUpperCase() + paths[i].slice(1)
          breadcrumbs.push(this.formatBreadcrumb(path))
        }
      }
      
      this.breadcrumbs = breadcrumbs
    },
    
    formatBreadcrumb(path) {
      const breadcrumbMap = {
        'Dashboard': '控制面板',
        'Users': '用户列表',
        'Create': '添加用户',
        'Detections': '检测列表',
        'Detection-stats': '统计分析',
        'Settings': '系统设置',
        'Logs': '系统日志',
        'Profile': '个人资料'
      }
      
      return breadcrumbMap[path] || path
    }
  }
}
</script>

<style lang="scss" scoped>
.admin-layout {
  min-height: 100vh;
  
  .el-container {
    min-height: 100vh;
  }
  
  .el-aside {
    background-color: #304156;
    color: white;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 10;
  }
  
  .el-container:nth-child(2) {
    margin-left: 220px;
  }
  
  .admin-logo {
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #263445;
    
    h2 {
      color: white;
      margin: 0;
      font-size: 18px;
    }
  }
  
  .admin-menu {
    border-right: none;
  }
  
  .el-header {
    background-color: white;
    color: #333;
    box-shadow: 0 1px 4px rgba(0, 21, 41, 0.08);
    position: relative;
    z-index: 9;
    padding: 0;
    
    .admin-header {
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      
      .breadcrumb {
        flex: 1;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        
        .el-dropdown-link {
          display: flex;
          align-items: center;
          cursor: pointer;
          
          .username {
            margin: 0 10px;
          }
        }
      }
    }
  }
  
  .el-main {
    background-color: #f0f2f5;
    padding: 20px;
  }
  
  .el-footer {
    text-align: center;
    color: #999;
    padding: 20px;
    background-color: white;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\Dashboard.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\Dashboard.vue
================================================================================

<template>
  <div class="admin-dashboard">
    <div class="page-header">
      <h1 class="page-title">管理员仪表盘</h1>
      <div class="page-actions">
        <el-button type="primary" icon="el-icon-refresh" @click="refreshData">刷新数据</el-button>
      </div>
    </div>
    
    <!-- 错误消息提示 -->
    <el-alert
      v-if="errorMessage"
      :title="errorMessage"
      type="error"
      :closable="true"
      show-icon
      style="margin-bottom: 20px;"
    >
    </el-alert>
    
    <!-- 数据概览卡片 -->
    <el-row :gutter="20" class="data-overview" v-loading="loading" element-loading-text="加载数据中...">
      <el-col :xs="12" :sm="12" :md="6" :lg="6" :xl="6">
        <el-card shadow="hover" class="data-card">
          <div slot="header" class="clearfix">
            <span>总用户数</span>
          </div>
          <div class="card-body">
            <div class="card-content">
              <div class="card-value">{{ statistics.totalUsers }}</div>
            </div>
            <div class="card-icon">
              <i class="el-icon-user"></i>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :xs="12" :sm="12" :md="6" :lg="6" :xl="6">
        <el-card shadow="hover" class="data-card">
          <div slot="header" class="clearfix">
            <span>总检测量</span>
          </div>
          <div class="card-body">
            <div class="card-content">
              <div class="card-value">{{ statistics.totalDetections }}</div>
            </div>
            <div class="card-icon">
              <i class="el-icon-search"></i>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :xs="12" :sm="12" :md="6" :lg="6" :xl="6">
        <el-card shadow="hover" class="data-card">
          <div slot="header" class="clearfix">
            <span>虚假新闻比例</span>
          </div>
          <div class="card-body">
            <div class="card-content">
              <div class="card-value">{{ statistics.fakeNewsRatio }}%</div>
            </div>
            <div class="card-icon">
              <i class="el-icon-warning"></i>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :xs="12" :sm="12" :md="6" :lg="6" :xl="6">
        <el-card shadow="hover" class="data-card">
          <div slot="header" class="clearfix">
            <span>今日检测量</span>
          </div>
          <div class="card-body">
            <div class="card-content">
              <div class="card-value">{{ statistics.todayDetections }}</div>
            </div>
            <div class="card-icon">
              <i class="el-icon-date"></i>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 图表 -->
    <el-row :gutter="20" class="charts-row" v-loading="loading" element-loading-text="加载图表中...">
      <el-col :xs="24" :sm="24" :md="12" :lg="12" :xl="12">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测统计</span>
          </div>
          <div class="chart-container" ref="weeklyTrendChart"></div>
        </el-card>
      </el-col>
      
      <el-col :xs="24" :sm="24" :md="12" :lg="12" :xl="12">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测结果分布</span>
          </div>
          <div class="chart-container" ref="resultDistributionChart"></div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 最近检测列表 -->
    <el-card shadow="hover" class="recent-detections">
      <div slot="header" class="clearfix">
        <span>最近检测记录</span>
        <el-button style="float: right;" type="text" @click="viewAllDetections">查看全部</el-button>
      </div>
      
      <el-table
        :data="recentDetections"
        style="width: 100%"
        v-loading="loading"
      >
        <el-table-column
          prop="id"
          label="ID"
          width="80">
        </el-table-column>
        <el-table-column
          prop="user"
          label="用户"
          width="120">
        </el-table-column>
        <el-table-column
          prop="title"
          label="标题"
          show-overflow-tooltip>
        </el-table-column>
        <el-table-column
          prop="result"
          label="结果"
          width="100">
          <template slot-scope="scope">
            <el-tag :type="scope.row.result === '真实' ? 'success' : 'danger'">
              {{ scope.row.result }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column
          prop="confidence"
          label="置信度"
          width="100">
          <template slot-scope="scope">
            {{ scope.row.confidence }}%
          </template>
        </el-table-column>
        <el-table-column
          prop="created_at"
          label="检测时间"
          width="180">
        </el-table-column>
        <el-table-column
          fixed="right"
          label="操作"
          width="100">
          <template slot-scope="scope">
            <el-button type="text" size="small" @click="viewDetail(scope.row)">详情</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>

<script>
import * as echarts from 'echarts';
import axios from 'axios';

export default {
  name: 'AdminDashboard',
  data() {
    return {
      loading: false,
      statistics: {
        totalUsers: 0,
        totalDetections: 0,
        fakeNewsRatio: 0,
        todayDetections: 0
      },
      recentDetections: [],
      charts: {
        weeklyTrend: null,
        resultDistribution: null
      },
      errorMessage: ''
    }
  },
  created() {
    this.fetchData();
  },
  mounted() {
    this.initCharts();
  },
  methods: {
    // 获取数据
    fetchData() {
      this.loading = true;
      this.errorMessage = '';
      
      // 获取统计信息
      axios.get('/detection/detections/get_stats/?all=true')
        .then(response => {
          const data = response.data;
          
          this.statistics = {
            totalUsers: data.total_count || 0,
            totalDetections: data.total_count || 0,
            fakeNewsRatio: data.fake_percentage ? Math.round(data.fake_percentage) : 0,
            todayDetections: data.today_detections || 0
          };
          
          // 更新周趋势图表
          if (data.weekly_trend && data.weekly_trend.length > 0) {
            this.updateWeeklyTrendChart(data.weekly_trend);
          } else {
            // 如果后端未提供周趋势数据，则使用空数组
            this.updateWeeklyTrendChart([]);
          }
          
          // 更新结果分布图表
          if (data.result_distribution && data.result_distribution.length > 0) {
            this.updateResultDistributionChart(data.result_distribution);
          } else {
            const resultDistribution = [
              { name: '真实新闻', value: data.real_count || 0 },
              { name: '虚假新闻', value: data.fake_count || 0 }
            ];
            this.updateResultDistributionChart(resultDistribution);
          }
        })
        .catch(error => {
          console.error('获取统计数据失败:', error);
          this.errorMessage = '获取统计数据失败，请重试';
          this.$message.error('获取统计数据失败');
        })
        .finally(() => {
          this.loading = false;
        });
      
      // 获取最近的检测记录
      axios.get('/detection/detections/?limit=10')
        .then(response => {
          this.recentDetections = response.data.results.map(item => ({
            id: item.id,
            user: typeof item.user === 'string' ? item.user : (item.user?.username || '未知'),
            title: item.title,
            result: item.result === 'fake' ? '虚假' : (item.result === 'real' ? '真实' : '未知'),
            confidence: item.confidence_score ? Math.round(item.confidence_score * 100) : 0,
            created_at: new Date(item.created_at).toLocaleString()
          }));
        })
        .catch(error => {
          console.error('获取检测记录失败:', error);
          this.$message.error('获取检测记录失败');
        });
    },
    
    // 刷新数据
    refreshData() {
      this.fetchData();
    },
    
    // 初始化图表
    initCharts() {
      // 初始化周趋势图表
      this.charts.weeklyTrend = echarts.init(this.$refs.weeklyTrendChart);
      
      // 初始化结果分布图表
      this.charts.resultDistribution = echarts.init(this.$refs.resultDistributionChart);
      
      // 设置默认配置
      this.updateWeeklyTrendChart([]);
      this.updateResultDistributionChart([]);
      
      // 监听窗口大小变化，调整图表大小
      window.addEventListener('resize', this.resizeCharts);
    },
    
    // 更新周趋势图表
    updateWeeklyTrendChart(data) {
      if (!data || data.length === 0) {
        data = [
          { date: '今天', count: 0 },
          { date: '昨天', count: 0 },
          { date: '前天', count: 0 },
          { date: new Date(Date.now() - 3*24*60*60*1000).toLocaleDateString(), count: 0 },
          { date: new Date(Date.now() - 4*24*60*60*1000).toLocaleDateString(), count: 0 },
          { date: new Date(Date.now() - 5*24*60*60*1000).toLocaleDateString(), count: 0 },
          { date: new Date(Date.now() - 6*24*60*60*1000).toLocaleDateString(), count: 0 }
        ];
      }
      
      // 提取日期和数量
      const dates = data.map(item => item.date);
      const counts = data.map(item => item.count);
      
      // 设置图表配置
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: dates
        },
        yAxis: {
          type: 'value'
        },
        series: [{
          name: '检测数量',
          data: counts,
          type: 'bar', // 修改为柱状图
          itemStyle: {
            color: '#409EFF'
          }
        }]
      };
      
      this.charts.weeklyTrend.setOption(option);
    },
    
    // 更新结果分布图表
    updateResultDistributionChart(data) {
      // 如果没有数据，设置默认值
      if (!data || data.length === 0) {
        data = [
          { name: '真实新闻', value: 0 },
          { name: '虚假新闻', value: 0 }
        ];
      }
      
      // 设置图表配置
      const option = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
          orient: 'vertical',
          left: 10,
          data: data.map(item => item.name)
        },
        series: [
          {
            name: '检测结果',
            type: 'pie',
            radius: ['50%', '70%'],
            avoidLabelOverlap: false,
            label: {
              show: false,
              position: 'center'
            },
            emphasis: {
              label: {
                show: true,
                fontSize: '16',
                fontWeight: 'bold'
              }
            },
            labelLine: {
              show: false
            },
            data: [
              { value: data[0].value, name: '真实新闻', itemStyle: { color: '#67C23A' } },
              { value: data[1].value, name: '虚假新闻', itemStyle: { color: '#F56C6C' } }
            ]
          }
        ]
      };
      
      this.charts.resultDistribution.setOption(option);
    },
    
    // 调整图表大小
    resizeCharts() {
      this.charts.weeklyTrend.resize();
      this.charts.resultDistribution.resize();
    },
    
    // 查看所有检测
    viewAllDetections() {
      this.$router.push('/admin/detection/list');
    },
    
    // 查看检测详情
    viewDetail(row) {
      this.$router.push(`/admin/detection/detail/${row.id}`);
    }
  },
  beforeDestroy() {
    // 移除窗口大小变化监听器
    window.removeEventListener('resize', this.resizeCharts);
    
    // 销毁图表实例
    if (this.charts.weeklyTrend) {
      this.charts.weeklyTrend.dispose();
    }
    if (this.charts.resultDistribution) {
      this.charts.resultDistribution.dispose();
    }
  }
}
</script>

<style scoped>
.admin-dashboard {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-title {
  font-size: 24px;
  margin: 0;
}

.data-overview {
  margin-bottom: 30px;
}

.data-card {
  position: relative;
  height: 170px;
  overflow: hidden;
  margin-bottom: 15px;
  transition: all 0.3s;
}

.data-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.card-body {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 70px;
  padding: 0 15px;
}

.card-content {
  flex: 1;
  max-width: 70%;
  padding: 5px 0;
}

.card-value {
  font-size: 30px;
  font-weight: bold;
  margin-top: 5px;
  color: #303133;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.card-icon {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  margin-left: 10px;
  background-color: rgba(64, 158, 255, 0.1);
}

.card-icon i {
  font-size: 24px;
  color: #409EFF;
}

.el-col:nth-child(1) .card-icon {
  background-color: rgba(103, 194, 58, 0.1);
}

.el-col:nth-child(1) .card-icon i {
  color: #67C23A;
}

.el-col:nth-child(2) .card-icon {
  background-color: rgba(64, 158, 255, 0.1);
}

.el-col:nth-child(2) .card-icon i {
  color: #409EFF;
}

.el-col:nth-child(3) .card-icon {
  background-color: rgba(245, 108, 108, 0.1);
}

.el-col:nth-child(3) .card-icon i {
  color: #F56C6C;
}

.el-col:nth-child(4) .card-icon {
  background-color: rgba(230, 162, 60, 0.1);
}

.el-col:nth-child(4) .card-icon i {
  color: #E6A23C;
}

.charts-row {
  margin-bottom: 30px;
}

.chart-card {
  margin-bottom: 20px;
  transition: all 0.3s;
}

.chart-card:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.chart-container {
  height: 300px;
}

.recent-detections {
  margin-bottom: 20px;
  transition: all 0.3s;
}

.recent-detections:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.pagination-container {
  text-align: right;
  margin-top: 20px;
}

/* 适配移动端 */
@media (max-width: 768px) {
  .card-value {
    font-size: 24px;
  }
  
  .card-icon i {
    font-size: 24px;
  }
  
  .chart-container {
    height: 250px;
  }

  .data-card {
    height: 120px;
  }
  
  .card-body {
    height: 60px;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\DataAnalysis.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\DataAnalysis.vue
================================================================================

<template>
  <div class="data-analysis">
    <div class="page-header">
      <h1 class="page-title">数据分析</h1>
      <div class="time-filter">
        <el-radio-group v-model="timeRange" size="small" @change="handleTimeRangeChange">
          <el-radio-button label="today">今日</el-radio-button>
          <el-radio-button label="week">本周</el-radio-button>
          <el-radio-button label="month">本月</el-radio-button>
          <el-radio-button label="year">本年</el-radio-button>
        </el-radio-group>
        <el-date-picker
          v-model="customDateRange"
          type="daterange"
          size="small"
          range-separator="至"
          start-placeholder="开始日期"
          end-placeholder="结束日期"
          format="yyyy-MM-dd"
          value-format="yyyy-MM-dd"
          @change="handleCustomDateChange">
        </el-date-picker>
      </div>
    </div>
    
    <!-- 数据概览卡片 -->
    <el-row :gutter="20" class="data-overview">
      <el-col :span="6">
        <el-card shadow="hover" class="overview-card">
          <div class="overview-icon" style="background-color: #409EFF">
            <i class="el-icon-s-data"></i>
          </div>
          <div class="overview-content">
            <div class="overview-title">总检测次数</div>
            <div class="overview-value">{{ statistics.totalDetections }}</div>
            <div class="overview-change" :class="{'up': statistics.detectionChange > 0, 'down': statistics.detectionChange < 0}">
              <i :class="statistics.detectionChange >= 0 ? 'el-icon-top' : 'el-icon-bottom'"></i>
              {{ Math.abs(statistics.detectionChange) }}%
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card shadow="hover" class="overview-card">
          <div class="overview-icon" style="background-color: #67C23A">
            <i class="el-icon-user"></i>
          </div>
          <div class="overview-content">
            <div class="overview-title">活跃用户数</div>
            <div class="overview-value">{{ statistics.activeUsers }}</div>
            <div class="overview-change" :class="{'up': statistics.userChange > 0, 'down': statistics.userChange < 0}">
              <i :class="statistics.userChange >= 0 ? 'el-icon-top' : 'el-icon-bottom'"></i>
              {{ Math.abs(statistics.userChange) }}%
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card shadow="hover" class="overview-card">
          <div class="overview-icon" style="background-color: #E6A23C">
            <i class="el-icon-warning"></i>
          </div>
          <div class="overview-content">
            <div class="overview-title">假新闻检出率</div>
            <div class="overview-value">{{ statistics.fakeNewsRate }}%</div>
            <div class="overview-change" :class="{'up': statistics.fakeNewsChange > 0, 'down': statistics.fakeNewsChange < 0}">
              <i :class="statistics.fakeNewsChange >= 0 ? 'el-icon-top' : 'el-icon-bottom'"></i>
              {{ Math.abs(statistics.fakeNewsChange) }}%
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card shadow="hover" class="overview-card">
          <div class="overview-icon" style="background-color: #F56C6C">
            <i class="el-icon-pie-chart"></i>
          </div>
          <div class="overview-content">
            <div class="overview-title">平均置信度</div>
            <div class="overview-value">{{ statistics.avgConfidence }}%</div>
            <div class="overview-change" :class="{'up': statistics.confidenceChange > 0, 'down': statistics.confidenceChange < 0}">
              <i :class="statistics.confidenceChange >= 0 ? 'el-icon-top' : 'el-icon-bottom'"></i>
              {{ Math.abs(statistics.confidenceChange) }}%
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 图表区域 -->
    <el-row :gutter="20" class="chart-container">
      <el-col :span="16">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测趋势</span>
            <el-radio-group v-model="trendChartType" size="mini" style="float: right">
              <el-radio-button label="day">日</el-radio-button>
              <el-radio-button label="week">周</el-radio-button>
              <el-radio-button label="month">月</el-radio-button>
            </el-radio-group>
          </div>
          <div class="chart" ref="trendChart"></div>
        </el-card>
      </el-col>
      
      <el-col :span="8">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测结果分布</span>
          </div>
          <div class="chart" ref="pieChart"></div>
        </el-card>
      </el-col>
    </el-row>
    
    <el-row :gutter="20" class="chart-container">
      <el-col :span="12">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>用户活跃度排行</span>
          </div>
          <div class="chart" ref="userRankChart"></div>
        </el-card>
      </el-col>
      
      <el-col :span="12">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测内容分类统计</span>
          </div>
          <div class="chart" ref="categoryChart"></div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 热门检测内容列表 -->
    <el-card shadow="hover" class="list-card">
      <div slot="header" class="clearfix">
        <span>热门检测内容</span>
        <el-button style="float: right; padding: 3px 0" type="text" @click="viewAllDetections">查看全部</el-button>
      </div>
      
      <el-table :data="hotDetections" style="width: 100%">
        <el-table-column prop="content" label="检测内容" min-width="300">
          <template slot-scope="scope">
            <div class="content-ellipsis">{{ scope.row.content }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="user" label="用户" width="120"></el-table-column>
        <el-table-column prop="time" label="检测时间" width="180"></el-table-column>
        <el-table-column prop="result" label="检测结果" width="100">
          <template slot-scope="scope">
            <el-tag :type="scope.row.result === '真实' ? 'success' : 'danger'">
              {{ scope.row.result }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="confidence" label="置信度" width="100">
          <template slot-scope="scope">
            <el-progress :percentage="scope.row.confidence" :color="getConfidenceColor(scope.row.confidence)"></el-progress>
          </template>
        </el-table-column>
        <el-table-column prop="count" label="检测次数" width="100" sortable></el-table-column>
      </el-table>
    </el-card>
  </div>
</template>

<script>
// 引入echarts
import * as echarts from 'echarts';

export default {
  name: 'DataAnalysis',
  data() {
    return {
      // 时间筛选
      timeRange: 'month',
      customDateRange: [],
      
      // 图表类型
      trendChartType: 'day',
      
      // 统计数据
      statistics: {
        totalDetections: 8526,
        detectionChange: 13.5,
        activeUsers: 742,
        userChange: 8.2,
        fakeNewsRate: 37.8,
        fakeNewsChange: -2.3,
        avgConfidence: 82.6,
        confidenceChange: 1.4
      },
      
      // 图表实例
      trendChart: null,
      pieChart: null,
      userRankChart: null,
      categoryChart: null,
      
      // 热门检测内容
      hotDetections: []
    };
  },
  mounted() {
    this.initCharts();
    this.generateMockData();
  },
  methods: {
    // 初始化所有图表
    initCharts() {
      this.$nextTick(() => {
        // 检测趋势图
        this.trendChart = echarts.init(this.$refs.trendChart);
        
        // 检测结果饼图
        this.pieChart = echarts.init(this.$refs.pieChart);
        
        // 用户活跃度排行图
        this.userRankChart = echarts.init(this.$refs.userRankChart);
        
        // 检测内容分类统计图
        this.categoryChart = echarts.init(this.$refs.categoryChart);
        
        // 设置响应式
        window.addEventListener('resize', this.resizeCharts);
        
        // 初始化图表数据
        this.updateCharts();
      });
    },
    
    // 更新所有图表
    updateCharts() {
      this.updateTrendChart();
      this.updatePieChart();
      this.updateUserRankChart();
      this.updateCategoryChart();
    },
    
    // 更新趋势图
    updateTrendChart() {
      // 生成日期数据
      const days = 30;
      const dateList = [];
      const realData = [];
      const fakeData = [];
      
      for (let i = 0; i < days; i++) {
        const date = new Date();
        date.setDate(date.getDate() - (days - i - 1));
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        dateList.push(dateStr);
        
        // 生成随机数据
        const realCount = Math.floor(Math.random() * 100) + 50;
        const fakeCount = Math.floor(Math.random() * 80) + 20;
        
        realData.push(realCount);
        fakeData.push(fakeCount);
      }
      
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        legend: {
          data: ['真实新闻', '虚假新闻'],
          right: 10,
          top: 10
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: dateList,
          axisTick: {
            alignWithLabel: true
          }
        },
        yAxis: {
          type: 'value'
        },
        series: [
          {
            name: '真实新闻',
            type: 'line',
            smooth: true,
            data: realData,
            itemStyle: {
              color: '#67C23A'
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(103, 194, 58, 0.5)' },
                { offset: 1, color: 'rgba(103, 194, 58, 0.1)' }
              ])
            }
          },
          {
            name: '虚假新闻',
            type: 'line',
            smooth: true,
            data: fakeData,
            itemStyle: {
              color: '#F56C6C'
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(245, 108, 108, 0.5)' },
                { offset: 1, color: 'rgba(245, 108, 108, 0.1)' }
              ])
            }
          }
        ]
      };
      
      this.trendChart.setOption(option);
    },
    
    // 更新饼图
    updatePieChart() {
      const option = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b} : {c} ({d}%)'
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          data: ['真实新闻', '虚假新闻', '可疑内容', '无法判断']
        },
        series: [
          {
            name: '检测结果',
            type: 'pie',
            radius: '60%',
            center: ['60%', '50%'],
            data: [
              { value: 62, name: '真实新闻', itemStyle: { color: '#67C23A' } },
              { value: 25, name: '虚假新闻', itemStyle: { color: '#F56C6C' } },
              { value: 10, name: '可疑内容', itemStyle: { color: '#E6A23C' } },
              { value: 3, name: '无法判断', itemStyle: { color: '#909399' } }
            ],
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            },
            label: {
              formatter: '{b}: {d}%'
            }
          }
        ]
      };
      
      this.pieChart.setOption(option);
    },
    
    // 更新用户排行图
    updateUserRankChart() {
      const userNames = ['张三', '李四', '王五', '赵六', '钱七', '孙八', '周九', '吴十'];
      const userValues = [98, 89, 76, 72, 63, 58, 45, 32];
      
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'value',
          boundaryGap: [0, 0.01]
        },
        yAxis: {
          type: 'category',
          data: userNames.reverse(),
          axisLabel: {
            interval: 0
          }
        },
        series: [
          {
            name: '检测次数',
            type: 'bar',
            data: userValues.reverse(),
            itemStyle: {
              color: function(params) {
                const colorList = ['#409EFF', '#53a8ff', '#66b1ff', '#79bbff', '#8cc5ff', '#a0cfff', '#b3d8ff', '#c6e2ff'];
                return colorList[params.dataIndex];
              }
            }
          }
        ]
      };
      
      this.userRankChart.setOption(option);
    },
    
    // 更新内容分类图
    updateCategoryChart() {
      const option = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b} : {c}'
        },
        radar: {
          radius: '60%',
          center: ['50%', '50%'],
          name: {
            textStyle: {
              color: '#333',
              backgroundColor: '#fff',
              borderRadius: 3,
              padding: [3, 5]
            }
          },
          indicator: [
            { name: '政治新闻', max: 100 },
            { name: '社会新闻', max: 100 },
            { name: '经济新闻', max: 100 },
            { name: '体育新闻', max: 100 },
            { name: '娱乐新闻', max: 100 },
            { name: '科技新闻', max: 100 }
          ]
        },
        series: [
          {
            name: '检测分类',
            type: 'radar',
            areaStyle: {
              color: new echarts.graphic.RadialGradient(0.5, 0.5, 1, [
                { offset: 0, color: 'rgba(64, 158, 255, 0.7)' },
                { offset: 1, color: 'rgba(64, 158, 255, 0.1)' }
              ])
            },
            data: [
              {
                value: [85, 76, 62, 48, 92, 70],
                name: '检测数量',
                itemStyle: {
                  color: '#409EFF'
                },
                lineStyle: {
                  color: '#409EFF'
                }
              }
            ]
          }
        ]
      };
      
      this.categoryChart.setOption(option);
    },
    
    // 响应式调整图表大小
    resizeCharts() {
      this.trendChart && this.trendChart.resize();
      this.pieChart && this.pieChart.resize();
      this.userRankChart && this.userRankChart.resize();
      this.categoryChart && this.categoryChart.resize();
    },
    
    // 生成模拟数据
    generateMockData() {
      // 生成热门检测内容
      const contentList = [
        '研究显示喝咖啡有助于延长寿命',
        '某国科学家发现可再生能源新突破',
        '国家将出台新政策支持人工智能发展',
        '新冠病毒变种可能在冬季再次爆发',
        '世界杯小组赛爆出冷门，前冠军被淘汰',
        '研究发现常见食品添加剂可能致癌',
        '科学家在火星发现疑似生命痕迹',
        '某公司CEO涉嫌财务造假被调查',
        '政府宣布将投入100亿建设智慧城市',
        '气象部门预测今年将有极端天气事件增多'
      ];
      
      const users = ['张三', '李四', '王五', '赵六', '钱七'];
      const results = ['真实', '虚假'];
      
      this.hotDetections = contentList.map((content, index) => {
        const now = new Date();
        const randomDays = Math.floor(Math.random() * 30);
        const randomHours = Math.floor(Math.random() * 24);
        const randomMinutes = Math.floor(Math.random() * 60);
        
        now.setDate(now.getDate() - randomDays);
        now.setHours(now.getHours() - randomHours);
        now.setMinutes(now.getMinutes() - randomMinutes);
        
        const timeStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        const result = results[Math.floor(Math.random() * results.length)];
        const confidence = Math.floor(Math.random() * 30) + 70;
        
        return {
          id: index + 1,
          content,
          user: users[Math.floor(Math.random() * users.length)],
          time: timeStr,
          result,
          confidence,
          count: Math.floor(Math.random() * 50) + 10
        };
      });
      
      // 按检测次数排序
      this.hotDetections.sort((a, b) => b.count - a.count);
    },
    
    // 处理时间范围变化
    handleTimeRangeChange() {
      // 清空自定义日期范围
      this.customDateRange = [];
      this.updateCharts();
    },
    
    // 处理自定义日期变化
    handleCustomDateChange() {
      if (this.customDateRange && this.customDateRange.length === 2) {
        this.timeRange = 'custom';
        this.updateCharts();
      }
    },
    
    // 获取置信度颜色
    getConfidenceColor(confidence) {
      if (confidence < 60) return '#F56C6C';
      if (confidence < 75) return '#E6A23C';
      if (confidence < 90) return '#67C23A';
      return '#409EFF';
    },
    
    // 查看所有检测
    viewAllDetections() {
      this.$message.info('跳转到所有检测记录页面');
      // 实际开发中这里应该是路由跳转
      // this.$router.push('/admin/detection-records');
    }
  },
  beforeDestroy() {
    // 移除窗口大小改变事件
    window.removeEventListener('resize', this.resizeCharts);
    
    // 销毁图表实例
    this.trendChart && this.trendChart.dispose();
    this.pieChart && this.pieChart.dispose();
    this.userRankChart && this.userRankChart.dispose();
    this.categoryChart && this.categoryChart.dispose();
  }
};
</script>

<style lang="scss" scoped>
.data-analysis {
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    
    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
    }
    
    .time-filter {
      display: flex;
      align-items: center;
      gap: 15px;
    }
  }
  
  .data-overview {
    margin-bottom: 20px;
    
    .overview-card {
      height: 120px;
      display: flex;
      align-items: center;
      padding: 20px;
      
      .overview-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 15px;
        
        i {
          font-size: 28px;
          color: #fff;
        }
      }
      
      .overview-content {
        flex: 1;
        
        .overview-title {
          font-size: 14px;
          color: #909399;
          margin-bottom: 8px;
        }
        
        .overview-value {
          font-size: 24px;
          font-weight: bold;
          color: #303133;
          margin-bottom: 8px;
        }
        
        .overview-change {
          font-size: 12px;
          
          &.up {
            color: #67C23A;
          }
          
          &.down {
            color: #F56C6C;
          }
          
          i {
            margin-right: 2px;
          }
        }
      }
    }
  }
  
  .chart-container {
    margin-bottom: 20px;
    
    .chart-card {
      .chart {
        height: 350px;
      }
    }
  }
  
  .list-card {
    margin-bottom: 20px;
    
    .content-ellipsis {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
    }
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\DetectionStatistics.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\DetectionStatistics.vue
================================================================================

<template>
  <div class="detection-statistics">
    <div class="page-header">
      <h1 class="page-title">检测统计</h1>
      <div class="page-actions">
        <el-date-picker
          v-model="dateRange"
          type="daterange"
          range-separator="至"
          start-placeholder="开始日期"
          end-placeholder="结束日期"
          @change="handleDateRangeChange"
          :picker-options="pickerOptions">
        </el-date-picker>
        <el-button type="primary" icon="el-icon-refresh" @click="loadStatistics">刷新数据</el-button>
      </div>
    </div>
    
    <!-- 统计卡片 -->
    <el-row :gutter="20" class="data-overview">
      <el-col :span="6">
        <el-card shadow="hover" class="data-card total-card">
          <div class="data-card-header">
            <div class="card-title">总检测量</div>
            <i class="el-icon-s-data icon"></i>
          </div>
          <div class="data-card-body">
            <div class="card-value">{{ statistics.total_count || 0 }}</div>
            <div class="card-trend">
              <span class="trend-text">完成率</span>
              <span class="trend-value">{{ calculateCompletionRate }}%</span>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover" class="data-card true-card">
          <div class="data-card-header">
            <div class="card-title">真新闻量</div>
            <i class="el-icon-circle-check icon"></i>
          </div>
          <div class="data-card-body">
            <div class="card-value">{{ statistics.real_count || 0 }}</div>
            <div class="card-trend">
              <span class="trend-text">占比</span>
              <span class="trend-value">{{ statistics.real_percentage ? statistics.real_percentage.toFixed(1) : '0.0' }}%</span>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover" class="data-card fake-card">
          <div class="data-card-header">
            <div class="card-title">假新闻量</div>
            <i class="el-icon-circle-close icon"></i>
          </div>
          <div class="data-card-body">
            <div class="card-value">{{ statistics.fake_count || 0 }}</div>
            <div class="card-trend">
              <span class="trend-text">占比</span>
              <span class="trend-value">{{ statistics.fake_percentage ? statistics.fake_percentage.toFixed(1) : '0.0' }}%</span>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover" class="data-card task-card">
          <div class="data-card-header">
            <div class="card-title">平均置信度</div>
            <i class="el-icon-view icon"></i>
          </div>
          <div class="data-card-body">
            <div class="card-value">{{ (statistics.average_confidence ? (statistics.average_confidence * 100).toFixed(1) : '0.0') }}%</div>
            <div class="card-trend">
              <span class="trend-text">基于</span>
              <span class="trend-value">{{ statistics.completed_count || 0 }}个完成任务</span>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 图表区域 -->
    <el-row :gutter="20" class="chart-row">
      <el-col :span="12">
        <el-card class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测结果分布</span>
          </div>
          <div class="chart-container" v-loading="loading">
            <div ref="pieChart" style="width:100%; height:300px"></div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测状态分布</span>
          </div>
          <div class="chart-container" v-loading="loading">
            <div ref="statusChart" style="width:100%; height:300px"></div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 最近检测列表 -->
    <el-card class="recent-detection-card">
      <div slot="header" class="clearfix">
        <span>最近检测记录</span>
        <el-button style="float: right; padding: 3px 0" type="text" @click="viewAllDetections">查看全部</el-button>
      </div>
      <div v-loading="loadingDetections">
        <el-table :data="recentDetections" style="width: 100%" :row-class-name="getRowClassName">
          <el-table-column prop="id" label="ID" width="80"></el-table-column>
          <el-table-column prop="content" label="检测内容">
            <template slot-scope="scope">
              <div class="content-cell">
                <el-tooltip :content="scope.row.content" placement="top" :disabled="scope.row.content.length < 50">
                  <span>{{ truncateText(scope.row.content, 50) }}</span>
                </el-tooltip>
              </div>
            </template>
          </el-table-column>
          <el-table-column prop="user" label="用户" width="120"></el-table-column>
          <el-table-column prop="status" label="状态" width="100">
            <template slot-scope="scope">
              <el-tag :type="getStatusType(scope.row.status)">
                {{ getStatusLabel(scope.row.status) }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="result" label="检测结果" width="100">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.status === 'completed'" :type="scope.row.result === 'real' ? 'success' : 'danger'">
                {{ scope.row.result === 'real' ? '真实' : '虚假' }}
              </el-tag>
              <span v-else>-</span>
            </template>
          </el-table-column>
          <el-table-column prop="confidence_score" label="置信度" width="180">
            <template slot-scope="scope">
              <el-progress 
                v-if="scope.row.status === 'completed'"
                :percentage="parseFloat((scope.row.confidence_score * 100).toFixed(2))" 
                :color="getConfidenceColor(scope.row.confidence_score)">
              </el-progress>
              <span v-else>-</span>
            </template>
          </el-table-column>
          <el-table-column prop="created_at" label="检测时间" width="180">
            <template slot-scope="scope">
              {{ formatDateTime(scope.row.created_at) }}
            </template>
          </el-table-column>
        </el-table>
      </div>
    </el-card>
  </div>
</template>

<script>
import * as echarts from 'echarts/core';
import { GridComponent, TooltipComponent, TitleComponent, LegendComponent } from 'echarts/components';
import { PieChart } from 'echarts/charts';
import { CanvasRenderer } from 'echarts/renderers';
import axios from 'axios';

echarts.use([GridComponent, TooltipComponent, TitleComponent, LegendComponent, PieChart, CanvasRenderer]);

export default {
  name: 'DetectionStatistics',
  data() {
    return {
      loading: false,
      loadingDetections: false,
      dateRange: [new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000), new Date()],
      pickerOptions: {
        shortcuts: [{
          text: '最近一周',
          onClick(picker) {
            const end = new Date();
            const start = new Date();
            start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
            picker.$emit('pick', [start, end]);
          }
        }, {
          text: '最近一个月',
          onClick(picker) {
            const end = new Date();
            const start = new Date();
            start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
            picker.$emit('pick', [start, end]);
          }
        }, {
          text: '最近三个月',
          onClick(picker) {
            const end = new Date();
            const start = new Date();
            start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
            picker.$emit('pick', [start, end]);
          }
        }]
      },
      // 统计数据
      statistics: {
        total_count: 0,
        fake_count: 0,
        real_count: 0,
        pending_count: 0,
        completed_count: 0,
        failed_count: 0,
        fake_percentage: 0,
        real_percentage: 0,
        average_confidence: 0
      },
      // 最近检测记录
      recentDetections: [],
      // 图表实例
      pieChart: null,
      statusChart: null
    }
  },
  computed: {
    calculateCompletionRate() {
      return this.statistics.total_count > 0
        ? ((this.statistics.completed_count / this.statistics.total_count) * 100).toFixed(1)
        : '0.0'
    }
  },
  created() {
    this.loadStatistics()
    this.loadRecentDetections()
  },
  mounted() {
    this.initCharts()
    // 监听窗口大小变化，调整图表大小
    window.addEventListener('resize', this.resizeCharts)
  },
  beforeDestroy() {
    // 移除事件监听
    window.removeEventListener('resize', this.resizeCharts)
    // 销毁图表实例
    if (this.pieChart) {
      this.pieChart.dispose()
    }
    if (this.statusChart) {
      this.statusChart.dispose()
    }
  },
  methods: {
    // 加载统计数据
    loadStatistics() {
      this.loading = true
      
      // 构建API参数
      const params = {}
      params.all = 'true' // 管理员查看所有数据
      
      if (this.dateRange && this.dateRange.length === 2) {
        params.start_date = this.formatDate(this.dateRange[0])
        params.end_date = this.formatDate(this.dateRange[1])
      }
      
      axios.get('/detection/detections/get_stats/', { params })
        .then(response => {
          this.statistics = response.data
          this.updateCharts()
          this.loading = false
        })
        .catch(error => {
          console.error('获取统计数据失败:', error)
          this.$message.error('获取统计数据失败，请重试')
          this.loading = false
        })
    },
    
    // 加载最近检测记录
    loadRecentDetections() {
      this.loadingDetections = true
      
      axios.get('/detection/detections/', {
        params: { page: 1, page_size: 10 } // 只获取最近10条
      })
        .then(response => {
          this.recentDetections = response.data.results || []
          this.loadingDetections = false
        })
        .catch(error => {
          console.error('获取检测记录失败:', error)
          this.$message.error('获取检测记录失败，请重试')
          this.loadingDetections = false
        })
    },
    
    // 初始化图表
    initCharts() {
      // 初始化饼图
      this.pieChart = echarts.init(this.$refs.pieChart)
      
      // 初始化状态图
      this.statusChart = echarts.init(this.$refs.statusChart)
      
      // 更新图表数据
      this.updateCharts()
    },
    
    // 更新图表数据
    updateCharts() {
      if (!this.pieChart || !this.statusChart) return
      
      // 更新检测结果饼图
      const pieOption = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
          orient: 'vertical',
          right: 10,
          top: 'center',
          data: ['真实新闻', '虚假新闻']
        },
        series: [
          {
            name: '检测结果',
            type: 'pie',
            radius: ['50%', '70%'],
            avoidLabelOverlap: false,
            label: {
              show: false,
              position: 'center'
            },
            emphasis: {
              label: {
                show: true,
                fontSize: '18',
                fontWeight: 'bold'
              }
            },
            labelLine: {
              show: false
            },
            data: [
              { value: this.statistics.real_count || 0, name: '真实新闻', itemStyle: { color: '#67C23A' } },
              { value: this.statistics.fake_count || 0, name: '虚假新闻', itemStyle: { color: '#F56C6C' } }
            ]
          }
        ]
      }
      
      // 更新检测状态饼图
      const statusOption = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
          orient: 'vertical',
          right: 10,
          top: 'center',
          data: ['已完成', '进行中', '失败']
        },
        series: [
          {
            name: '检测状态',
            type: 'pie',
            radius: ['50%', '70%'],
            avoidLabelOverlap: false,
            label: {
              show: false,
              position: 'center'
            },
            emphasis: {
              label: {
                show: true,
                fontSize: '18',
                fontWeight: 'bold'
              }
            },
            labelLine: {
              show: false
            },
            data: [
              { value: this.statistics.completed_count || 0, name: '已完成', itemStyle: { color: '#67C23A' } },
              { value: this.statistics.pending_count || 0, name: '进行中', itemStyle: { color: '#E6A23C' } },
              { value: this.statistics.failed_count || 0, name: '失败', itemStyle: { color: '#F56C6C' } }
            ]
          }
        ]
      }
      
      this.pieChart.setOption(pieOption)
      this.statusChart.setOption(statusOption)
    },
    
    // 调整图表大小
    resizeCharts() {
      if (this.pieChart) this.pieChart.resize()
      if (this.statusChart) this.statusChart.resize()
    },
    
    // 日期范围变化处理
    handleDateRangeChange() {
      this.loadStatistics()
    },
    
    // 查看所有检测
    viewAllDetections() {
      this.$router.push('/admin/detection/list')
    },
    
    // 获取行类名
    getRowClassName({ row }) {
      return row.status === 'failed' ? 'error-row' : ''
    },
    
    // 获取状态标签类型
    getStatusType(status) {
      switch (status) {
        case 'completed': return 'success'
        case 'pending': return 'warning'
        case 'failed': return 'danger'
        default: return 'info'
      }
    },
    
    // 获取状态标签文本
    getStatusLabel(status) {
      switch (status) {
        case 'completed': return '已完成'
        case 'pending': return '进行中'
        case 'failed': return '失败'
        default: return '未知'
      }
    },
    
    // 获取置信度颜色
    getConfidenceColor(confidence) {
      if (confidence >= 0.8) return '#67C23A'
      if (confidence >= 0.6) return '#E6A23C'
      return '#F56C6C'
    },
    
    // 日期格式化
    formatDate(date) {
      const d = new Date(date)
      const year = d.getFullYear()
      const month = ('0' + (d.getMonth() + 1)).slice(-2)
      const day = ('0' + d.getDate()).slice(-2)
      return `${year}-${month}-${day}`
    },
    
    // 文本截断
    truncateText(text, length) {
      if (!text) return ''
      return text.length > length ? text.substring(0, length) + '...' : text
    },
    
    // Added datetime formatting function
    formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = ('0' + (date.getMonth() + 1)).slice(-2);
      const day = ('0' + date.getDate()).slice(-2);
      const hours = ('0' + date.getHours()).slice(-2);
      const minutes = ('0' + date.getMinutes()).slice(-2);
      const seconds = ('0' + date.getSeconds()).slice(-2);
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
  }
}
</script>

<style>
.detection-statistics {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-title {
  font-size: 24px;
  margin: 0;
}

.data-overview {
  margin-bottom: 20px;
}

.data-card {
  height: 170px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.data-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.card-title {
  font-size: 16px;
  font-weight: 500;
}

.data-card-body {
  display: flex;
  flex-direction: column;
}

.card-value {
  font-size: 30px;
  font-weight: bold;
  margin-bottom: 5px;
}

.card-trend {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
}

.total-card .icon {
  color: #409EFF;
  font-size: 24px;
}

.true-card .icon {
  color: #67C23A;
  font-size: 24px;
}

.fake-card .icon {
  color: #F56C6C;
  font-size: 24px;
}

.task-card .icon {
  color: #E6A23C;
  font-size: 24px;
}

.trend-value {
  font-weight: 500;
}

.trend-value.positive {
  color: #67C23A;
}

.trend-value.negative {
  color: #F56C6C;
}

.chart-row {
  margin-bottom: 20px;
}

.chart-card {
  margin-bottom: 20px;
}

.chart-container {
  height: 300px;
}

.content-cell {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 300px;
}

.error-row {
  background-color: #fef0f0;
}

// Add style to align progress text
.recent-detection-card .el-progress__text {
  text-align: right;
  display: inline-block;
  width: 40px;
  margin-left: 5px;
}

.recent-detection-card .el-progress-bar {
  width: 100px;
  display: inline-block;
}

.recent-detection-card .el-progress-bar__outer {
  height: 12px !important;
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\Settings.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\Settings.vue
================================================================================

<template>
  <div class="admin-settings">
    <div class="page-header">
      <h1 class="page-title">系统参数设置</h1>
      <div class="page-actions">
        <el-button type="primary" icon="el-icon-refresh" @click="loadSettings">刷新</el-button>
      </div>
    </div>
    
    <el-card shadow="hover" class="setting-card">
      <div slot="header" class="clearfix">
        <span>模型权重配置</span>
        <el-tooltip content="模型权重用于融合本地模型和LLM模型的预测结果" placement="top">
          <i class="el-icon-question"></i>
        </el-tooltip>
      </div>
      
      <div v-loading="loading">
        <el-form :model="weightForm" ref="weightForm" label-width="150px" :rules="rules">
          <el-form-item label="本地模型权重" prop="localModelWeight">
            <el-slider
              v-model="weightForm.localModelWeight"
              :format-tooltip="formatTooltip"
              :min="0"
              :max="1"
              :step="0.05"
              show-stops
            ></el-slider>
            <span class="weight-value">{{ formatTooltip(weightForm.localModelWeight) }}</span>
          </el-form-item>
          
          <el-form-item label="LLM模型权重" prop="llmWeight">
            <el-slider
              v-model="weightForm.llmWeight"
              :format-tooltip="formatTooltip"
              :min="0"
              :max="1"
              :step="0.05"
              show-stops
              :disabled="true"
            ></el-slider>
            <span class="weight-value">{{ formatTooltip(weightForm.llmWeight) }}</span>
          </el-form-item>
          
          <el-divider content-position="center">模型融合阈值设置</el-divider>
          
          <el-form-item label="虚假新闻阈值" prop="fakeThreshold">
            <el-slider
              v-model="weightForm.fakeThreshold"
              :format-tooltip="formatTooltip"
              :min="0.5"
              :max="0.9"
              :step="0.05"
              show-stops
            ></el-slider>
            <el-tooltip content="得分高于此阈值的新闻将被判定为虚假新闻" placement="top">
              <i class="el-icon-question"></i>
            </el-tooltip>
            <span class="weight-value">{{ formatTooltip(weightForm.fakeThreshold) }}</span>
          </el-form-item>
          
          <el-form-item label="真实新闻阈值" prop="realThreshold">
            <el-slider
              v-model="weightForm.realThreshold"
              :format-tooltip="formatTooltip"
              :min="0.1"
              :max="0.5"
              :step="0.05"
              show-stops
            ></el-slider>
            <el-tooltip content="得分低于此阈值的新闻将被判定为真实新闻" placement="top">
              <i class="el-icon-question"></i>
            </el-tooltip>
            <span class="weight-value">{{ formatTooltip(weightForm.realThreshold) }}</span>
          </el-form-item>
          
          <el-form-item>
            <el-button type="primary" @click="saveSettings" :loading="saving">保存设置</el-button>
            <el-button @click="resetForm">重置</el-button>
          </el-form-item>
        </el-form>
      </div>
    </el-card>
    
    <el-card shadow="hover" class="setting-card">
      <div slot="header" class="clearfix">
        <span>API配置</span>
      </div>
      
      <div v-loading="loading">
        <el-form :model="apiForm" ref="apiForm" label-width="150px" :rules="apiRules">
          <el-form-item label="OpenRouter API密钥" prop="openrouterApiKey">
            <el-input 
              v-model="apiForm.openrouterApiKey" 
              placeholder="sk-or-v1-..." 
              show-password
              clearable
            ></el-input>
            <div class="form-help-text">
              <i class="el-icon-info"></i>
              用于LLM交叉验证的OpenRouter API密钥
            </div>
          </el-form-item>
          
          <el-form-item label="GPU加速" prop="useGpu">
            <el-switch
              v-model="apiForm.useGpu"
              active-text="启用"
              inactive-text="禁用"
            ></el-switch>
            <div class="form-help-text">
              <i class="el-icon-info"></i>
              启用GPU加速可以提高检测速度，但需要服务器支持CUDA
            </div>
          </el-form-item>
          
          <el-form-item>
            <el-button type="primary" @click="saveApiSettings" :loading="saving">保存API设置</el-button>
            <el-button @click="resetApiForm">重置</el-button>
          </el-form-item>
        </el-form>
      </div>
    </el-card>
  </div>
</template>

<script>
import axios from 'axios'

export default {
  name: 'AdminSettings',
  data() {
    return {
      loading: false,
      saving: false,
      
      // 模型权重表单
      weightForm: {
        localModelWeight: 0.4,
        llmWeight: 0.6,
        fakeThreshold: 0.65,
        realThreshold: 0.35
      },
      
      // API设置表单
      apiForm: {
        openrouterApiKey: '',
        useGpu: false
      },
      
      // 表单验证规则
      rules: {
        localModelWeight: [
          { required: true, message: '请设置本地模型权重', trigger: 'change' }
        ],
        fakeThreshold: [
          { required: true, message: '请设置虚假新闻阈值', trigger: 'change' }
        ],
        realThreshold: [
          { required: true, message: '请设置真实新闻阈值', trigger: 'change' }
        ]
      },
      
      // API设置表单验证规则
      apiRules: {
        openrouterApiKey: [
          { pattern: /^sk-or-v1-[a-zA-Z0-9]+$/, message: '无效的API密钥格式', trigger: 'blur' }
        ]
      }
    }
  },
  watch: {
    'weightForm.localModelWeight': function(val) {
      this.weightForm.llmWeight = parseFloat((1 - val).toFixed(2))
    }
  },
  created() {
    this.loadSettings()
  },
  methods: {
    // 格式化滑块提示
    formatTooltip(val) {
      return parseFloat(val).toFixed(2)
    },
    
    // 加载设置
    loadSettings() {
      this.loading = true
      
      // 由于后端没有实现list方法，我们需要使用model_weights action来获取数据
      axios.get('/settings/model_weights/')
        .then(response => {
          const data = response.data
          this.weightForm = {
            localModelWeight: data.local_model_weight,
            llmWeight: data.llm_weight,
            fakeThreshold: data.fake_threshold,
            realThreshold: data.real_threshold
          }
          
          this.apiForm = {
            openrouterApiKey: data.openrouter_api_key || '',
            useGpu: data.use_gpu || false
          }
          
          this.loading = false
        })
        .catch(error => {
          console.error('加载设置失败:', error)
          this.$message.error('加载设置失败，请重试')
          this.loading = false
        })
    },
    
    // 保存模型权重设置
    saveSettings() {
      this.$refs.weightForm.validate(valid => {
        if (valid) {
          this.saving = true
          
          // 使用model_weights action的POST方法保存设置
          axios.post('/settings/model_weights/', {
            local_model_weight: this.weightForm.localModelWeight,
            llm_weight: this.weightForm.llmWeight,
            fake_threshold: this.weightForm.fakeThreshold,
            real_threshold: this.weightForm.realThreshold
          })
            .then(() => {
              this.$message.success('模型权重设置已保存')
              this.saving = false
            })
            .catch(error => {
              console.error('保存设置失败:', error)
              this.$message.error('保存设置失败，请重试')
              this.saving = false
            })
        }
      })
    },
    
    // 保存API设置
    saveApiSettings() {
      this.$refs.apiForm.validate(valid => {
        if (valid) {
          this.saving = true
          
          // 使用api_config action的POST方法保存API设置
          axios.post('/settings/api_config/', {
            openrouter_api_key: this.apiForm.openrouterApiKey,
            use_gpu: this.apiForm.useGpu
          })
            .then(() => {
              this.$message.success('API设置已保存')
              this.saving = false
            })
            .catch(error => {
              console.error('保存API设置失败:', error)
              this.$message.error('保存API设置失败，请重试')
              this.saving = false
            })
        }
      })
    },
    
    // 重置表单
    resetForm() {
      this.$refs.weightForm.resetFields()
      this.loadSettings()
    },
    
    // 重置API表单
    resetApiForm() {
      this.$refs.apiForm.resetFields()
      this.loadSettings()
    }
  }
}
</script>

<style scoped>
.admin-settings {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-title {
  font-size: 24px;
  margin: 0;
}

.setting-card {
  margin-bottom: 20px;
}

.weight-value {
  margin-left: 10px;
  color: #409EFF;
  font-weight: bold;
}

.form-help-text {
  color: #909399;
  font-size: 12px;
  margin-top: 5px;
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\SystemLogs.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\SystemLogs.vue
================================================================================

<template>
  <div class="admin-logs">
    <div class="page-header">
      <h1 class="page-title">系统日志</h1>
      <div class="page-actions">
        <el-button type="primary" icon="el-icon-refresh" @click="loadLogs">刷新</el-button>
      </div>
    </div>
    
    <el-card shadow="hover">
      <div slot="header" class="clearfix">
        <span>系统日志查看</span>
      </div>
      
      <div class="description">
        <p>该页面显示系统运行日志文件的内容，帮助管理员排查系统运行问题。</p>
      </div>
      
      <div v-loading="loading">
        <el-table
          :data="logs"
          style="width: 100%"
          border
          stripe
          :max-height="600"
        >
          <el-table-column
            prop="timestamp"
            label="时间"
            width="240">
          </el-table-column>
          <el-table-column
            prop="level"
            label="级别"
            width="100">
            <template slot-scope="scope">
              <el-tag 
                :type="getLogLevelType(scope.row.level)"
                size="small">
                {{ scope.row.level }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column
            prop="message"
            label="内容">
          </el-table-column>
        </el-table>
      </div>
    </el-card>
  </div>
</template>

<script>
import axios from 'axios'

export default {
  name: 'SystemLogs',
  data() {
    return {
      loading: false,
      logs: []
    }
  },
  created() {
    this.loadLogs()
  },
  methods: {
    // 加载日志
    loadLogs() {
      this.loading = true
      
      // 读取系统日志文件
      axios.get('/settings/logs/')
        .then(response => {
          this.logs = this.parseLogData(response.data)
          this.loading = false
        })
        .catch(error => {
          console.error('获取日志失败:', error)
          this.$message.error('获取日志失败，请重试')
          this.loading = false
          
          // 开发环境下使用模拟数据
          if (process.env.NODE_ENV === 'development') {
            this.loadMockData()
          }
        })
    },
    
    // 解析日志数据
    parseLogData(data) {
      if (!data || !data.logs || !Array.isArray(data.logs)) {
        return []
      }
      
      return data.logs.map((log, index) => ({
        id: index + 1,
        timestamp: log.timestamp || '',
        level: log.level || 'INFO',
        logger: log.logger || '',
        message: log.message || ''
      }))
    },
    
    // 加载模拟数据（开发阶段使用）
    loadMockData() {
      const mockLogs = []
      const levels = ['INFO', 'WARNING', 'ERROR', 'DEBUG']
      const loggers = ['django.server', 'django.request', 'detection.views', 'users.views', 'settings.views']
      const messages = [
        '用户登录成功',
        '检测任务创建成功',
        '检测任务完成',
        '模型权重更新',
        '系统启动',
        '数据库连接错误',
        'API请求超时',
        '用户权限验证失败',
        '文件上传失败',
        '非法请求被拦截'
      ]
      
      // 生成50条模拟日志
      for (let i = 0; i < 50; i++) {
        const date = new Date()
        date.setMinutes(date.getMinutes() - i * 30)
        
        mockLogs.push({
          id: i + 1,
          timestamp: date.toISOString().replace('T', ' ').substring(0, 19),
          level: levels[Math.floor(Math.random() * levels.length)],
          logger: loggers[Math.floor(Math.random() * loggers.length)],
          message: messages[Math.floor(Math.random() * messages.length)]
        })
      }
      
      this.logs = mockLogs
    },
    
    // 获取日志级别标签类型
    getLogLevelType(level) {
      switch (level) {
        case 'ERROR': return 'danger'
        case 'WARNING': return 'warning'
        case 'INFO': return 'success'
        case 'DEBUG': return 'info'
        default: return ''
      }
    }
  }
}
</script>

<style scoped>
.admin-logs {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-title {
  font-size: 24px;
  margin: 0;
}

.description {
  margin-bottom: 20px;
  color: #606266;
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\UserManagement.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\UserManagement.vue
================================================================================

<template>
  <div class="user-management">
    <div class="page-header">
      <h1 class="page-title">用户管理</h1>
      <el-button type="primary" @click="showAddUserDialog">添加用户</el-button>
    </div>
    
    <!-- 搜索和筛选 -->
    <el-card shadow="hover" class="filter-container">
      <el-form :inline="true" :model="searchForm" class="search-form">
        <el-form-item label="用户名">
          <el-input v-model="searchForm.username" placeholder="请输入用户名" clearable></el-input>
        </el-form-item>
        <el-form-item label="邮箱">
          <el-input v-model="searchForm.email" placeholder="请输入邮箱" clearable></el-input>
        </el-form-item>
        <el-form-item label="状态">
          <el-select v-model="searchForm.status" placeholder="请选择状态" clearable>
            <el-option label="启用" value="active"></el-option>
            <el-option label="禁用" value="inactive"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="角色">
          <el-select v-model="searchForm.role" placeholder="请选择角色" clearable>
            <el-option label="普通用户" value="user"></el-option>
            <el-option label="管理员" value="admin"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="handleSearch">搜索</el-button>
          <el-button icon="el-icon-refresh" @click="resetSearch">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 用户列表 -->
    <el-card shadow="hover" class="list-container">
      <div slot="header" class="clearfix">
        <span>用户列表</span>
        <el-button style="float: right; padding: 3px 0" type="text" @click="refreshUserList">刷新列表</el-button>
      </div>
      
      <el-table
        :data="userList"
        border
        style="width: 100%"
        v-loading="loading"
        @selection-change="handleSelectionChange">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column type="index" width="50" label="序号"></el-table-column>
        <el-table-column prop="avatar" label="头像" width="80">
          <template slot-scope="scope">
            <el-avatar :size="40" :src="scope.row.avatar">
              {{ scope.row.username.charAt(0).toUpperCase() }}
            </el-avatar>
          </template>
        </el-table-column>
        <el-table-column prop="username" label="用户名" width="120"></el-table-column>
        <el-table-column prop="email" label="邮箱" min-width="200"></el-table-column>
        <el-table-column prop="role" label="角色" width="100">
          <template slot-scope="scope">
            <el-tag :type="scope.row.role === 'admin' ? 'danger' : 'primary'">
              {{ scope.row.role === 'admin' ? '管理员' : '普通用户' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="100">
          <template slot-scope="scope">
            <el-tag :type="scope.row.status === 'active' ? 'success' : 'info'">
              {{ scope.row.status === 'active' ? '启用' : '禁用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="detection_count" label="检测次数" width="100"></el-table-column>
        <el-table-column prop="register_time" label="注册时间" width="180"></el-table-column>
        <el-table-column prop="last_login" label="最后登录" width="180"></el-table-column>
        <el-table-column label="操作" width="200" fixed="right">
          <template slot-scope="scope">
            <el-button
              size="mini"
              type="primary"
              plain
              @click="handleEdit(scope.row)"
              icon="el-icon-edit"
              circle></el-button>
            <el-button
              size="mini"
              type="warning"
              plain
              @click="handleResetPassword(scope.row)"
              icon="el-icon-key"
              circle></el-button>
            <el-button
              size="mini"
              :type="scope.row.status === 'active' ? 'info' : 'success'"
              plain
              @click="handleToggleStatus(scope.row)"
              :icon="scope.row.status === 'active' ? 'el-icon-lock' : 'el-icon-unlock'"
              circle></el-button>
            <el-button
              size="mini"
              type="danger"
              plain
              @click="handleDelete(scope.row)"
              icon="el-icon-delete"
              circle></el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 批量操作 -->
      <div class="batch-operation">
        <el-button
          :disabled="selectedUsers.length === 0"
          size="small"
          @click="batchEnable">批量启用</el-button>
        <el-button
          :disabled="selectedUsers.length === 0"
          size="small"
          @click="batchDisable">批量禁用</el-button>
        <el-button
          :disabled="selectedUsers.length === 0"
          size="small"
          type="danger"
          @click="batchDelete">批量删除</el-button>
      </div>
      
      <!-- 分页 -->
      <div class="pagination-container">
        <el-pagination
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page="pagination.currentPage"
          :page-sizes="[10, 20, 50, 100]"
          :page-size="pagination.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="pagination.total">
        </el-pagination>
      </div>
    </el-card>
    
    <!-- 添加/编辑用户对话框 -->
    <el-dialog
      :title="dialogType === 'add' ? '添加用户' : '编辑用户'"
      :visible.sync="userFormVisible"
      width="500px">
      <el-form :model="userForm" :rules="userFormRules" ref="userForm" label-width="100px">
        <el-form-item label="用户名" prop="username">
          <el-input v-model="userForm.username" :disabled="dialogType === 'edit'"></el-input>
        </el-form-item>
        <el-form-item label="邮箱" prop="email">
          <el-input v-model="userForm.email"></el-input>
        </el-form-item>
        <el-form-item label="密码" prop="password" v-if="dialogType === 'add'">
          <el-input v-model="userForm.password" type="password" show-password></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="confirmPassword" v-if="dialogType === 'add'">
          <el-input v-model="userForm.confirmPassword" type="password" show-password></el-input>
        </el-form-item>
        <el-form-item label="角色" prop="role">
          <el-select v-model="userForm.role" placeholder="请选择角色">
            <el-option label="普通用户" value="user"></el-option>
            <el-option label="管理员" value="admin"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="状态" prop="status">
          <el-radio-group v-model="userForm.status">
            <el-radio label="active">启用</el-radio>
            <el-radio label="inactive">禁用</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="userFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="submitUserForm" :loading="formSubmitting">确 定</el-button>
      </div>
    </el-dialog>
    
    <!-- 重置密码对话框 -->
    <el-dialog
      title="重置密码"
      :visible.sync="resetPasswordVisible"
      width="400px">
      <el-form :model="resetPasswordForm" :rules="resetPasswordRules" ref="resetPasswordForm" label-width="100px">
        <el-form-item label="新密码" prop="newPassword">
          <el-input v-model="resetPasswordForm.newPassword" type="password" show-password></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="confirmPassword">
          <el-input v-model="resetPasswordForm.confirmPassword" type="password" show-password></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="resetPasswordVisible = false">取 消</el-button>
        <el-button type="primary" @click="submitResetPassword" :loading="resetPasswordSubmitting">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'UserManagement',
  data() {
    // 校验邮箱
    const validateEmail = (rule, value, callback) => {
      const emailRegex = /^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
      if (!value) {
        callback(new Error('请输入邮箱地址'));
      } else if (!emailRegex.test(value)) {
        callback(new Error('请输入正确的邮箱地址'));
      } else {
        callback();
      }
    };
    
    // 校验确认密码
    const validateConfirmPassword = (rule, value, callback) => {
      if (value !== this.userForm.password) {
        callback(new Error('两次输入密码不一致'));
      } else {
        callback();
      }
    };
    
    // 校验重置密码
    const validateResetConfirmPassword = (rule, value, callback) => {
      if (value !== this.resetPasswordForm.newPassword) {
        callback(new Error('两次输入密码不一致'));
      } else {
        callback();
      }
    };
    
    return {
      // 搜索表单
      searchForm: {
        username: '',
        email: '',
        status: '',
        role: ''
      },
      
      // 用户列表
      userList: [],
      loading: true,
      selectedUsers: [],
      
      // 分页配置
      pagination: {
        currentPage: 1,
        pageSize: 10,
        total: 0
      },
      
      // 用户表单
      userFormVisible: false,
      dialogType: 'add', // 'add' 或 'edit'
      formSubmitting: false,
      userForm: {
        username: '',
        email: '',
        password: '',
        confirmPassword: '',
        role: 'user',
        status: 'active'
      },
      userFormRules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' },
          { min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur' }
        ],
        email: [
          { required: true, message: '请输入邮箱地址', trigger: 'blur' },
          { validator: validateEmail, trigger: 'blur' }
        ],
        password: [
          { required: true, message: '请输入密码', trigger: 'blur' },
          { min: 6, message: '密码长度不能少于6个字符', trigger: 'blur' }
        ],
        confirmPassword: [
          { required: true, message: '请再次输入密码', trigger: 'blur' },
          { validator: validateConfirmPassword, trigger: 'blur' }
        ],
        role: [
          { required: true, message: '请选择角色', trigger: 'change' }
        ],
        status: [
          { required: true, message: '请选择状态', trigger: 'change' }
        ]
      },
      
      // 重置密码
      resetPasswordVisible: false,
      resetPasswordSubmitting: false,
      currentUser: null,
      resetPasswordForm: {
        newPassword: '',
        confirmPassword: ''
      },
      resetPasswordRules: {
        newPassword: [
          { required: true, message: '请输入新密码', trigger: 'blur' },
          { min: 6, message: '密码长度不能少于6个字符', trigger: 'blur' }
        ],
        confirmPassword: [
          { required: true, message: '请再次输入密码', trigger: 'blur' },
          { validator: validateResetConfirmPassword, trigger: 'blur' }
        ]
      }
    };
  },
  created() {
    this.getUserList();
  },
  methods: {
    // 获取用户列表
    getUserList() {
      this.loading = true;
      
      // 这里应该是实际的API调用
      // this.$http.get('/api/users', {
      //   params: {
      //     page: this.pagination.currentPage,
      //     limit: this.pagination.pageSize,
      //     ...this.searchForm
      //   }
      // }).then(response => {
      //   this.userList = response.data.users;
      //   this.pagination.total = response.data.total;
      //   this.loading = false;
      // }).catch(error => {
      //   console.error('获取用户列表失败:', error);
      //   this.loading = false;
      //   this.$message.error('获取用户列表失败');
      // });
      
      // 模拟数据
      setTimeout(() => {
        const mockUsers = [];
        const total = 126;
        const startIndex = (this.pagination.currentPage - 1) * this.pagination.pageSize + 1;
        const endIndex = Math.min(startIndex + this.pagination.pageSize - 1, total);
        
        for (let i = startIndex; i <= endIndex; i++) {
          const isAdmin = i === 1; // 第一个用户是管理员
          mockUsers.push({
            id: i,
            username: i === 1 ? 'admin' : `user${i}`,
            email: i === 1 ? 'admin@example.com' : `user${i}@example.com`,
            role: isAdmin ? 'admin' : 'user',
            status: Math.random() > 0.2 ? 'active' : 'inactive',
            avatar: '',
            detection_count: Math.floor(Math.random() * 100),
            register_time: '2023-' + Math.floor(Math.random() * 12 + 1).toString().padStart(2, '0') + '-' +
                          Math.floor(Math.random() * 28 + 1).toString().padStart(2, '0') + ' ' +
                          Math.floor(Math.random() * 24).toString().padStart(2, '0') + ':' +
                          Math.floor(Math.random() * 60).toString().padStart(2, '0') + ':' +
                          Math.floor(Math.random() * 60).toString().padStart(2, '0'),
            last_login: '2023-' + Math.floor(Math.random() * 12 + 1).toString().padStart(2, '0') + '-' +
                        Math.floor(Math.random() * 28 + 1).toString().padStart(2, '0') + ' ' +
                        Math.floor(Math.random() * 24).toString().padStart(2, '0') + ':' +
                        Math.floor(Math.random() * 60).toString().padStart(2, '0') + ':' +
                        Math.floor(Math.random() * 60).toString().padStart(2, '0')
          });
        }
        
        // 根据搜索条件筛选
        if (this.searchForm.username) {
          mockUsers = mockUsers.filter(user => user.username.includes(this.searchForm.username));
        }
        if (this.searchForm.email) {
          mockUsers = mockUsers.filter(user => user.email.includes(this.searchForm.email));
        }
        if (this.searchForm.status) {
          mockUsers = mockUsers.filter(user => user.status === this.searchForm.status);
        }
        if (this.searchForm.role) {
          mockUsers = mockUsers.filter(user => user.role === this.searchForm.role);
        }
        
        this.userList = mockUsers;
        this.pagination.total = total;
        this.loading = false;
      }, 500);
    },
    
    // 搜索
    handleSearch() {
      this.pagination.currentPage = 1;
      this.getUserList();
    },
    
    // 重置搜索
    resetSearch() {
      this.searchForm = {
        username: '',
        email: '',
        status: '',
        role: ''
      };
      this.handleSearch();
    },
    
    // 刷新用户列表
    refreshUserList() {
      this.getUserList();
    },
    
    // 处理页码变化
    handleCurrentChange(page) {
      this.pagination.currentPage = page;
      this.getUserList();
    },
    
    // 处理每页显示数量变化
    handleSizeChange(size) {
      this.pagination.pageSize = size;
      this.pagination.currentPage = 1;
      this.getUserList();
    },
    
    // 多选变化
    handleSelectionChange(selection) {
      this.selectedUsers = selection;
    },
    
    // 显示添加用户对话框
    showAddUserDialog() {
      this.dialogType = 'add';
      this.userForm = {
        username: '',
        email: '',
        password: '',
        confirmPassword: '',
        role: 'user',
        status: 'active'
      };
      this.userFormVisible = true;
      this.$nextTick(() => {
        this.$refs.userForm && this.$refs.userForm.clearValidate();
      });
    },
    
    // 编辑用户
    handleEdit(row) {
      this.dialogType = 'edit';
      this.userForm = {
        id: row.id,
        username: row.username,
        email: row.email,
        role: row.role,
        status: row.status
      };
      this.userFormVisible = true;
      this.$nextTick(() => {
        this.$refs.userForm && this.$refs.userForm.clearValidate();
      });
    },
    
    // 提交用户表单
    submitUserForm() {
      this.$refs.userForm.validate(valid => {
        if (valid) {
          this.formSubmitting = true;
          
          // 这里应该是实际的API调用
          // const apiMethod = this.dialogType === 'add' ? 'post' : 'put';
          // const apiUrl = this.dialogType === 'add' ? '/api/users' : `/api/users/${this.userForm.id}`;
          // this.$http[apiMethod](apiUrl, this.userForm)
          //   .then(response => {
          //     this.formSubmitting = false;
          //     this.userFormVisible = false;
          //     this.$message.success(this.dialogType === 'add' ? '添加用户成功' : '编辑用户成功');
          //     this.getUserList();
          //   })
          //   .catch(error => {
          //     console.error(this.dialogType === 'add' ? '添加用户失败:' : '编辑用户失败:', error);
          //     this.formSubmitting = false;
          //     this.$message.error(this.dialogType === 'add' ? '添加用户失败' : '编辑用户失败');
          //   });
          
          // 模拟API调用
          setTimeout(() => {
            this.formSubmitting = false;
            this.userFormVisible = false;
            this.$message.success(this.dialogType === 'add' ? '添加用户成功' : '编辑用户成功');
            this.getUserList();
          }, 1000);
        }
      });
    },
    
    // 重置密码
    handleResetPassword(row) {
      this.currentUser = row;
      this.resetPasswordForm = {
        newPassword: '',
        confirmPassword: ''
      };
      this.resetPasswordVisible = true;
      this.$nextTick(() => {
        this.$refs.resetPasswordForm && this.$refs.resetPasswordForm.clearValidate();
      });
    },
    
    // 提交重置密码
    submitResetPassword() {
      this.$refs.resetPasswordForm.validate(valid => {
        if (valid) {
          this.resetPasswordSubmitting = true;
          
          // 这里应该是实际的API调用
          // this.$http.post(`/api/users/${this.currentUser.id}/reset-password`, {
          //   newPassword: this.resetPasswordForm.newPassword
          // })
          //   .then(response => {
          //     this.resetPasswordSubmitting = false;
          //     this.resetPasswordVisible = false;
          //     this.$message.success('密码重置成功');
          //   })
          //   .catch(error => {
          //     console.error('密码重置失败:', error);
          //     this.resetPasswordSubmitting = false;
          //     this.$message.error('密码重置失败');
          //   });
          
          // 模拟API调用
          setTimeout(() => {
            this.resetPasswordSubmitting = false;
            this.resetPasswordVisible = false;
            this.$message.success('密码重置成功');
          }, 1000);
        }
      });
    },
    
    // 切换用户状态
    handleToggleStatus(row) {
      const action = row.status === 'active' ? '禁用' : '启用';
      
      this.$confirm(`确定要${action}用户 "${row.username}" 吗?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        // 这里应该是实际的API调用
        // this.$http.put(`/api/users/${row.id}/toggle-status`, {
        //   status: row.status === 'active' ? 'inactive' : 'active'
        // })
        //   .then(response => {
        //     this.$message.success(`${action}用户成功`);
        //     // 更新本地数据
        //     row.status = row.status === 'active' ? 'inactive' : 'active';
        //   })
        //   .catch(error => {
        //     console.error(`${action}用户失败:`, error);
        //     this.$message.error(`${action}用户失败`);
        //   });
        
        // 模拟API调用
        setTimeout(() => {
          this.$message.success(`${action}用户成功`);
          // 更新本地数据
          row.status = row.status === 'active' ? 'inactive' : 'active';
        }, 300);
      }).catch(() => {
        // 取消操作
      });
    },
    
    // 删除用户
    handleDelete(row) {
      this.$confirm(`确定要删除用户 "${row.username}" 吗?`, '警告', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        // 这里应该是实际的API调用
        // this.$http.delete(`/api/users/${row.id}`)
        //   .then(response => {
        //     this.$message.success('删除用户成功');
        //     this.getUserList();
        //   })
        //   .catch(error => {
        //     console.error('删除用户失败:', error);
        //     this.$message.error('删除用户失败');
        //   });
        
        // 模拟API调用
        setTimeout(() => {
          this.$message.success('删除用户成功');
          this.getUserList();
        }, 300);
      }).catch(() => {
        // 取消操作
      });
    },
    
    // 批量启用
    batchEnable() {
      if (this.selectedUsers.length === 0) return;
      
      const usernames = this.selectedUsers.map(user => user.username).join('、');
      this.$confirm(`确定要启用选中的 ${this.selectedUsers.length} 个用户吗?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        // 实际API调用
        // const userIds = this.selectedUsers.map(user => user.id);
        // this.$http.post('/api/users/batch-enable', { userIds })
        //   .then(response => {
        //     this.$message.success('批量启用成功');
        //     this.getUserList();
        //   })
        //   .catch(error => {
        //     console.error('批量启用失败:', error);
        //     this.$message.error('批量启用失败');
        //   });
        
        // 模拟API调用
        setTimeout(() => {
          this.$message.success('批量启用成功');
          this.getUserList();
        }, 300);
      }).catch(() => {
        // 取消操作
      });
    },
    
    // 批量禁用
    batchDisable() {
      if (this.selectedUsers.length === 0) return;
      
      const usernames = this.selectedUsers.map(user => user.username).join('、');
      this.$confirm(`确定要禁用选中的 ${this.selectedUsers.length} 个用户吗?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        // 实际API调用
        // const userIds = this.selectedUsers.map(user => user.id);
        // this.$http.post('/api/users/batch-disable', { userIds })
        //   .then(response => {
        //     this.$message.success('批量禁用成功');
        //     this.getUserList();
        //   })
        //   .catch(error => {
        //     console.error('批量禁用失败:', error);
        //     this.$message.error('批量禁用失败');
        //   });
        
        // 模拟API调用
        setTimeout(() => {
          this.$message.success('批量禁用成功');
          this.getUserList();
        }, 300);
      }).catch(() => {
        // 取消操作
      });
    },
    
    // 批量删除
    batchDelete() {
      if (this.selectedUsers.length === 0) return;
      
      this.$confirm(`确定要删除选中的 ${this.selectedUsers.length} 个用户吗?`, '警告', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        // 实际API调用
        // const userIds = this.selectedUsers.map(user => user.id);
        // this.$http.post('/api/users/batch-delete', { userIds })
        //   .then(response => {
        //     this.$message.success('批量删除成功');
        //     this.getUserList();
        //   })
        //   .catch(error => {
        //     console.error('批量删除失败:', error);
        //     this.$message.error('批量删除失败');
        //   });
        
        // 模拟API调用
        setTimeout(() => {
          this.$message.success('批量删除成功');
          this.getUserList();
        }, 300);
      }).catch(() => {
        // 取消操作
      });
    }
  }
};
</script>

<style lang="scss" scoped>
.user-management {
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    
    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
    }
  }
  
  .filter-container {
    margin-bottom: 20px;
    
    .search-form {
      display: flex;
      flex-wrap: wrap;
    }
  }
  
  .list-container {
    margin-bottom: 20px;
  }
  
  .batch-operation {
    margin-top: 15px;
    margin-bottom: 15px;
  }
  
  .pagination-container {
    margin-top: 15px;
    display: flex;
    justify-content: flex-end;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\admin\Users.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\admin\Users.vue
================================================================================

<template>
  <div class="admin-users">
    <div class="page-header">
      <h1 class="page-title">用户管理</h1>
      <el-button type="primary" icon="el-icon-plus" @click="handleCreate">添加用户</el-button>
    </div>
    
    <!-- 搜索过滤 -->
    <el-card shadow="hover" class="filter-container">
      <el-form :inline="true" :model="filterForm" class="demo-form-inline">
        <el-form-item label="用户名">
          <el-input v-model="filterForm.username" placeholder="用户名" clearable></el-input>
        </el-form-item>
        <el-form-item label="邮箱">
          <el-input v-model="filterForm.email" placeholder="邮箱" clearable></el-input>
        </el-form-item>
        <el-form-item label="状态">
          <el-select v-model="filterForm.active" placeholder="状态" clearable>
            <el-option label="激活" :value="true"></el-option>
            <el-option label="禁用" :value="false"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleFilter">查询</el-button>
          <el-button @click="resetFilter">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 用户列表 -->
    <el-card shadow="hover" class="user-list">
      <div slot="header" class="clearfix">
        <span>用户列表</span>
        <el-button style="float: right;" icon="el-icon-refresh" circle @click="fetchUsers"></el-button>
      </div>
      
      <el-table
        :data="tableData"
        style="width: 100%"
        border
        v-loading="loading"
        fit
      >
        <el-table-column
          prop="username"
          label="用户名"
          min-width="120">
        </el-table-column>
        <el-table-column
          prop="email"
          label="邮箱"
          min-width="200">
        </el-table-column>
        <el-table-column
          prop="date_joined"
          label="注册时间"
          min-width="180"
          sortable>
          <template slot-scope="scope">
            {{ formatDateTime(scope.row.date_joined) }}
          </template>
        </el-table-column>
        <el-table-column
          prop="total_detections"
          label="检测次数"
          min-width="100">
        </el-table-column>
        <el-table-column
          prop="is_active"
          label="状态"
          min-width="100">
          <template slot-scope="scope">
            <el-tag :type="scope.row.is_active ? 'success' : 'danger'">
              {{ scope.row.is_active ? '激活' : '禁用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column
          prop="is_staff"
          label="管理员"
          min-width="100">
          <template slot-scope="scope">
            <el-tag v-if="scope.row.is_staff" type="warning">是</el-tag>
            <el-tag v-else type="info">否</el-tag>
          </template>
        </el-table-column>
        <el-table-column
          fixed="right"
          label="操作"
          min-width="220">
          <template slot-scope="scope">
            <el-button
              size="mini"
              @click="handleEdit(scope.row)">编辑</el-button>
            <el-button
              v-if="scope.row.is_active"
              size="mini"
              type="danger"
              @click="handleDeactivate(scope.row)">禁用</el-button>
            <el-button
              v-else
              size="mini"
              type="success"
              @click="handleActivate(scope.row)">激活</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <div class="pagination-container">
        <el-pagination
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page="currentPage"
          :page-sizes="[10, 20, 30, 50]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total">
        </el-pagination>
      </div>
    </el-card>
    
    <!-- 用户编辑/创建对话框 -->
    <el-dialog
      :title="dialogType === 'create' ? '添加用户' : '编辑用户'"
      :visible.sync="dialogVisible"
      width="500px">
      <el-form :model="userForm" :rules="rules" ref="userForm" label-width="100px">
        <el-form-item label="用户名" prop="username">
          <el-input v-model="userForm.username" :disabled="dialogType === 'edit'"></el-input>
        </el-form-item>
        <el-form-item label="邮箱" prop="email">
          <el-input v-model="userForm.email"></el-input>
        </el-form-item>
        <el-form-item label="密码" prop="password" v-if="dialogType === 'create'">
          <el-input v-model="userForm.password" type="password" show-password></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="confirmPassword" v-if="dialogType === 'create'">
          <el-input v-model="userForm.confirmPassword" type="password" show-password></el-input>
        </el-form-item>
        <el-form-item label="名" prop="first_name">
          <el-input v-model="userForm.first_name"></el-input>
        </el-form-item>
        <el-form-item label="姓" prop="last_name">
          <el-input v-model="userForm.last_name"></el-input>
        </el-form-item>
        <el-form-item label="状态">
          <el-switch
            v-model="userForm.is_active"
            active-text="激活"
            inactive-text="禁用">
          </el-switch>
        </el-form-item>
        <el-form-item label="管理员权限">
          <el-switch
            v-model="userForm.is_staff"
            active-text="启用"
            inactive-text="禁用">
          </el-switch>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="submitForm" :loading="submitting">确定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import axios from 'axios'

export default {
  name: 'AdminUsers',
  data() {
    // 自定义验证规则
    const validatePassword = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请输入密码'));
      } else if (value.length < 6) {
        callback(new Error('密码不能少于6个字符'));
      } else {
        if (this.userForm.confirmPassword !== '') {
          this.$refs.userForm.validateField('confirmPassword');
        }
        callback();
      }
    };
    const validateConfirmPassword = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请再次输入密码'));
      } else if (value !== this.userForm.password) {
        callback(new Error('两次输入密码不一致!'));
      } else {
        callback();
      }
    };
    
    return {
      loading: false,
      submitting: false,
      filterForm: {
        username: '',
        email: '',
        active: ''
      },
      tableData: [],
      currentPage: 1,
      pageSize: 10,
      total: 0,
      dialogVisible: false,
      dialogType: 'create', // create or edit
      userForm: {
        id: null,
        username: '',
        email: '',
        password: '',
        confirmPassword: '',
        first_name: '',
        last_name: '',
        is_active: true,
        is_staff: false
      },
      rules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' },
          { min: 3, max: 50, message: '长度在 3 到 50 个字符', trigger: 'blur' }
        ],
        email: [
          { required: true, message: '请输入邮箱地址', trigger: 'blur' },
          { type: 'email', message: '请输入正确的邮箱地址', trigger: 'blur' }
        ],
        password: [
          { required: true, validator: validatePassword, trigger: 'blur' }
        ],
        confirmPassword: [
          { required: true, validator: validateConfirmPassword, trigger: 'blur' }
        ],
        first_name: [
          { required: true, message: '请输入名', trigger: 'blur' }
        ],
        last_name: [
          { required: true, message: '请输入姓', trigger: 'blur' }
        ]
      }
    }
  },
  created() {
    this.fetchUsers();
  },
  methods: {
    // 格式化日期时间
    formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString();
    },
    
    // 获取用户列表
    fetchUsers() {
      this.loading = true;
      
      // 构建查询参数
      const params = {
        page: this.currentPage,
        page_size: this.pageSize
      };
      
      if (this.filterForm.username) {
        params.username = this.filterForm.username;
      }
      
      if (this.filterForm.email) {
        params.email = this.filterForm.email;
      }
      
      if (this.filterForm.active !== '') {
        params.is_active = this.filterForm.active;
      }
      
      axios.get('/users/', { params })
        .then(response => {
          this.tableData = response.data.results;
          this.total = response.data.count;
          this.loading = false;
        })
        .catch(error => {
          console.error('获取用户列表失败:', error);
          this.$message.error('获取用户列表失败');
          this.loading = false;
        });
    },
    
    // 处理筛选
    handleFilter() {
      this.currentPage = 1;
      this.fetchUsers();
    },
    
    // 重置筛选
    resetFilter() {
      this.filterForm = {
        username: '',
        email: '',
        active: ''
      };
      this.currentPage = 1;
      this.fetchUsers();
    },
    
    // 处理页码变化
    handleCurrentChange(val) {
      this.currentPage = val;
      this.fetchUsers();
    },
    
    // 处理每页条数变化
    handleSizeChange(val) {
      this.pageSize = val;
      this.currentPage = 1;
      this.fetchUsers();
    },
    
    // 打开创建用户对话框
    handleCreate() {
      this.dialogType = 'create';
      this.userForm = {
        id: null,
        username: '',
        email: '',
        password: '',
        confirmPassword: '',
        first_name: '',
        last_name: '',
        is_active: true,
        is_staff: false
      };
      this.dialogVisible = true;
      this.$nextTick(() => {
        this.$refs.userForm.clearValidate();
      });
    },
    
    // 打开编辑用户对话框
    handleEdit(row) {
      this.dialogType = 'edit';
      this.userForm = {
        id: row.id,
        username: row.username,
        email: row.email,
        password: '',
        confirmPassword: '',
        first_name: row.first_name || '',
        last_name: row.last_name || '',
        is_active: row.is_active,
        is_staff: row.is_staff
      };
      this.dialogVisible = true;
      this.$nextTick(() => {
        this.$refs.userForm.clearValidate();
      });
    },
    
    // 禁用用户
    handleDeactivate(row) {
      this.$confirm('确定要禁用该用户吗?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        axios.patch(`/users/${row.id}/`, { is_active: false })
          .then(() => {
            this.$message.success('用户已禁用');
            this.fetchUsers();
          })
          .catch(error => {
            console.error('禁用用户失败:', error);
            this.$message.error('禁用用户失败');
          });
      }).catch(() => {});
    },
    
    // 激活用户
    handleActivate(row) {
      axios.patch(`/users/${row.id}/`, { is_active: true })
        .then(() => {
          this.$message.success('用户已激活');
          this.fetchUsers();
        })
        .catch(error => {
          console.error('激活用户失败:', error);
          this.$message.error('激活用户失败');
        });
    },
    
    // 提交表单
    submitForm() {
      this.$refs.userForm.validate(valid => {
        if (valid) {
          this.submitting = true;
          
          const formData = {
            username: this.userForm.username,
            email: this.userForm.email,
            first_name: this.userForm.first_name,
            last_name: this.userForm.last_name,
            is_active: this.userForm.is_active,
            is_staff: this.userForm.is_staff
          };
          
          if (this.dialogType === 'create') {
            formData.password = this.userForm.password;
            formData.password2 = this.userForm.confirmPassword;
            
            axios.post('/users/', formData)
              .then(() => {
                this.$message.success('用户创建成功');
                this.dialogVisible = false;
                this.fetchUsers();
                this.submitting = false;
              })
              .catch(error => {
                console.error('创建用户失败:', error.response || error);
                let errorMessage = '创建用户失败';
                if (error.response && error.response.data) {
                  const errors = error.response.data;
                  const errorDetails = [];
                  if (typeof errors === 'object' && errors !== null) {
                    for (const field in errors) {
                      if (Array.isArray(errors[field])) {
                        if (field === 'password') {
                          const processedErrors = errors[field].map(err => {
                            if (err.includes('too short')) return '密码太短 (至少8字符)';
                            if (err.includes('too common')) return '密码太常见';
                            if (err.includes('entirely numeric')) return '密码不能全是数字';
                            return err;
                          });
                          errorDetails.push(`密码: ${processedErrors.join(', ')}`);
                        } else {
                          errorDetails.push(`${field}: ${errors[field].join(', ')}`);
                        }
                      } else {
                         errorDetails.push(`${field}: ${errors[field]}`);
                      }
                    }
                    if (errorDetails.length > 0) {
                       errorMessage += ': ' + errorDetails.join('; ');
                    } else if (errors.detail) {
                       errorMessage += ': ' + errors.detail;
                    }
                  } else if (typeof errors === 'string') {
                     errorMessage += ': ' + errors;
                  }
                } else if (error.message) {
                   errorMessage += ': ' + error.message;
                }
                this.$message.error(errorMessage);
                this.submitting = false;
              });
          } else {
            axios.patch(`/users/${this.userForm.id}/`, formData)
              .then(() => {
                this.$message.success('用户更新成功');
                this.dialogVisible = false;
                this.fetchUsers();
                this.submitting = false;
              })
              .catch(error => {
                console.error('更新用户失败:', error);
                this.$message.error('更新用户失败: ' + (error.response?.data?.detail || '未知错误'));
                this.submitting = false;
              });
          }
        }
      });
    }
  }
}
</script>

<style scoped>
.admin-users {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-title {
  font-size: 24px;
  margin: 0;
}

.filter-container {
  margin-bottom: 20px;
  padding: 15px;
}

.user-list {
  margin-bottom: 20px;
  width: 100%;
}

.pagination-container {
  margin-top: 20px;
  text-align: right;
}

/* 添加表格样式 */
/deep/ .el-table {
  width: 100%;
}

/deep/ .el-table__body {
  width: 100%;
}

/deep/ .el-table .cell {
  padding-left: 10px;
  padding-right: 10px;
}
</style> 

================================================================================
文件路径: frontend\src\views\dashboard\Dashboard.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\dashboard\Dashboard.vue
================================================================================

<template>
  <div class="dashboard-container">
    <div class="page-title">仪表盘</div>
    
    <el-row :gutter="20">
      <el-col :span="6">
        <el-card shadow="hover" class="dashboard-card">
          <div class="card-content">
            <div class="card-icon">
              <i class="el-icon-s-data"></i>
            </div>
            <div class="card-info">
              <div class="card-title">检测总数</div>
              <div class="card-value">{{ stats.total_count }}</div>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card shadow="hover" class="dashboard-card">
          <div class="card-content">
            <div class="card-icon real">
              <i class="el-icon-check"></i>
            </div>
            <div class="card-info">
              <div class="card-title">真实新闻</div>
              <div class="card-value">{{ stats.real_count }} ({{ stats.real_percentage.toFixed(2) }}%)</div>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card shadow="hover" class="dashboard-card">
          <div class="card-content">
            <div class="card-icon fake">
              <i class="el-icon-close"></i>
            </div>
            <div class="card-info">
              <div class="card-title">虚假新闻</div>
              <div class="card-value">{{ stats.fake_count }} ({{ stats.fake_percentage.toFixed(2) }}%)</div>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card shadow="hover" class="dashboard-card">
          <div class="card-content">
            <div class="card-icon pending">
              <i class="el-icon-loading"></i>
            </div>
            <div class="card-info">
              <div class="card-title">待处理</div>
              <div class="card-value">{{ stats.pending_count }}</div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <el-row :gutter="20" class="chart-row">
      <el-col :span="12">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>检测结果分布</span>
          </div>
          <div class="chart-container" ref="pieChart"></div>
        </el-card>
      </el-col>
      
      <el-col :span="12">
        <el-card shadow="hover" class="chart-card">
          <div slot="header" class="clearfix">
            <span>近期检测统计</span>
          </div>
          <div class="chart-container" ref="lineChart"></div>
        </el-card>
      </el-col>
    </el-row>
    
    <el-row :gutter="20">
      <el-col :span="24">
        <el-card shadow="hover">
          <div slot="header" class="clearfix">
            <span>最近检测</span>
            <el-button style="float: right; padding: 3px 0" type="text" @click="viewMore">查看更多</el-button>
          </div>
          
          <el-table
            :data="recentDetections"
            style="width: 100%"
            v-loading="loading"
            border
            fit
          >
            <el-table-column
              prop="title"
              label="标题"
              min-width="300"
            ></el-table-column>
            <el-table-column
              prop="created_at"
              label="检测时间"
              width="180"
            >
              <template slot-scope="scope">
                {{ formatDate(scope.row.created_at) }}
              </template>
            </el-table-column>
            <el-table-column
              prop="status"
              label="状态"
              width="100"
            >
              <template slot-scope="scope">
                <el-tag :type="getStatusType(scope.row.status)">{{ getStatusText(scope.row.status) }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column
              prop="result"
              label="结果"
              width="90"
            >
              <template slot-scope="scope">
                <el-tag v-if="scope.row.status === 'completed' && scope.row.result"
                        :type="getResultTagType(scope.row.result)">
                  {{ getResultText(scope.row.result) }}
                </el-tag>
                <span v-else-if="scope.row.status === 'completed'">未知</span>
                <span v-else>-</span>
              </template>
            </el-table-column>
            <el-table-column
              prop="confidence"
              label="置信度"
              width="100"
            >
              <template slot-scope="scope">
                <div v-if="scope.row.status === 'completed' && scope.row.confidence_score != null && scope.row.result !== 'unknown'">{{ (scope.row.confidence_score * 100).toFixed(2) }}%</div>
                <span v-else>-</span>
              </template>
            </el-table-column>
            <el-table-column
              fixed="right"
              label="操作"
              width="120"
            >
              <template slot-scope="scope">
                <el-button
                  @click="viewDetail(scope.row.id)"
                  type="text"
                  size="small">
                  查看详情
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'
import * as echarts from 'echarts'

export default {
  name: 'DashboardView',
  data() {
    return {
      loading: false,
      recentDetections: [],
      pieChart: null,
      lineChart: null
    }
  },
  computed: {
    ...mapGetters(['detectionStats']),
    stats() {
      const statsData = this.detectionStats || {
        total_count: 0,
        fake_count: 0,
        real_count: 0,
        pending_count: 0,
        completed_count: 0,
        failed_count: 0,
        fake_percentage: 0,
        real_percentage: 0,
        average_confidence: 0
      };
      statsData.fake_percentage = Number(statsData.fake_percentage) || 0;
      statsData.real_percentage = Number(statsData.real_percentage) || 0;
      return statsData;
    }
  },
  watch: {
    stats(newStats) {
      if (newStats) {
        this.initPieChart();
      }
    },
    recentDetections(newDetections) {
      if (newDetections && newDetections.length > 0) {
         this.initLineChart();
      }
    }
  },
  mounted() {
    this.fetchData()
    window.addEventListener('resize', this.handleResize);
  },
  beforeDestroy() {
    window.removeEventListener('resize', this.handleResize);
    if (this.pieChart) {
      this.pieChart.dispose();
      this.pieChart = null;
    }
    if (this.lineChart) {
      this.lineChart.dispose();
      this.lineChart = null;
    }
  },
  methods: {
    fetchData() {
      this.loading = true
      let statsLoaded = false;
      let historyLoaded = false;

      const checkAndInitCharts = () => {
        if (statsLoaded && historyLoaded) {
          this.$nextTick(() => {
             this.initPieChart();
             this.initLineChart();
          });
          this.loading = false;
        }
      };

      this.$store.dispatch('detection/getDetectionStats')
        .then(() => { statsLoaded = true; checkAndInitCharts(); })
        .catch(error => {
          console.error('获取统计数据失败:', error)
          this.$message.error('获取统计数据失败，请稍后重试')
          statsLoaded = true;
          checkAndInitCharts();
        });
      
      this.$store.dispatch('detection/getDetectionHistory')
        .then(detections => {
          this.recentDetections = detections.slice(0, 7);
          historyLoaded = true;
          checkAndInitCharts();
        })
        .catch(error => {
          console.error('获取检测历史失败:', error)
          this.$message.error('获取检测历史失败，请稍后重试')
          historyLoaded = true;
          checkAndInitCharts();
        });
    },
    
    initPieChart() {
      if (!this.$refs.pieChart) return;
      if (this.pieChart) {
        this.pieChart.dispose();
      }
      this.pieChart = echarts.init(this.$refs.pieChart);
      
      // 准备饼图数据
      const pieData = [];
      
      // 添加真实新闻数据
      if (this.stats.real_count > 0) {
        pieData.push({ 
          value: this.stats.real_count, 
          name: '真实新闻', 
          itemStyle: { color: '#67C23A' } 
        });
      }
      
      // 添加虚假新闻数据
      if (this.stats.fake_count > 0) {
        pieData.push({ 
          value: this.stats.fake_count, 
          name: '虚假新闻', 
          itemStyle: { color: '#F56C6C' } 
        });
      }
      
      // 添加其他类型的数据
      const otherCount = this.stats.completed_count - this.stats.real_count - this.stats.fake_count;
      if (otherCount > 0) {
        pieData.push({ 
          value: otherCount, 
          name: '其他类型', 
          itemStyle: { color: '#909399' } 
        });
      }
      
      const option = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
          orient: 'vertical',
          left: 10,
          data: pieData.map(item => item.name)
        },
        series: [
          {
            name: '检测结果',
            type: 'pie',
            radius: ['50%', '70%'],
            avoidLabelOverlap: false,
            label: {
              show: false,
              position: 'center'
            },
            emphasis: {
              label: {
                show: true,
                fontSize: '20',
                fontWeight: 'bold'
              }
            },
            labelLine: {
              show: false
            },
            data: pieData
          }
        ]
      };
      this.pieChart.setOption(option);
    },
    
    initLineChart() {
      if (!this.$refs.lineChart || !this.recentDetections || this.recentDetections.length === 0) return;
      if (this.lineChart) {
        this.lineChart.dispose();
      }
      this.lineChart = echarts.init(this.$refs.lineChart);
      
      const countsByDate = this.recentDetections.reduce((acc, detection) => {
        const date = this.formatDate(detection.created_at, true);
        acc[date] = (acc[date] || 0) + 1;
        return acc;
      }, {});
      
      const dates = Object.keys(countsByDate).sort();
      const counts = dates.map(date => countsByDate[date]);
      
      const option = {
        tooltip: {
          trigger: 'axis'
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: dates
        },
        yAxis: {
          type: 'value',
           minInterval: 1
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        series: [
          {
            name: '检测数量',
            type: 'line',
            smooth: true,
            data: counts,
            itemStyle: { color: '#409EFF' },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    {
                        offset: 0,
                        color: 'rgba(64, 158, 255, 0.3)'
                    },
                    {
                        offset: 1,
                        color: 'rgba(64, 158, 255, 0)'
                    }
                ])
            }
          }
        ]
      };
      this.lineChart.setOption(option);
    },
    
    handleResize() {
      if (this.pieChart) {
        this.pieChart.resize();
      }
      if (this.lineChart) {
        this.lineChart.resize();
      }
    },

    formatDate(dateString, dateOnly = false) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      if (dateOnly) {
          return `${year}-${month}-${day}`;
      }
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`
    },
    
    getStatusType(status) {
      switch (status) {
        case 'completed': return 'success'
        case 'pending': return 'info'
        case 'processing': return 'warning'
        case 'failed': return 'danger'
        default: return 'info'
      }
    },
    
    getStatusText(status) {
      switch (status) {
        case 'completed': return '完成'
        case 'pending': return '等待中'
        case 'processing': return '处理中'
        case 'failed': return '失败'
        default: return '未知'
      }
    },
    
    viewDetail(id) {
      this.$router.push(`/dashboard/detection/detail/${id}`)
    },
    
    viewMore() {
      this.$router.push('/dashboard/detection/history')
    },

    getResultTagType(result) {
      if (result === 'fake') return 'danger';
      if (result === 'real') return 'success';
      if (result === 'uncertain') return 'warning';
      if (result === 'mixed') return 'warning';
      return 'info';
    },

    getResultText(result) {
      if (result === 'fake') return '虚假';
      if (result === 'real') return '真实';
      if (result === 'uncertain') return '不确定';
      if (result === 'mixed') return '混合';
      return result || '未知';
    },
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.dashboard-container {
  padding: 20px;
  height: calc(100vh - 84px);
  overflow-y: auto;
}

.dashboard-card {
  height: 120px;
  
  .card-content {
    display: flex;
    align-items: center;
    height: 100%;
  }
  
  .card-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: $primary-color;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 20px;
    
    i {
      font-size: 30px;
      color: white;
    }
    
    &.real {
      background-color: $success-color;
    }
    
    &.fake {
      background-color: $danger-color;
    }
    
    &.pending {
      background-color: $warning-color;
    }
  }
  
  .card-info {
    display: flex;
    flex-direction: column;
    
    .card-title {
      font-size: 14px;
      color: $regular-font-color;
      margin-bottom: 10px;
    }
    
    .card-value {
      font-size: 24px;
      font-weight: bold;
      color: $main-font-color;
    }
  }
}

.chart-row {
  margin-top: 20px;
  margin-bottom: 20px;
}

.chart-card {
  height: 400px;
  
  .chart-container {
    height: 320px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #909399;
    font-size: 16px;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\detection\Create.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\detection\Create.vue
================================================================================

<template>
  <div class="detection-create-container">
    <div class="page-title">新闻检测</div>
    
    <el-row :gutter="20">
      <el-col :span="16">
        <el-card shadow="hover" class="detection-card">
          <div slot="header" class="clearfix">
            <span>输入新闻信息</span>
            <el-button 
              style="float: right; padding: 3px 0;" 
              type="text" 
              @click="resetForm"
            >
              清空表单
            </el-button>
          </div>
          
          <el-form 
            ref="detectionForm" 
            :model="detectionForm" 
            :rules="rules" 
            label-position="top"
          >
            <el-form-item label="新闻标题" prop="title">
              <el-input v-model="detectionForm.title" placeholder="输入新闻标题"></el-input>
            </el-form-item>
            
            <el-form-item label="新闻内容" prop="content">
              <el-input 
                type="textarea" 
                v-model="detectionForm.content" 
                placeholder="输入新闻内容" 
                :rows="8"
              ></el-input>
            </el-form-item>
            
            <el-form-item label="新闻图片" prop="image">
              <el-upload
                class="upload-demo"
                drag
                action="#"
                :auto-upload="false"
                :on-change="handleImageChange"
                :limit="1"
                :file-list="fileList"
              >
                <i class="el-icon-upload"></i>
                <div class="el-upload__text">拖拽图片到此处，或<em>点击上传</em></div>
                <div class="el-upload__tip" slot="tip">只能上传jpg/png/jpeg文件，且不超过10MB</div>
              </el-upload>
            </el-form-item>
            
            <el-form-item>
              <el-button type="primary" @click="submitForm" :loading="loading">开始检测</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </el-col>
      
      <el-col :span="8">
        <el-card shadow="hover" class="info-card">
          <div slot="header" class="clearfix">
            <span>检测说明</span>
          </div>
          <div class="info-content">
            <p>本系统支持多模态虚假新闻检测，结合文本内容与图像分析，提供更准确的检测结果。</p>
            <h4>使用须知：</h4>
            <ul>
              <li>新闻标题和内容均为必填项</li>
              <li>图片可选（提供图片将启用多模态检测）</li>
              <li>支持JPG、JPEG、PNG格式图片</li>
              <li>检测历史可在"检测历史"页面查看</li>
            </ul>
            <h4>检测流程：</h4>
            <ol>
              <li>输入新闻内容</li>
              <li>上传相关图片（可选）</li>
              <li>点击"开始检测"按钮</li>
              <li>系统分析并返回结果</li>
            </ol>
          </div>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import axios from 'axios'

export default {
  name: 'DetectionCreate',
  data() {
    return {
      detectionForm: {
        title: '',
        content: '',
        image: null
      },
      rules: {
        title: [
          { required: true, message: '请输入新闻标题', trigger: 'blur' },
          { min: 2, max: 100, message: '标题长度在2到100个字符之间', trigger: 'blur' }
        ],
        content: [
          { required: true, message: '请输入新闻内容', trigger: 'blur' },
          { min: 10, message: '内容不能少于10个字符', trigger: 'blur' }
        ]
      },
      fileList: [],
      loading: false
    }
  },
  methods: {
    handleImageChange(file) {
      // 上传前校验文件类型和大小
      const isImage = file.raw.type.includes('image/')
      const isLt10M = file.raw.size / 1024 / 1024 < 10
      
      if (!isImage) {
        this.$message.error('上传文件只能是图片格式!')
        this.fileList = []
        return false
      }
      
      if (!isLt10M) {
        this.$message.error('上传图片大小不能超过 10MB!')
        this.fileList = []
        return false
      }
      
      // 设置当前图片
      this.detectionForm.image = file.raw
      this.fileList = [file]
    },
    
    submitForm() {
      this.$refs.detectionForm.validate(valid => {
        if (valid) {
          this.loading = true
          
          const formData = new FormData();
          formData.append('title', this.detectionForm.title);
          formData.append('content', this.detectionForm.content);
          
          if (this.detectionForm.image) {
            formData.append('image', this.detectionForm.image);
          }
          
          axios.post('/detection/detections/', formData, {
            headers: {
              'Content-Type': 'multipart/form-data'
            }
          })
            .then(response => {
              this.$message.success('检测任务已提交')
              // 修正：跳转到包含父路径的完整路由
              this.$router.push(`/dashboard/detection/detail/${response.data.id}`)
            })
            .catch(error => {
              console.error('检测提交失败:', error)
              this.$message.error('检测提交失败: ' + (error.response?.data?.detail || '请稍后重试'))
            })
            .finally(() => {
              this.loading = false
            })
        } else {
          return false
        }
      })
    },
    
    resetForm() {
      this.$refs.detectionForm.resetFields()
      this.fileList = []
      this.detectionForm.image = null
    }
  }
}
</script>

<style scoped>
.detection-create-container {
  padding: 20px;
}

.detection-card {
  margin-bottom: 20px;
}

.info-card {
  margin-bottom: 20px;
}

.info-content {
  font-size: 14px;
  color: #606266;
  line-height: 1.6;
}

.info-content h4 {
  margin-top: 16px;
  margin-bottom: 8px;
  color: #303133;
}

.info-content ul, .info-content ol {
  padding-left: 20px;
  margin-bottom: 16px;
}

.info-content li {
  margin-bottom: 5px;
}
</style> 

================================================================================
文件路径: frontend\src\views\detection\Detail.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\detection\Detail.vue
================================================================================

<template>
  <div class="detail-container">
    <div class="page-header">
      <el-page-header @back="goBack" :content="detection ? detection.title : '检测详情'"></el-page-header>
    </div>
    
    <div v-loading="loading">
      <el-row :gutter="20" v-if="detection">
        <el-col :span="16">
          <el-card class="detection-card">
            <div slot="header" class="clearfix">
              <span>新闻内容</span>
              <el-tag :type="getResultType" class="result-tag">{{ getResultText }}</el-tag>
            </div>
            
            <div class="detection-header">
              <h2>{{ detection.title }}</h2>
              <div class="detection-meta">
                <span>检测时间: {{ formatDate(detection.created_at) }}</span>
                <el-tag size="small" :type="getStatusType(detection.status)">{{ getStatusText(detection.status) }}</el-tag>
              </div>
            </div>
            
            <div class="detection-content">
              <div v-if="detection.image" class="detection-image">
                <el-image 
                  :src="detection.image" 
                  fit="cover"
                  :preview-src-list="[detection.image]">
                </el-image>
              </div>
              
              <div class="news-content">
                <p>{{ detection.content }}</p>
              </div>
            </div>

            <!-- LLM交叉验证结果 -->
            <div class="llm-results-section" v-if="detection.status === 'completed' && llmIndividualResults.length > 0">
              <el-divider content-position="left">LLM 交叉验证结果</el-divider>
              <el-table :data="llmIndividualResults" size="medium" border stripe style="width: 100%">
                <el-table-column prop="model" label="模型" width="160" show-overflow-tooltip></el-table-column>
                <el-table-column prop="verdict" label="判断" width="90" align="center">
                  <template slot-scope="scope">
                    <el-tag :type="getLlmVerdictType(scope.row.verdict)" size="small">{{ scope.row.verdict }}</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="confidence" label="置信度" width="80" align="center">
                  <template slot-scope="scope">
                    <span v-if="scope.row.confidence">{{ (scope.row.confidence * 100).toFixed(1) }}%</span>
                    <span v-else>-</span>
                  </template>
                </el-table-column>
                <el-table-column prop="reason" label="理由" show-overflow-tooltip></el-table-column>
                <el-table-column prop="error" label="错误" width="100" show-overflow-tooltip></el-table-column>
              </el-table>
            </div>
          </el-card>
        </el-col>
        
        <el-col :span="8">
          <el-card class="result-card" v-if="detection.status === 'completed'">
            <div slot="header" class="clearfix">
              <span>检测结果</span>
            </div>
            
            <div class="result-info">
              <div class="result-item">
                <div class="result-label">最终结论</div>
                <div class="result-value">
                  <el-tag :type="getResultType" size="medium">{{ getResultText }}</el-tag>
                </div>
              </div>
              
              <div class="result-item">
                <div class="result-label">最终置信度</div>
                <div class="result-value">
                  <el-progress 
                    v-if="getResultType !== 'info'"
                    :percentage="getConfidenceValue" 
                    :color="getResultType === 'danger' ? '#F56C6C' : '#67C23A'">
                  </el-progress>
                  <span v-else>不适用</span>
                </div>
              </div>

              <el-collapse v-model="activeAnalysisSections" v-if="detection.analysis_result">
                <el-collapse-item title="详细分析过程" name="details">
                  <div class="analysis-section" v-if="analysisDetails.fusion">
                    <h4><i class="el-icon-connection"></i> 融合策略</h4>
                    <p>策略: {{ analysisDetails.fusion.strategy || '未知' }}</p>
                    <p v-if="analysisDetails.fusion.final_verdict !== 'unknown'">
                      置信度: {{ (analysisDetails.fusion.final_confidence * 100).toFixed(2) }}%
                    </p>
                  </div>

                  <div class="analysis-section" v-if="analysisDetails.local_model">
                    <h4><i class="el-icon-cpu"></i> 本地模型概要</h4>
                    <p>结果: 
                      <el-tag 
                        :type="getVerdictType(analysisDetails.local_model.result)" 
                        size="small"
                      >
                        {{ getVerdictText(analysisDetails.local_model.result) }}
                      </el-tag>
                    </p>
                    <p v-if="analysisDetails.local_model.result !== 'unknown'">置信度: {{ (analysisDetails.local_model.confidence * 100).toFixed(2) }}%</p>
                    <p v-if="analysisDetails.local_model.error">错误: {{ analysisDetails.local_model.error }}</p>
                  </div>

                  <div class="analysis-section" v-if="analysisDetails.llm_verification">
                    <h4><i class="el-icon-chat-dot-round"></i> LLM 交叉验证</h4>
                    <p>综合判断: 
                       <el-tag 
                         :type="getLlmVerdictType(analysisDetails.llm_verification.overall_verdict)" 
                         size="small"
                       >
                         {{ analysisDetails.llm_verification.overall_verdict || '未知' }}
                       </el-tag>
                    </p>
                    <p>综合置信度: {{ (analysisDetails.llm_verification.aggregated_confidence * 100).toFixed(2) }}%</p>
                    <p v-if="analysisDetails.llm_verification.needs_manual_review" style="color: orange;"><i class="el-icon-warning-outline"></i> 需要人工审核</p>
                    <p v-if="analysisDetails.llm_verification.error">错误: {{ analysisDetails.llm_verification.error }}</p>
                  </div>
                </el-collapse-item>
              </el-collapse>
            </div>
          </el-card>
          
          <el-card class="waiting-card" v-else-if="detection.status === 'pending' || detection.status === 'processing'">
            <div slot="header" class="clearfix">
              <span>检测中</span>
            </div>
            
            <div class="waiting-content">
              <i class="el-icon-loading"></i>
              <p>检测任务{{ detection.status === 'pending' ? '等待中' : '处理中' }}，请稍候...</p>
              <el-button type="primary" size="small" @click="refreshResult">刷新结果</el-button>
            </div>
          </el-card>
          
          <el-card class="error-card" v-else-if="detection.status === 'failed'">
            <div slot="header" class="clearfix">
              <span>检测失败</span>
            </div>
            
            <div class="error-content">
              <i class="el-icon-circle-close"></i>
              <p>很抱歉，检测任务处理失败。</p>
              <div v-if="detection.error_message" class="error-message">
                错误信息: {{ detection.error_message }}
              </div>
              <el-button type="primary" size="small" @click="retryDetection">重新检测</el-button>
            </div>
          </el-card>
        </el-col>
      </el-row>
      
      <div v-else class="empty-state">
        <i class="el-icon-warning-outline"></i>
        <p>未找到检测数据或加载失败</p>
        <el-button type="primary" @click="goToHistory">返回历史记录</el-button>
      </div>
    </div>
  </div>
</template>

<script>
import axios from 'axios';

export default {
  name: 'DetectionDetail',
  data() {
    return {
      loading: true,
      detectionId: null,
      pollingInterval: null,
      pollingDelay: 5000,
      activeAnalysisSections: ['details']
    }
  },
  computed: {
    detection() {
      const det = this.$store.getters.currentDetection;
      if (det && (det.status === 'completed' || det.status === 'failed')) {
        this.stopPolling();
      }
      return det;
    },
    getResultType() {
      // 读取融合结果
      const verdict = this.analysisDetails.fusion?.final_verdict;
      if (!verdict) return 'info';
      if (verdict === 'real') return 'success';
      if (verdict === 'fake') return 'danger';
      return 'info'; // 对于unknown和其他未预期的值，都返回info
    },
    getResultText() {
      // 读取融合结果
      const verdict = this.analysisDetails.fusion?.final_verdict;
      if (!verdict) return '未知';
      if (verdict === 'real') return '真实新闻';
      if (verdict === 'fake') return '虚假新闻';
      return '未能确定'; // 更明确的未知状态文本
    },
    getConfidenceValue() {
      // 读取融合结果
      const confidence = this.analysisDetails.fusion?.final_confidence;
      const verdict = this.analysisDetails.fusion?.final_verdict;
      if (confidence === null || confidence === undefined || verdict === 'unknown') return 0;
      // 确保置信度在0-100之间
      return Math.min(100, Math.max(0, Math.round(confidence * 100)));
    },
    isProcessing() {
      return this.detection && (this.detection.status === 'pending' || this.detection.status === 'processing');
    },
    analysisDetails() {
      if (this.detection && this.detection.analysis_result) {
        if (typeof this.detection.analysis_result === 'string') {
          try {
            return JSON.parse(this.detection.analysis_result);
          } catch (e) {
            console.error("Failed to parse analysis_result JSON:", e);
            return {};
          }
        } else {
          return this.detection.analysis_result;
        }
      } 
      return {};
    },
    llmIndividualResults() {
       if (this.analysisDetails && this.analysisDetails.llm_verification && this.analysisDetails.llm_verification.details) {
         const details = this.analysisDetails.llm_verification.details;
         const textResults = details.text_verifications || [];
         const imgResults = details.image_verifications || [];
         return [...textResults, ...imgResults];
       }
       return [];
    }
  },
  created() {
    this.detectionId = this.$route.params.id
    this.fetchDetailAndPoll();
  },
  beforeDestroy() {
    this.stopPolling();
  },
  methods: {
    fetchDetailAndPoll() {
      this.loading = true;
      this.$store.dispatch('detection/getDetectionDetail', this.detectionId)
        .then(() => {
          this.loading = false;
          if (this.isProcessing) {
            this.startPolling();
          }
        })
        .catch(error => {
          this.loading = false;
          console.error('获取检测详情失败:', error);
          this.$message.error('获取检测详情失败，请稍后重试');
        });
    },

    startPolling() {
      this.stopPolling();
      logger.info('开始轮询检测结果...');
      this.pollingInterval = setInterval(() => {
        if (!this.isProcessing) {
          this.stopPolling();
          return;
        }
        logger.debug(`轮询检测结果 ID: ${this.detectionId}`);
        this.$store.dispatch('detection/getDetectionDetail', this.detectionId)
          .catch(error => {
            console.error('轮询失败:', error);
          });
      }, this.pollingDelay);
    },

    stopPolling() {
      if (this.pollingInterval) {
        logger.info('停止轮询检测结果。');
        clearInterval(this.pollingInterval);
        this.pollingInterval = null;
      }
    },

    formatDate(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`
    },
    
    getStatusType(status) {
      switch (status) {
        case 'completed': return 'success'
        case 'pending': return 'info'
        case 'processing': return 'warning'
        case 'failed': return 'danger'
        default: return 'info'
      }
    },
    
    getStatusText(status) {
      switch (status) {
        case 'completed': return '完成'
        case 'pending': return '等待中'
        case 'processing': return '处理中'
        case 'failed': return '失败'
        default: return '未知'
      }
    },
    
    goBack() {
      this.$router.go(-1)
    },
    
    goToHistory() {
      this.$router.push('/dashboard/detection/history')
    },
    
    refreshResult() {
      this.fetchDetailAndPoll();
      this.$message.info('正在刷新结果...');
    },
    
    retryDetection() {
      this.stopPolling();
      const data = {
        title: this.detection.title,
        content: this.detection.content,
        image: this.detection.original_image
      }
      
      this.$store.dispatch('detection/createDetection', data)
        .then(response => {
          this.$message.success('已重新提交检测任务')
          this.$router.push(`/detection/detail/${response.id}`)
        })
        .catch(error => {
          console.error('重新检测失败:', error)
          this.$message.error('重新检测失败: ' + (error.response?.data?.detail || '请稍后重试'))
        })
    },

    getVerdictType(result) {
      if (result === 'fake') return 'danger';
      if (result === 'real') return 'success';
      return 'info';
    },
    getVerdictText(result) {
      if (result === 'fake') return '虚假';
      if (result === 'real') return '真实';
      return '未知';
    },
    getLlmVerdictType(verdict) {
      if (!verdict) return 'info';
      const lowerVerdict = verdict.toLowerCase();
      if (lowerVerdict.includes('fake') || lowerVerdict.includes('虚假') || lowerVerdict.includes('伪造')) return 'danger';
      if (lowerVerdict.includes('true') || lowerVerdict.includes('真实')) return 'success';
      if (lowerVerdict.includes('uncertain') || lowerVerdict.includes('无法') || lowerVerdict.includes('混合')) return 'warning';
      return 'info';
    },
    fetchDetailData() {
      this.loading = true;
      
      axios.get(`/detection/detections/${this.$route.params.id}/`)
        .then(response => {
          this.detailData = response.data;
          this.loading = false;
        })
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.detail-container {
  padding: 20px;
}

.page-header {
  margin-bottom: 20px;
}

.detection-card, .result-card, .waiting-card, .error-card {
  margin-bottom: 20px;
}

.detection-header {
  margin-bottom: 20px;
  
  h2 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.5rem;
  }
  
  .detection-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #888;
    font-size: 0.9rem;
  }
}

.detection-content {
  .detection-image {
    margin-bottom: 20px;
    text-align: center;
    
    img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 4px;
    }
  }
  
  .news-content {
    line-height: 1.6;
    color: #333;
    word-break: break-word;
  }
}

.llm-results-section {
  margin-top: 20px;
  
  .el-divider__text {
    font-weight: bold;
    color: #409EFF;
  }
  
  .el-table {
    margin-top: 15px;
    
    .el-table__row {
      font-size: 0.9rem;
    }
  }
}

.result-info {
  .result-item {
    margin-bottom: 20px;
    
    .result-label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }
    
    .result-value {
      font-size: 1.1rem;
    }
  }
}

.analysis-section {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px dashed #eee;
  
  &:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  
  h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #333;
    
    i {
      margin-right: 5px;
      color: #409EFF;
    }
  }
  
  p {
    margin: 5px 0;
    line-height: 1.5;
  }
}

.waiting-content, .error-content {
  text-align: center;
  padding: 20px 0;
  
  i {
    font-size: 36px;
    margin-bottom: 15px;
    display: block;
  }
  
  p {
    margin-bottom: 20px;
  }
}

.waiting-content {
  i {
    color: #E6A23C;
  }
}

.error-content {
  i {
    color: #F56C6C;
  }
  
  .error-message {
    background: #FEF0F0;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    color: #F56C6C;
    text-align: left;
  }
}

.empty-state {
  text-align: center;
  padding: 50px 0;
  
  i {
    font-size: 48px;
    color: #909399;
    margin-bottom: 20px;
  }
  
  p {
    margin-bottom: 20px;
    color: #909399;
  }
}

.result-tag {
  float: right;
}
</style> 
</style> 
</style> 

================================================================================
文件路径: frontend\src\views\detection\History.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\detection\History.vue
================================================================================

<template>
  <div class="history-container">
    <div class="page-title">检测历史</div>
    
    <el-card shadow="hover">
      <div class="filter-container">
        <el-input
          placeholder="搜索标题"
          v-model="searchQuery"
          style="width: 200px;"
          clearable
          @clear="handleFilter"
          @keyup.enter.native="handleFilter"
        >
          <i slot="prefix" class="el-input__icon el-icon-search"></i>
        </el-input>
        
        <el-select v-model="statusFilter" placeholder="状态" clearable style="width: 120px;" @change="handleFilter">
          <el-option
            v-for="item in statusOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value">
          </el-option>
        </el-select>
        
        <el-select v-model="resultFilter" placeholder="结果" clearable style="width: 120px;" @change="handleFilter">
          <el-option
            v-for="item in resultOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value">
          </el-option>
        </el-select>
        
        <el-date-picker
          v-model="dateRange"
          type="daterange"
          range-separator="至"
          start-placeholder="开始日期"
          end-placeholder="结束日期"
          style="width: 300px;"
          @change="handleFilter"
        >
        </el-date-picker>
        
        <el-button class="filter-item" type="primary" icon="el-icon-search" @click="handleFilter">
          搜索
        </el-button>
      </div>
      
      <el-table
        :data="filteredDetections"
        style="width: 100%; margin-top: 20px;"
        v-loading="loading"
        border
      >
        <el-table-column
          prop="title"
          label="标题"
          min-width="200"
        ></el-table-column>
        <el-table-column
          prop="created_at"
          label="检测时间"
          width="180"
        >
          <template slot-scope="scope">
            {{ formatDate(scope.row.created_at) }}
          </template>
        </el-table-column>
        <el-table-column
          prop="status"
          label="状态"
          width="100"
        >
          <template slot-scope="scope">
            <el-tag :type="getStatusType(scope.row.status)">{{ getStatusText(scope.row.status) }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column
          prop="result"
          label="结果"
          width="100"
        >
          <template slot-scope="scope">
            <el-tag v-if="scope.row.result != null" :type="scope.row.result === 'real' ? 'success' : (scope.row.result === 'fake' ? 'danger' : 'info')">
              {{ scope.row.result === 'real' ? '真实' : (scope.row.result === 'fake' ? '虚假' : '未知') }}
            </el-tag>
            <span v-else>-</span>
          </template>
        </el-table-column>
        <el-table-column
          prop="confidence_score"
          label="置信度"
          width="100"
        >
          <template slot-scope="scope">
            <div v-if="scope.row.confidence_score != null">{{ (scope.row.confidence_score * 100).toFixed(2) }}%</div>
            <span v-else>-</span>
          </template>
        </el-table-column>
        <el-table-column
          fixed="right"
          label="操作"
          width="180">
          <template slot-scope="scope">
            <el-button
              @click="viewDetail(scope.row.id)"
              type="text"
              size="small">
              查看详情
            </el-button>
            <el-button
              @click="handleDelete(scope.row)"
              type="text"
              size="small"
              style="color: #F56C6C;">
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <div class="pagination-container">
        <el-pagination
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page="currentPage"
          :page-sizes="[10, 20, 30, 50]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="totalItems">
        </el-pagination>
      </div>
    </el-card>

    <el-dialog
      title="确认删除"
      :visible.sync="deleteDialogVisible"
      width="30%">
      <span>确定要删除这条检测记录吗？此操作不可恢复。</span>
      <span slot="footer" class="dialog-footer">
        <el-button @click="deleteDialogVisible = false">取消</el-button>
        <el-button type="danger" @click="confirmDelete" :loading="deleteLoading">确定删除</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
import axios from 'axios'
import { deleteDetection } from '@/api/detection'

export default {
  name: 'DetectionHistory',
  data() {
    return {
      loading: false,
      searchQuery: '',
      statusFilter: '',
      resultFilter: '',
      dateRange: [],
      currentPage: 1,
      pageSize: 10,
      totalItems: 0,
      tableData: [],
      
      // 删除相关数据
      deleteDialogVisible: false,
      deleteLoading: false,
      currentDeleteItem: null,
      
      statusOptions: [
        { value: 'completed', label: '完成' },
        { value: 'pending', label: '等待中' },
        { value: 'processing', label: '处理中' },
        { value: 'failed', label: '失败' }
      ],
      resultOptions: [
        { value: 'real', label: '真实' },
        { value: 'fake', label: '虚假' },
        { value: 'unknown', label: '未知' }
      ]
    }
  },
  computed: {
    filteredData() {
      let filteredData = [...this.tableData];
      
      // 应用标题搜索
      if (this.searchQuery) {
        const query = this.searchQuery.toLowerCase();
        filteredData = filteredData.filter(item => 
          item.title.toLowerCase().includes(query)
        );
      }
      
      // 应用状态过滤
      if (this.statusFilter) {
        filteredData = filteredData.filter(item => 
          item.status === this.statusFilter
        );
      }
      
      // 应用结果过滤
      if (this.resultFilter !== '') {
        filteredData = filteredData.filter(item => 
          item.result === this.resultFilter
        );
      }
      
      // 应用日期范围过滤
      if (this.dateRange && this.dateRange.length === 2) {
        const startDate = new Date(this.dateRange[0]);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(this.dateRange[1]);
        endDate.setHours(23, 59, 59, 999);
        
        filteredData = filteredData.filter(item => {
          const itemDate = new Date(item.created_at);
          return itemDate >= startDate && itemDate <= endDate;
        });
      }
      
      return filteredData;
    },
    filteredDetections() {
      // 分页
      const start = (this.currentPage - 1) * this.pageSize;
      const end = start + this.pageSize;
      return this.filteredData.slice(start, end);
    }
  },
  mounted() {
    this.fetchData();
  },
  methods: {
    fetchData() {
      this.loading = true;
      
      // 检查是否在管理员路径下
      const isAdmin = this.$route.path.includes('/admin/');
      // 使用不同的API端点，管理员查看所有记录，普通用户查看自己的记录
      const endpoint = isAdmin ? '/detection/detections/' : '/detection/detections/my_detections/';
      const params = { page: this.currentPage, limit: this.pageSize };
      
      axios.get(endpoint, { params })
        .then(response => {
          this.tableData = response.data.results;
          this.totalItems = response.data.count;
          this.loading = false;
        })
        .catch(error => {
          console.error('获取检测历史失败:', error);
          this.$message.error(
            error.response && error.response.status === 404 
              ? 'API路径错误，请检查后端配置' 
              : '获取检测历史失败，请稍后重试'
          );
          this.loading = false;
        });
    },
    
    formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    },
    
    getStatusType(status) {
      switch (status) {
        case 'completed': return 'success';
        case 'pending': return 'info';
        case 'processing': return 'warning';
        case 'failed': return 'danger';
        default: return 'info';
      }
    },
    
    getStatusText(status) {
      switch (status) {
        case 'completed': return '完成';
        case 'pending': return '等待中';
        case 'processing': return '处理中';
        case 'failed': return '失败';
        default: return '未知';
      }
    },
    
    handleFilter() {
      this.currentPage = 1;
      // 本地过滤时不需要重新请求
    },
    
    handleSizeChange(val) {
      this.pageSize = val;
      this.fetchData();
    },
    
    handleCurrentChange(val) {
      this.currentPage = val;
      this.fetchData();
    },
    
    viewDetail(id) {
      // 根据当前路由判断是管理员还是普通用户视图
      const isAdmin = this.$route.path.includes('/admin/');
      const baseUrl = isAdmin ? '/admin' : '/dashboard';
      this.$router.push(`${baseUrl}/detection/detail/${id}`);
    },
    
    // 删除操作
    handleDelete(row) {
      this.currentDeleteItem = row;
      this.deleteDialogVisible = true;
    },
    
    confirmDelete() {
      if (!this.currentDeleteItem) return;
      
      this.deleteLoading = true;
      
      // 使用API方法删除
      deleteDetection(this.currentDeleteItem.id)
        .then(() => {
          this.$message({
            type: 'success',
            message: '删除成功'
          });
          this.deleteDialogVisible = false;
          // 重新加载数据
          this.fetchData();
        })
        .catch(error => {
          console.error('删除失败:', error);
          let errorMsg = '删除失败，请稍后重试';
          
          if (error.response) {
            if (error.response.status === 403) {
              errorMsg = '没有删除权限，请联系管理员';
            } else if (error.response.status === 404) {
              errorMsg = '记录不存在，可能已被删除';
            }
          }
          
          this.$message.error(errorMsg);
        })
        .finally(() => {
          this.deleteLoading = false;
          this.currentDeleteItem = null;
        });
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.history-container {
  padding: 20px;
}

.filter-container {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.pagination-container {
  margin-top: 20px;
  display: flex;
  justify-content: center;
}
</style> 

================================================================================
文件路径: frontend\src\views\layout\Layout.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\layout\Layout.vue
================================================================================

<template>
  <el-container class="app-container">
    <!-- 侧边栏 -->
    <el-aside :width="isCollapsed ? '64px' : '240px'" class="sidebar-container" :class="{ 'collapsed': isCollapsed }">
      <div class="logo">
        <el-image :src="logoSrc" alt="Logo" class="logo-image"></el-image>
        <span class="logo-text" v-show="!isCollapsed">MM-DFD系统</span>
      </div>
      <el-menu
        :default-active="activeMenu"
        :collapse="isCollapsed"
        router
        :collapse-transition="false"
        background-color="#2b2d42"
        text-color="#e9ecef"
        active-text-color="#4cc9f0"
        class="sidebar-menu"
      >
        <el-menu-item v-for="item in visibleRoutes" :key="item.path" :index="'/dashboard/' + item.path">
          <i :class="item.meta ? item.meta.icon : 'el-icon-document'"></i>
          <span slot="title">{{ item.meta ? item.meta.title : item.name }}</span>
        </el-menu-item>
      </el-menu>
    </el-aside>
    
    <el-container class="main-container">
      <!-- 头部 -->
      <el-header class="app-header">
        <div class="header-left">
          <i 
            :class="isCollapsed ? 'el-icon-s-unfold' : 'el-icon-s-fold'" 
            class="toggle-btn" 
            @click="toggleSidebar"
          ></i>
        </div>
        <div class="header-right">
          <el-dropdown trigger="click" @command="handleCommand">
            <div class="user-info">
              <el-avatar :size="32" icon="el-icon-user"></el-avatar>
              <span class="username" v-if="!isSmallScreen">{{ username }}</span>
              <i class="el-icon-arrow-down"></i>
            </div>
            <el-dropdown-menu slot="dropdown">
              <el-dropdown-item command="profile">
                <i class="el-icon-user-solid"></i> 个人中心
              </el-dropdown-item>
              <el-dropdown-item v-if="isAdmin" command="admin">
                <i class="el-icon-s-tools"></i> 管理控制台
              </el-dropdown-item>
              <el-dropdown-item command="logout">
                <i class="el-icon-switch-button"></i> 退出登录
              </el-dropdown-item>
            </el-dropdown-menu>
          </el-dropdown>
        </div>
      </el-header>
      
      <!-- 主体内容 -->
      <el-main class="app-main">
        <transition name="fade" mode="out-in">
          <router-view />
        </transition>
      </el-main>
      
      <!-- 页脚 -->
      <el-footer height="40px" class="app-footer">
        <span>© 2025 多模态深度学习社交媒体虚假新闻检测系统 (MM-DFD)</span>
      </el-footer>
    </el-container>
  </el-container>
</template>

<script>
import { mapGetters } from 'vuex'

export default {
  name: 'LayoutView',
  data() {
    return {
      isCollapsed: false,
      isSmallScreen: false
    }
  },
  computed: {
    ...mapGetters(['user']),
    activeMenu() {
      const { path } = this.$route
      if (path.startsWith('/dashboard/')) {
        return path
      }
      return '/dashboard/index'
    },
    routes() {
      return this.$router.options.routes.find(route => route.path === '/dashboard').children.filter(route => !route.meta || !route.meta.hideInMenu)
    },
    visibleRoutes() {
      return this.$router.options.routes.find(route => route.path === '/dashboard').children.filter(route => !route.meta || !route.meta.hideInMenu)
    },
    username() {
      return this.user.username || '用户'
    },
    isAdmin() {
      return this.user.is_staff === true
    },
    logoSrc() {
      try {
        return require('@/assets/logo.svg')
      } catch (e) {
        return this.$defaultLogo || ''
      }
    }
  },
  methods: {
    toggleSidebar() {
      this.isCollapsed = !this.isCollapsed
    },
    handleCommand(command) {
      if (command === 'logout') {
        this.$store.dispatch('user/logout')
      } else if (command === 'profile') {
        this.$router.push('/dashboard/profile')
      } else if (command === 'admin') {
        this.$router.replace('/admin/dashboard')
      }
    },
    handleResize() {
      this.isSmallScreen = window.innerWidth < 768
      if (window.innerWidth < 992 && !this.isCollapsed) {
        this.isCollapsed = true
      }
    }
  },
  mounted() {
    this.handleResize()
    window.addEventListener('resize', this.handleResize)
  },
  beforeDestroy() {
    window.removeEventListener('resize', this.handleResize)
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.app-container {
  height: 100vh;
  overflow: hidden;
}

.sidebar-container {
  background-color: #2b2d42;
  color: #fff;
  transition: width $transition-base;
  position: relative;
  z-index: 10;
  overflow-x: hidden;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.main-container {
  transition: margin-left $transition-base;
  position: relative;
  min-height: 100%;
  background: $background-color;
}

.logo {
  height: $header-height;
  display: flex;
  align-items: center;
  padding: 0 15px;
  background-color: #242635;
  overflow: hidden;
}

.logo-image {
  width: 32px;
  height: 32px;
  margin-right: 10px;
  transition: $transition-base;
}

.logo-text {
  color: #fff;
  font-size: 18px;
  font-weight: 600;
  white-space: nowrap;
  transition: opacity 0.3s;
}

.sidebar-menu {
  border-right: none;
  &::v-deep .el-menu-item {
    height: 50px;
    line-height: 50px;
    &.is-active {
      background-color: rgba($primary-color, 0.1) !important;
      &::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: $primary-color;
      }
    }
    &:hover {
      background-color: rgba(255, 255, 255, 0.05) !important;
    }
  }
}

.app-header {
  background-color: white;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  height: $header-height;
  position: relative;
  z-index: 9;
}

.toggle-btn {
  cursor: pointer;
  font-size: 20px;
  color: $regular-font-color;
  transition: $transition-base;
  padding: 10px;
  border-radius: $border-radius-small;
  
  &:hover {
    color: $primary-color;
    background-color: rgba($primary-color, 0.1);
  }
}

.user-info {
  display: flex;
  align-items: center;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: $border-radius-base;
  transition: $transition-base;
  
  &:hover {
    background-color: rgba($primary-color, 0.05);
  }
  
  .username {
    margin: 0 10px;
    font-weight: 500;
  }
}

.app-main {
  padding: 20px;
  overflow-y: auto;
  min-height: calc(100vh - #{$header-height} - 40px);
}

.app-footer {
  text-align: center;
  background-color: #fff;
  color: $secondary-font-color;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 -1px 4px rgba(0, 0, 0, 0.03);
}

@media (max-width: $md) {
  .app-main {
    padding: 15px;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\login\Login.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\login\Login.vue
================================================================================

<template>
  <div class="login-container">
    <div class="login-form-container">
      <div class="login-header">
        <el-image :src="logoSrc" alt="Logo" class="logo"></el-image>
        <h2>多模态虚假新闻检测系统</h2>
      </div>
      <el-form :model="loginForm" :rules="loginRules" ref="loginForm" class="login-form">
        <el-form-item prop="username">
          <el-input 
            v-model="loginForm.username" 
            placeholder="用户名" 
            prefix-icon="el-icon-user">
          </el-input>
        </el-form-item>
        <el-form-item prop="password">
          <el-input 
            v-model="loginForm.password" 
            type="password" 
            placeholder="密码" 
            prefix-icon="el-icon-lock"
            @keyup.enter.native="handleLogin">
          </el-input>
        </el-form-item>
        <el-form-item>
          <el-button 
            type="primary" 
            :loading="loading" 
            @click="handleLogin" 
            class="login-button">
            登录
          </el-button>
        </el-form-item>
      </el-form>
    </div>
  </div>
</template>

<script>
export default {
  name: 'Login',
  data() {
    return {
      loginForm: {
        username: '',
        password: ''
      },
      loginRules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' }
        ],
        password: [
          { required: true, message: '请输入密码', trigger: 'blur' }
        ]
      },
      loading: false
    }
  },
  computed: {
    logoSrc() {
      try {
        return require('@/assets/logo.png')
      } catch (e) {
        return this.$defaultLogo || ''
      }
    }
  },
  methods: {
    handleLogin() {
      this.$refs.loginForm.validate(valid => {
        if (valid) {
          this.loading = true
          this.$store.dispatch('user/login', this.loginForm)
            .then(() => {
              this.$router.push({ path: this.redirect || '/' })
              this.loading = false
            })
            .catch(error => {
              this.$message.error(error.message || '登录失败')
              this.loading = false
            })
        } else {
          return false
        }
      })
    }
  }
}
</script>

<style lang="scss" scoped>
.login-container {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: $background-color;
  background-size: cover;
}

.login-form-container {
  width: 400px;
  padding: 30px;
  background-color: white;
  border-radius: $border-radius;
  box-shadow: $box-shadow;
}

.login-header {
  text-align: center;
  margin-bottom: 30px;

  h2 {
    margin-top: 15px;
    font-weight: 500;
    color: $primary-color;
  }

  .logo {
    width: 80px;
    height: 80px;
  }
}

.login-form {
  .login-button {
    width: 100%;
  }
}
</style> 

================================================================================
文件路径: frontend\src\views\user\Profile.vue
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\frontend\src\views\user\Profile.vue
================================================================================

<template>
  <div class="profile-container">
    <div class="page-title">个人中心</div>
    
    <el-row :gutter="20">
      <el-col :span="8">
        <el-card shadow="hover" class="user-card">
          <div class="user-avatar">
            <el-avatar :size="100" icon="el-icon-user-solid"></el-avatar>
          </div>
          <div class="user-info">
            <h3>{{ userInfo.username }}</h3>
            <p>{{ userInfo.email }}</p>
            <p>{{ userInfo.is_staff ? '管理员' : '普通用户' }}</p>
            <p>注册时间: {{ formatDate(userInfo.date_joined) }}</p>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="16">
        <el-card shadow="hover" class="info-edit-card">
          <div slot="header" class="clearfix">
            <span>个人资料</span>
          </div>
          
          <el-form :model="userForm" :rules="rules" ref="userForm" label-width="100px">
            <el-form-item label="用户名" prop="username">
              <el-input v-model="userForm.username"></el-input>
            </el-form-item>
            
            <el-form-item label="邮箱" prop="email">
              <el-input v-model="userForm.email"></el-input>
            </el-form-item>
            
            <el-form-item>
              <el-button type="primary" @click="updateUserInfo" :loading="updateLoading">保存修改</el-button>
            </el-form-item>
          </el-form>
        </el-card>
        
        <el-card shadow="hover" class="password-card">
          <div slot="header" class="clearfix">
            <span>修改密码</span>
          </div>
          
          <el-form :model="passwordForm" :rules="passwordRules" ref="passwordForm" label-width="100px">
            <el-form-item label="当前密码" prop="old_password">
              <el-input v-model="passwordForm.old_password" type="password"></el-input>
            </el-form-item>
            
            <el-form-item label="新密码" prop="new_password">
              <el-input v-model="passwordForm.new_password" type="password"></el-input>
            </el-form-item>
            
            <el-form-item label="确认密码" prop="new_password2">
              <el-input v-model="passwordForm.new_password2" type="password"></el-input>
            </el-form-item>
            
            <el-form-item>
              <el-button type="primary" @click="changePassword" :loading="passwordLoading">修改密码</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'

export default {
  name: 'ProfileView',
  data() {
    // 密码确认验证
    const validatePass = (rule, value, callback) => {
      if (value !== this.passwordForm.new_password) {
        callback(new Error('两次输入密码不一致!'))
      } else {
        callback()
      }
    }
    
    return {
      userForm: {
        username: '',
        email: ''
      },
      passwordForm: {
        old_password: '',
        new_password: '',
        new_password2: ''
      },
      rules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' },
          { min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur' }
        ],
        email: [
          { required: true, message: '请输入邮箱地址', trigger: 'blur' },
          { type: 'email', message: '请输入正确的邮箱地址', trigger: 'blur' }
        ]
      },
      passwordRules: {
        old_password: [
          { required: true, message: '请输入当前密码', trigger: 'blur' }
        ],
        new_password: [
          { required: true, message: '请输入新密码', trigger: 'blur' },
          { min: 6, message: '密码长度不能小于6个字符', trigger: 'blur' }
        ],
        new_password2: [
          { required: true, message: '请再次输入密码', trigger: 'blur' },
          { validator: validatePass, trigger: 'blur' }
        ]
      },
      updateLoading: false,
      passwordLoading: false
    }
  },
  computed: {
    ...mapGetters(['user']),
    userInfo() {
      return this.user || {}
    }
  },
  mounted() {
    this.initUserForm()
  },
  methods: {
    initUserForm() {
      this.userForm = {
        username: this.userInfo.username || '',
        email: this.userInfo.email || ''
      }
    },
    
    formatDate(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
    },
    
    updateUserInfo() {
      this.$refs.userForm.validate(valid => {
        if (valid) {
          this.updateLoading = true
          this.$store.dispatch('user/updateUserInfo', this.userForm)
            .then(() => {
              this.$message.success('个人资料已更新')
            })
            .catch(error => {
              console.error('更新资料失败:', error)
              this.$message.error('更新资料失败: ' + (error.response?.data?.detail || '请稍后重试'))
            })
            .finally(() => {
              this.updateLoading = false
            })
        } else {
          return false
        }
      })
    },
    
    changePassword() {
      this.$refs.passwordForm.validate(valid => {
        if (valid) {
          this.passwordLoading = true
          this.$store.dispatch('user/changePassword', this.passwordForm)
            .then(() => {
              this.$message.success('密码已修改，请重新登录')
              // 清空表单
              this.passwordForm = {
                old_password: '',
                new_password: '',
                new_password2: ''
              }
              // 登出并跳转到登录页
              this.$store.dispatch('user/logout')
            })
            .catch(error => {
              console.error('修改密码失败:', error)
              this.$message.error('修改密码失败: ' + (error.response?.data?.detail || '当前密码可能不正确'))
            })
            .finally(() => {
              this.passwordLoading = false
            })
        } else {
          return false
        }
      })
    }
  }
}
</script>

<style lang="scss" scoped>
@import "@/assets/css/variables.scss";

.profile-container {
  padding: 20px;
}

.user-card {
  text-align: center;
  padding: 20px;
  margin-bottom: 20px;
  
  .user-avatar {
    margin-bottom: 20px;
  }
  
  .user-info {
    h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: $main-font-color;
    }
    
    p {
      margin: 5px 0;
      color: $regular-font-color;
    }
  }
}

.info-edit-card {
  margin-bottom: 20px;
}

.password-card {
  margin-bottom: 20px;
}
</style> 

================================================================================
文件路径: scripts\data_loader.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\scripts\data_loader.py
================================================================================

import os
import pandas as pd
import torch
from torch.utils.data import Dataset, DataLoader
from PIL import Image, UnidentifiedImageError
from torchvision import transforms
from transformers import AutoTokenizer
import numpy as np
from pathlib import Path
import logging

# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Configuration ---
BASE_DIR = Path(__file__).parent.parent
DATA_DIR = BASE_DIR / 'data'
PROCESSED_DIR = DATA_DIR / 'processed'
CSV_PATH = PROCESSED_DIR / 'processed_data.csv'
IMAGE_DIR = PROCESSED_DIR / 'images'

TEXT_MODEL_NAME = 'bert-base-chinese'
IMAGE_MODEL_INPUT_SIZE = 224
MAX_TEXT_LEN = 128

IMG_MEAN = [0.485, 0.456, 0.406]
IMG_STD = [0.229, 0.224, 0.225]

# --- Custom PyTorch Dataset (No Metadata) ---

class MultimodalFakeNewsDataset(Dataset):
    """
    Custom PyTorch Dataset for loading multimodal fake news data.
    Handles text, image (if available), and labels.
    (Modified to exclude metadata)
    """
    def __init__(self, dataframe, data_dir, tokenizer, image_transform, max_len):
        self.data_dir = Path(data_dir)
        self.image_base_dir = self.data_dir / 'processed' / 'images'
        self.tokenizer = tokenizer
        self.image_transform = image_transform
        self.max_len = max_len

        logging.info(f"Initializing Dataset with {len(dataframe)} records (metadata excluded).")
        try:
            self.df = dataframe.copy()
            self.df['image_path'] = self.df['image_path'].fillna('') 
            self.df['text'] = self.df['text'].fillna('') 
            
        except Exception as e:
            logging.error(f"Error initializing Dataset from DataFrame: {e}")
            raise

    def __len__(self):
        return len(self.df)

    def __getitem__(self, index):
        row = self.df.iloc[index]

        item_id = row['id']
        text = str(row['text'])
        label = int(row['label'])
        image_path_rel = row['image_path']

        # --- Text Processing ---
        encoding = self.tokenizer.encode_plus(
            text,
            add_special_tokens=True,
            max_length=self.max_len,
            padding='max_length',
            truncation=True,
            return_token_type_ids=False,
            return_attention_mask=True,
            return_tensors='pt',
        )
        input_ids = encoding['input_ids'].flatten()
        attention_mask = encoding['attention_mask'].flatten()

        # --- Image Processing ---
        image_tensor = torch.zeros(3, IMAGE_MODEL_INPUT_SIZE, IMAGE_MODEL_INPUT_SIZE)
        image_available = False
        if image_path_rel and isinstance(image_path_rel, str):
            image_path_abs = self.data_dir / image_path_rel
            try:
                if image_path_abs.is_file():
                    image = Image.open(image_path_abs).convert('RGB')
                    image_tensor = self.image_transform(image)
                    image_available = True
                else:
                    logging.debug(f"Image file not found for item {item_id} at {image_path_abs}")
            except UnidentifiedImageError:
                logging.warning(f"Could not read image file (unidentified format) for item {item_id} at {image_path_abs}")
            except Exception as e:
                logging.warning(f"Error loading image for item {item_id} at {image_path_abs}: {e}")

        # --- Label Processing ---
        label_tensor = torch.tensor(label, dtype=torch.float)

        return {
            'id': item_id,
            'input_ids': input_ids,
            'attention_mask': attention_mask,
            'image': image_tensor,
            'label': label_tensor,
            'image_available': torch.tensor(image_available, dtype=torch.bool)
        }

# --- Setup Functions ---

def get_tokenizer(model_name=TEXT_MODEL_NAME):
    logging.info(f"Loading tokenizer: {model_name}")
    tokenizer = AutoTokenizer.from_pretrained(model_name)
    return tokenizer

def get_image_transforms(input_size=IMAGE_MODEL_INPUT_SIZE, mean=IMG_MEAN, std=IMG_STD, augment=False):
    logging.info("Defining image transforms...")
    size = (input_size, input_size) if isinstance(input_size, int) else input_size
    base_transforms = [
        transforms.Resize(size),
        transforms.ToTensor(),
        transforms.Normalize(mean=mean, std=std)
    ]
    if augment:
        augmentation_transforms = [
            transforms.RandomHorizontalFlip(),
        ]
        transform_list = augmentation_transforms + base_transforms
    else:
        transform_list = base_transforms
    return transforms.Compose(transform_list)

# --- Main Execution Example (移除 metadata 相关) ---

if __name__ == '__main__':
    logging.info("--- Starting Data Loader Setup (Metadata Excluded) ---")

    tokenizer = get_tokenizer()
    image_transform = get_image_transforms()

    try:
        dataset = MultimodalFakeNewsDataset(
            dataframe=pd.read_csv(CSV_PATH),
            data_dir=DATA_DIR,
            tokenizer=tokenizer,
            image_transform=image_transform,
            max_len=MAX_TEXT_LEN,
        )
        logging.info(f"Dataset created successfully with {len(dataset)} samples.")

        batch_size = 16
        data_loader = DataLoader(dataset, batch_size=batch_size, shuffle=True, num_workers=2)
        logging.info(f"DataLoader created with batch size {batch_size}.")

        logging.info("Fetching one batch as an example...")
        try:
            first_batch = next(iter(data_loader))
            print("\n--- Example Batch Contents ---")
            print(f"Batch Keys: {first_batch.keys()}")
            print(f"Item IDs (sample): {first_batch['id'][:4]}...")
            print(f"Input IDs Shape: {first_batch['input_ids'].shape}")
            print(f"Attention Mask Shape: {first_batch['attention_mask'].shape}")
            print(f"Image Tensor Shape: {first_batch['image'].shape}")
            print(f"Label Tensor Shape: {first_batch['label'].shape}")
            print(f"Image Available Flags (sample): {first_batch['image_available'][:4]}...")
            print("--- End Example Batch ---")
        except StopIteration:
             logging.warning("Could not fetch a batch, is the dataset empty?")
        except Exception as e:
             logging.error(f"Error fetching or displaying batch: {e}", exc_info=True)

    except Exception as e:
         logging.error(f"Failed to initialize Dataset: {e}", exc_info=True)

    logging.info("--- Data Loader Setup Finished ---")

================================================================================
文件路径: scripts\llm_cross_validation.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\scripts\llm_cross_validation.py
================================================================================

# scripts/llm_cross_validation.py

import os
import pandas as pd
import numpy as np
from pathlib import Path
import logging
import time
import argparse
import json
from PIL import Image
import base64
from io import BytesIO
import asyncio # Added for asynchronous operations

# --- Use AsyncOpenAI library to interact with OpenRouter ---
try:
    from openai import AsyncOpenAI # Use the async client
except ImportError:
    logging.error("OpenAI library not installed. Please install it: pip install openai")
    AsyncOpenAI = None

# --- Configuration ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Paths
BASE_DIR = Path(__file__).parent.parent
DATA_DIR = BASE_DIR / 'data'
OUTPUT_DIR = BASE_DIR / 'llm_evaluation_results'
OUTPUT_DIR.mkdir(exist_ok=True)

# --- OpenRouter API Configuration ---
DEFAULT_OPENROUTER_API_KEY = "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"
YOUR_SITE_URL = os.environ.get("YOUR_SITE_URL", "http://localhost")
YOUR_SITE_NAME = os.environ.get("YOUR_SITE_NAME", "MM-DFD-Validation")

# --- Models to Use via OpenRouter ---
# Define models used for text verification
OR_TEXT_MODELS = [
    "perplexity/sonar-reasoning-pro",
    "perplexity/sonar",
    "google/gemini-2.0-flash-001", # Also supports vision
    "deepseek/deepseek-r1",
    "deepseek/deepseek-chat-v3-0324",
]
# Define models used for image verification
OR_IMAGE_MODELS = [
    "google/gemini-2.0-flash-001",
]

# --- Model Weighting (Adjusted Weights) ---
MODEL_WEIGHTS = {
    # Perplexity 权重调整以平衡总和
    "perplexity/sonar-reasoning-pro": 0.35,
    "perplexity/sonar": 0.2,
    # 提高 Gemini 权重
    "google/gemini-2.0-flash-001": 0.3, 
    # 降低 DeepSeek 权重
    "deepseek/deepseek-r1": 0.1,
    "deepseek/deepseek-chat-v3-0324": 0.05, 
    # 当前总和: 0.35 + 0.2 + 0.3 + 0.1 + 0.05 = 1.0
    # Note: Weights are primarily for text verification aggregation.
}

# Rate limiting delay
DEFAULT_API_DELAY = 1.5 # Slightly adjusted delay for async calls

# --- Helper Functions ---
def load_image_as_base64(image_path):
    """Loads an image file and returns its base64 encoded string."""
    # (Implementation remains the same as previous version)
    if not image_path:
        logging.warning("No image path provided to load_image_as_base64.")
        return None
    abs_path = Path(image_path)
    if not abs_path.exists():
        abs_path = DATA_DIR / image_path
        if not abs_path.exists():
            logging.error(f"Image file not found: {image_path}")
            return None
    try:
        logging.info(f"Loading image from: {abs_path}")
        with Image.open(abs_path) as img:
            output_format = "JPEG" if img.format != "PNG" else "PNG"
            buffered = BytesIO()
            if output_format == "JPEG" and img.mode == 'RGBA': img = img.convert('RGB')
            img.save(buffered, format=output_format)
            img_byte = buffered.getvalue()
            return base64.b64encode(img_byte).decode('utf-8')
    except Exception as e:
        logging.warning(f"Could not load or encode image {abs_path}: {e}")
        return None

def format_structured_llm_response(model_name, success, data=None, error=None):
    """Standardizes the response format, expecting specific keys.
       Ensures 'success' key is always present.
    """
    # Initialize with base structure and correct success status
    base_response = {
        "model": model_name,
        "success": success, # Ensure success is always set
        "verdict": "Error" if not success else "Parsing Error", # Default verdict based on success
        "confidence": 0.0,
        "reason": None,
        "error": str(error) if error else (None if success else "Unknown error during processing"),
        "raw_response": None
    }

    if success and isinstance(data, dict):
        # Attempt to extract keys, providing defaults if missing
        base_response.update({
            "verdict": data.get("verdict", "Parsing Error"),
            "confidence": data.get("confidence", 0.0),
            "reason": data.get("reason", "No reason provided or parsing failed."),
            "error": None # Clear error if successfully parsed dict
        })
        # Basic validation for confidence
        try:
             confidence_val = float(base_response["confidence"])
             if not (0.0 <= confidence_val <= 1.0):
                  logging.warning(f"Model {model_name} returned confidence out of range: {confidence_val}. Clamping to 0.0-1.0.")
                  base_response["confidence"] = max(0.0, min(1.0, confidence_val))
             else:
                  base_response["confidence"] = confidence_val # Ensure it's float
        except (ValueError, TypeError):
             logging.warning(f"Model {model_name} returned non-numeric confidence: {base_response['confidence']}. Setting to 0.0.")
             base_response["confidence"] = 0.0

    elif not success and isinstance(data, str): # Handle case where parsing failed but raw text exists
        base_response["raw_response"] = data
        # Ensure error message reflects parsing failure
        base_response["error"] = f"Failed to parse LLM response as JSON. {base_response['error'] if base_response['error'] else ''}".strip()

    # For other cases (e.g., success=False, data is not dict or str), the initial base_response is used.

    return base_response


# --- Unified ASYNC OpenRouter API Call Function ---
async def call_openrouter_api_async(prompt, model_name, image_base64=None, api_key=DEFAULT_OPENROUTER_API_KEY):
    """ASYNC calls the specified model via the OpenRouter API using the OpenAI library format."""
    if not AsyncOpenAI: return format_structured_llm_response(model_name, False, error="AsyncOpenAI client not available.")
    if not api_key: return format_structured_llm_response(model_name, False, error="OpenRouter API key not configured.")

    client = AsyncOpenAI(base_url="https://openrouter.ai/api/v1", api_key=api_key)
    messages = [{"role": "user", "content": []}]
    messages[0]["content"].append({"type": "text", "text": prompt})

    if image_base64:
        is_vision_model = model_name in OR_IMAGE_MODELS
        if is_vision_model:
            mime = "image/jpeg" if image_base64.startswith("/9j/") else "image/png"
            image_url = f"data:{mime};base64,{image_base64}"
            messages[0]["content"].append({"type": "image_url", "image_url": {"url": image_url}})
            logging.info(f"Preparing image for vision model: {model_name}")
        else:
            logging.warning(f"Image provided, but model {model_name} not in vision list. Sending text only.")

    try:
        logging.debug(f"Calling OpenRouter model: {model_name}")
        completion = await client.chat.completions.create(
            extra_headers={"HTTP-Referer": YOUR_SITE_URL, "X-Title": YOUR_SITE_NAME},
            model=model_name,
            messages=messages,
            max_tokens=700,
            temperature=0.3, # Lower temperature for more factual responses
            # response_format={"type": "json_object"}, # Request JSON output if supported by model/OpenRouter
        )
        raw_content = completion.choices[0].message.content
        logging.debug(f"Raw response from {model_name}: {raw_content}")

        # Attempt to parse the response as JSON
        try:
            # Clean potential markdown code blocks
            if raw_content.strip().startswith("```json"):
                 raw_content = raw_content.strip()[7:-3].strip()
            elif raw_content.strip().startswith("```"):
                 raw_content = raw_content.strip()[3:-3].strip()

            parsed_data = json.loads(raw_content)
            if not isinstance(parsed_data, dict):
                 raise ValueError("Response is not a JSON object.")
            # Basic check for expected keys (optional but good practice)
            # if not all(k in parsed_data for k in ["verdict", "confidence", "reason"]):
            #     raise ValueError("JSON missing required keys: verdict, confidence, reason")

            return format_structured_llm_response(model_name, True, data=parsed_data)

        except json.JSONDecodeError as json_err:
            logging.warning(f"Failed to parse JSON from {model_name}: {json_err}. Raw response: {raw_content}")
            return format_structured_llm_response(model_name, False, error=f"JSONDecodeError: {json_err}", data=raw_content)
        except ValueError as val_err:
             logging.warning(f"Parsed JSON structure invalid from {model_name}: {val_err}. Raw response: {raw_content}")
             return format_structured_llm_response(model_name, False, error=f"Invalid JSON Structure: {val_err}", data=raw_content)


    except Exception as e:
        logging.error(f"OpenRouter API call failed for model {model_name}: {e}")
        error_detail = str(e)
        if hasattr(e, 'response') and hasattr(e.response, 'text'): error_detail += f" | Response: {e.response.text}"
        return format_structured_llm_response(model_name, False, error=error_detail)


# --- Core ASYNC Verification Function for Single Input ---

async def verify_single_news_async(text_input, image_path_input=None, api_key=DEFAULT_OPENROUTER_API_KEY, api_delay=DEFAULT_API_DELAY):
    """
    ASYNC verifies a single news item using multiple LLMs via OpenRouter and aggregates results.
    """
    logging.info("--- Starting Single Item Verification (Async) ---")
    if not text_input and not image_path_input:
        logging.error("Both text_input and image_path_input are empty.")
        return {"error": "No text or image provided."}

    # --- Prepare Image Data ---
    img_b64 = None
    if image_path_input:
        img_b64 = load_image_as_base64(image_path_input)
        if not img_b64:
            logging.warning(f"Failed to load image {image_path_input}, proceeding without it.")

    # --- Prepare API Call Tasks ---
    tasks = []

    # Text Verification Tasks
    if text_input:
        # Updated prompt asking for JSON
        text_prompt = f"""请对以下新闻内容进行事实核查。请严格按照以下 JSON 格式返回你的分析结果，不要添加任何额外的解释性文字或markdown标记：
{{
  "verdict": "判断结果",
  "confidence": 置信度分数,
  "reason": "理由/证据摘要"
}}
其中，"判断结果"必须是"真实"、"虚假"、"无法核实"或"混合信息"之一。"置信度分数"是一个 0.0 到 1.0 之间的小数，表示你对判断结果的确信程度。"理由/证据摘要"请提供简洁客观的分析依据或来源。

新闻内容：
\"{text_input}\"
"""
        for model_id in OR_TEXT_MODELS:
            tasks.append(asyncio.create_task(call_openrouter_api_async(text_prompt, model_id, api_key=api_key)))
            # Add small delay *between creating tasks* if hitting creation limits,
            # but the main delay is handled by asyncio.gather implicitly or explicit sleeps if needed.
            await asyncio.sleep(0.05) # Small delay between task creations


    # Image Verification Tasks
    if img_b64:
        # Updated prompts asking for JSON
        if text_input:
            image_prompt = f"""请分析提供的图片，并结合以下新闻文本进行判断。请严格按照以下 JSON 格式返回你的分析结果：
{{
  "verdict": "综合判断结果",
  "confidence": 置信度分数,
  "reason": "图片与文本关联性分析及判断理由"
}}
其中，"综合判断结果"是对结合图片和文本后新闻整体真实性的判断（真实/虚假/无法核实/混合信息）。"置信度分数"是你对此判断的确信程度（0.0-1.0）。"理由"需说明图片内容、与文本关联、是否佐证或矛盾。

新闻文本：
\"{text_input}\"
"""
        else:
            image_prompt = f"""请分析提供的图片，判断它所描绘的场景或事件的真实性。请严格按照以下 JSON 格式返回你的分析结果：
{{
  "verdict": "图片真实性判断",
  "confidence": 置信度分数,
  "reason": "图片分析理由（例如：是否像真实照片、AI生成、拼接、摆拍等）"
}}
其中，"图片真实性判断"是"真实"、"疑似伪造"、"无法判断"之一。"置信度分数"是你对此判断的确信程度（0.0-1.0）。

"""
        for model_id in OR_IMAGE_MODELS:
             # Ensure image is only sent to designated vision models
            tasks.append(asyncio.create_task(call_openrouter_api_async(image_prompt, model_id, image_base64=img_b64, api_key=api_key)))
            await asyncio.sleep(0.05) # Small delay between task creations

    # --- Execute Tasks Concurrently ---
    logging.info(f"Sending {len(tasks)} API requests concurrently...")
    individual_results = await asyncio.gather(*tasks)
    logging.info("All API responses received.")

    # Separate text and image results (assuming model names are unique identifiers)
    text_results_raw = [res for res in individual_results if res['model'] in OR_TEXT_MODELS]
    image_results_raw = [res for res in individual_results if res['model'] in OR_IMAGE_MODELS]

    # --- Aggregation Logic (Focus on Text Results for Overall Verdict/Confidence) ---
    final_verdict = "Inconclusive"
    final_confidence = 0.5 # Default neutral
    needs_review = False
    valid_confidences = []

    # Filter successful text results with valid confidence for aggregation
    valid_text_results = [r for r in text_results_raw if r['success'] and isinstance(r.get('confidence'), (int, float))]

    if valid_text_results:
        total_weight = 0
        weighted_sum = 0
        for result in valid_text_results:
            model = result['model']
            weight = MODEL_WEIGHTS.get(model, 0) # Get weight, default 0 if model not in weights dict
            if weight > 0:
                 # Map verdict to a numeric score for weighted average (e.g., Fake=1.0, True=0.0, Uncertain/Mixed=0.5)
                 verdict_score = 0.5 # Default for Uncertain/Mixed/Error in verdict string
                 verdict_str = result.get('verdict', '').lower()
                 if '虚假' in verdict_str or 'fake' in verdict_str:
                      verdict_score = 1.0
                 elif '真实' in verdict_str or 'true' in verdict_str:
                      verdict_score = 0.0
                 # Use the model's self-reported confidence, weighted by our assigned model weight
                 # We are averaging the "propensity towards fake" based on verdict and confidence
                 score_to_average = verdict_score * result['confidence'] + (1-verdict_score)*(1-result['confidence']) # Weighted lean towards Fake

                 # Let's try a simpler average of confidence scores directly,
                 # and determine verdict later based on the average and individual verdicts?
                 # Simpler approach: Weighted average of the confidence score itself.
                 weighted_sum += weight * result['confidence']
                 total_weight += weight
                 valid_confidences.append(result['confidence']) # For std dev calculation

        if total_weight > 0:
            # Calculate final weighted confidence
            final_confidence = weighted_sum / total_weight

            # Calculate standard deviation for divergence check
            if len(valid_confidences) > 1:
                confidence_std_dev = np.std(valid_confidences)
                if confidence_std_dev > 0.25: # Threshold for triggering review
                    needs_review = True
                    logging.warning(f"High divergence detected in model confidences (std dev: {confidence_std_dev:.3f}). Flagging for review.")
            else:
                 confidence_std_dev = 0.0 # Cannot calculate std dev for one value

            # Determine final verdict based on aggregated confidence thresholds
            # Count how many models lean towards Fake vs True
            fake_leaning_votes = sum(1 for r in valid_text_results if '虚假' in r.get('verdict','').lower())
            true_leaning_votes = sum(1 for r in valid_text_results if '真实' in r.get('verdict','').lower())
            uncertain_votes = len(valid_text_results) - fake_leaning_votes - true_leaning_votes

            # Decision logic based on thresholds and vote counts (can be refined)
            if final_confidence >= 0.70 and fake_leaning_votes > true_leaning_votes:
                 final_verdict = "Likely Fake"
            elif final_confidence <= 0.30 and true_leaning_votes > fake_leaning_votes:
                 final_verdict = "Likely True"
            elif abs(fake_leaning_votes - true_leaning_votes) <= 1 and uncertain_votes >= 1: # Close call or uncertain models present
                 final_verdict = "Uncertain / Mixed Signals"
                 needs_review = True # Flag close calls for review
            else: # Default to uncertain if logic doesn't clearly fit
                 final_verdict = "Uncertain"


        else:
            logging.warning("No valid text results with weights found for aggregation.")
            final_verdict = "Aggregation Error"


    # --- Prepare Final Output ---
    aggregated_result = {
        "overall_verdict": final_verdict,
        "aggregated_confidence": round(final_confidence, 3),
        "needs_manual_review": needs_review,
        "original_text": text_input,
        "original_image_path": image_path_input,
        "text_verifications": text_results_raw,
        "image_verifications": image_results_raw,
    }

    logging.info("--- Single Item Verification Finished ---")
    return aggregated_result


# --- Argument Parser and Main Execution (Example Usage) ---
def parse_args():
    parser = argparse.ArgumentParser(description="Verify a single news item using LLM APIs via OpenRouter with Ensemble Logic.")
    parser.add_argument('--text', type=str, default="", help="Text content of the news item.")
    parser.add_argument('--image_path', type=str, default=None, help="Path to the image file (optional).")
    parser.add_argument('--output_file', type=str, default=None,
                        help="Path to save the single result JSON (optional).")
    parser.add_argument('--api_key', type=str, default=DEFAULT_OPENROUTER_API_KEY, help="OpenRouter API Key.")
    parser.add_argument('--delay', type=float, default=DEFAULT_API_DELAY, help="Base delay between API calls.")

    return parser.parse_args()

if __name__ == "__main__":
    args = parse_args()
    script_start_time = time.time()

    if not AsyncOpenAI:
        logging.error("AsyncOpenAI client not available. Please install 'openai'.")
        exit(1)
    if not args.text and not args.image_path:
        logging.error("Error: Provide --text and/or --image_path.")
        exit(1)

    # Run the async verification function
    verification_result = asyncio.run(verify_single_news_async(
        text_input=args.text,
        image_path_input=args.image_path,
        api_key=args.api_key,
        api_delay=args.delay
    ))

    # Print the result to console
    print("\n--- Aggregated Verification Results ---")
    print(json.dumps(verification_result, indent=2, ensure_ascii=False))
    print("------------------------------------")

    # Optionally save the result to a file
    if args.output_file:
        try:
            output_path = Path(args.output_file)
            output_path.parent.mkdir(parents=True, exist_ok=True)
            with open(output_path, 'w', encoding='utf-8') as f:
                json.dump(verification_result, f, indent=2, ensure_ascii=False)
            logging.info(f"Aggregated result saved to {output_path}")
        except Exception as e:
            logging.error(f"Failed to save result to {args.output_file}: {e}")

    script_duration = time.time() - script_start_time
    logging.info(f"Total script duration: {script_duration / 60:.2f} minutes")

================================================================================
文件路径: scripts\model_evaluation.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\scripts\model_evaluation.py
================================================================================

# scripts/model_evaluation.py

import os
import pandas as pd
import numpy as np
import torch
import torch.nn as nn
from torch.utils.data import DataLoader
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import (
    accuracy_score,
    precision_score,
    recall_score,
    f1_score,
    roc_auc_score,
    confusion_matrix,
    classification_report
)
from pathlib import Path
import logging
import time
import joblib
from tqdm import tqdm
import argparse
import matplotlib.pyplot as plt
import seaborn as sns

# Import necessary classes and functions
try:
    # Import only the necessary classes from train_model
    from train_model import MultimodalFakeNewsModel, MetadataEncoder
    # Import necessary functions from data_loader
    from data_loader import (
        MultimodalFakeNewsDataset,
        get_tokenizer,
        get_image_transforms
    )
except ImportError as e:
    logging.error(f"Could not import necessary components. Make sure train_model.py and data_loader.py are in the path. Error: {e}")
    exit(1)


# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Configuration (Mirrored from train_model.py for consistency) ---
BASE_DIR = Path(__file__).parent.parent
DATA_DIR = BASE_DIR / 'data'
PROCESSED_DIR = DATA_DIR / 'processed'
CSV_PATH = PROCESSED_DIR / 'processed_data.csv'
OUTPUT_DIR = BASE_DIR / 'models'
DEFAULT_MODEL_PATH = OUTPUT_DIR / 'best_multimodal_model.pth'
DEFAULT_SCALER_PATH = OUTPUT_DIR / 'metadata_scaler.joblib'
RESULTS_DIR = BASE_DIR / 'evaluation_results' # Directory to save evaluation outputs
RESULTS_DIR.mkdir(exist_ok=True)

# Model Parameters (Ensure these match the trained model's config)
TEXT_MODEL_NAME = 'bert-base-chinese'
IMAGE_MODEL_NAME = 'resnet50'
IMAGE_MODEL_INPUT_SIZE = 224
MAX_TEXT_LEN = 128
NUM_METADATA_FEATURES = 9
IMG_EMBEDDING_DIM = 2048
TEXT_EMBEDDING_DIM = 768
METADATA_EMBEDDING_DIM = 64
FUSION_OUTPUT_DIM = 256

# Metadata Columns (Ensure this matches the scaler and data)
METADATA_COLS = [
    'total_likes', 'total_comments', 'total_reposts', 'total_views',
    'user_followers', 'user_following', 'user_posts', 'user_verified',
    'user_total_favorited'
]

# Data Split Parameters (Must match training split)
TEST_SPLIT = 0.15
RANDOM_SEED = 42

# Evaluation specific batch size (can be larger than training if memory allows)
# Inherit training BATCH_SIZE as a default or set a new one
EVAL_BATCH_SIZE = 32 * 2 # Example: double the training batch size

# --- Evaluation Function ---

def evaluate(model, data_loader, device):
    """ Runs model inference on the data_loader and calculates metrics. """
    model.eval()
    all_preds_proba = []
    all_labels = []
    all_ids = []

    logging.info("Starting evaluation...")
    with torch.no_grad():
        for batch in tqdm(data_loader, desc="Evaluating"):
            # Move batch to device
            input_ids = batch['input_ids'].to(device)
            attention_mask = batch['attention_mask'].to(device)
            images = batch['image'].to(device)
            metadata = batch['metadata'].to(device)
            labels = batch['label'].to(device)
            image_available = batch['image_available'].to(device)
            item_ids = batch['id'] # Keep track of IDs if needed

            # Forward pass
            outputs = model(input_ids, attention_mask, images, metadata, image_available)
            probabilities = torch.sigmoid(outputs).cpu().numpy()

            all_preds_proba.extend(probabilities)
            all_labels.extend(labels.cpu().numpy())
            all_ids.extend(item_ids) # Store IDs

    logging.info("Evaluation loop finished. Calculating metrics...")

    # --- Calculate Metrics ---
    all_labels = np.array(all_labels)
    all_preds_proba = np.array(all_preds_proba)
    all_preds_binary = (all_preds_proba >= 0.5).astype(int)

    accuracy = accuracy_score(all_labels, all_preds_binary)
    precision = precision_score(all_labels, all_preds_binary, zero_division=0)
    recall = recall_score(all_labels, all_preds_binary, zero_division=0)
    f1 = f1_score(all_labels, all_preds_binary, zero_division=0)
    try:
        auc = roc_auc_score(all_labels, all_preds_proba) # AUC uses probabilities
    except ValueError:
        auc = 0.0
        logging.warning("AUC calculation failed (likely only one class present in labels). Setting AUC to 0.0")

    cm = confusion_matrix(all_labels, all_preds_binary)
    class_report = classification_report(all_labels, all_preds_binary, zero_division=0, target_names=['Real', 'Fake']) # Assuming 0: Real, 1: Fake

    metrics = {
        "Accuracy": accuracy,
        "Precision": precision,
        "Recall": recall,
        "F1 Score": f1,
        "AUC": auc,
        "Confusion Matrix": cm,
        "Classification Report": class_report
    }

    # Optionally return predictions and IDs for further analysis
    # predictions_df = pd.DataFrame({'id': all_ids, 'label': all_labels, 'prediction_proba': all_preds_proba, 'prediction_binary': all_preds_binary})

    return metrics #, predictions_df


def plot_confusion_matrix(cm, class_names, output_path):
    """ Plots and saves the confusion matrix. """
    try:
        plt.figure(figsize=(8, 6))
        sns.heatmap(cm, annot=True, fmt='d', cmap='Blues', xticklabels=class_names, yticklabels=class_names)
        plt.title('Confusion Matrix')
        plt.ylabel('True Label')
        plt.xlabel('Predicted Label')
        plt.tight_layout()
        plt.savefig(output_path)
        plt.close()
        logging.info(f"Confusion matrix saved to {output_path}")
    except Exception as e:
        logging.error(f"Failed to plot or save confusion matrix: {e}")

# --- Argument Parser ---
def parse_args():
    parser = argparse.ArgumentParser(description="Evaluate a trained Multimodal Fake News Model.")
    parser.add_argument('--model_path', type=str, default=str(DEFAULT_MODEL_PATH),
                        help=f"Path to the trained model state dictionary (default: {DEFAULT_MODEL_PATH})")
    parser.add_argument('--scaler_path', type=str, default=str(DEFAULT_SCALER_PATH),
                        help=f"Path to the saved metadata scaler (default: {DEFAULT_SCALER_PATH})")
    parser.add_argument('--csv_path', type=str, default=str(CSV_PATH),
                        help=f"Path to the processed data CSV file (default: {CSV_PATH})")
    parser.add_argument('--batch_size', type=int, default=EVAL_BATCH_SIZE,
                        help=f"Batch size for evaluation (default: {EVAL_BATCH_SIZE})")
    parser.add_argument('--results_dir', type=str, default=str(RESULTS_DIR),
                        help=f"Directory to save evaluation results (default: {RESULTS_DIR})")
    return parser.parse_args()


# --- Main Evaluation Logic ---
def main():
    args = parse_args()
    eval_start_time = time.time()

    # Ensure results directory exists
    results_path = Path(args.results_dir)
    results_path.mkdir(parents=True, exist_ok=True)

    # 1. Setup Device
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    logging.info(f"Using device: {device}")

    # 2. Load Data and Split (Reproduce the test split)
    logging.info(f"Loading data from {args.csv_path}...")
    try:
        df = pd.read_csv(args.csv_path)
        # Perform the *exact same* split as in training
        # We only need the test_df here
        _, test_df = train_test_split(
            df,
            test_size=TEST_SPLIT,
            random_state=RANDOM_SEED,
            stratify=df['label'] # Ensure stratification is the same
        )
        logging.info(f"Test set size: {len(test_df)}")
    except FileNotFoundError:
        logging.error(f"FATAL: Processed CSV not found at {args.csv_path}. Cannot perform evaluation.")
        return
    except Exception as e:
         logging.error(f"FATAL: Error loading or splitting data: {e}")
         return

    # 3. Load Scaler
    logging.info(f"Loading metadata scaler from {args.scaler_path}...")
    try:
        metadata_scaler = joblib.load(args.scaler_path)
    except FileNotFoundError:
        logging.error(f"FATAL: Metadata scaler not found at {args.scaler_path}. Evaluation requires the scaler used during training.")
        # Option: Proceed without scaling metadata (might give poor results)
        # metadata_scaler = None
        # logging.warning("Proceeding without metadata scaling.")
        return # Exit if scaler is essential
    except Exception as e:
         logging.error(f"FATAL: Error loading scaler: {e}")
         return

    # 4. Setup Tokenizer and Transforms
    logging.info("Setting up tokenizer and image transforms...")
    tokenizer = get_tokenizer(TEXT_MODEL_NAME)
    # Use non-augmented transforms for evaluation
    image_transform = get_image_transforms(input_size=IMAGE_MODEL_INPUT_SIZE, augment=False)

    # 5. Create Test Dataset and DataLoader
    logging.info("Creating test Dataset and DataLoader...")
    try:
        test_dataset = MultimodalFakeNewsDataset(
            dataframe=test_df,
            data_dir=DATA_DIR, # Pass the base data dir
            tokenizer=tokenizer,
            image_transform=image_transform,
            max_len=MAX_TEXT_LEN, # Now uses the constant defined in this file
            metadata_cols=METADATA_COLS, # Now uses the constant defined in this file
            metadata_scaler=metadata_scaler # Use the loaded scaler (Corrected keyword argument)
        )
        test_loader = DataLoader(
            test_dataset,
            batch_size=args.batch_size,
            shuffle=False, # No shuffling for evaluation
            num_workers=2, # Adjust based on system
            pin_memory=True
        )
        logging.info("Test DataLoader created.")
    except Exception as e:
         logging.error(f"FATAL: Error creating test Dataset or DataLoader: {e}", exc_info=True)
         return

    # 6. Load Model
    logging.info("Loading model...")
    # Use the constants defined in this file to initialize the model structure
    model = MultimodalFakeNewsModel(
        text_model_name=TEXT_MODEL_NAME,
        image_model_name=IMAGE_MODEL_NAME,
        num_metadata_features=NUM_METADATA_FEATURES,
        text_embedding_dim=TEXT_EMBEDDING_DIM,
        img_embedding_dim=IMG_EMBEDDING_DIM,
        metadata_embedding_dim=METADATA_EMBEDDING_DIM,
        fusion_output_dim=FUSION_OUTPUT_DIM
    )

    logging.info(f"Loading model state from: {args.model_path}")
    try:
        model.load_state_dict(torch.load(args.model_path, map_location=device)) # Load to target device
        model.to(device)
        logging.info("Model loaded successfully.")
    except FileNotFoundError:
        logging.error(f"FATAL: Model file not found at {args.model_path}. Cannot perform evaluation.")
        return
    except Exception as e:
        logging.error(f"FATAL: Error loading model state: {e}")
        return

    # 7. Perform Evaluation
    metrics = evaluate(model, test_loader, device)

    # 8. Display and Save Results
    logging.info("\n--- Test Set Evaluation Results ---")
    print(f"Accuracy: {metrics['Accuracy']:.4f}")
    print(f"Precision: {metrics['Precision']:.4f}")
    print(f"Recall: {metrics['Recall']:.4f}")
    print(f"F1 Score: {metrics['F1 Score']:.4f}")
    print(f"AUC: {metrics['AUC']:.4f}")
    print("\nClassification Report:")
    print(metrics['Classification Report'])
    print("\nConfusion Matrix:")
    print(metrics['Confusion Matrix'])
    logging.info("------------------------------------")

    # Save results to files
    results_file_path = results_path / "evaluation_metrics.txt"
    cm_plot_path = results_path / "confusion_matrix.png"

    try:
        with open(results_file_path, "w", encoding="utf-8") as f:
            f.write("--- Test Set Evaluation Results ---\n")
            f.write(f"Model Path: {args.model_path}\n")
            f.write(f"Scaler Path: {args.scaler_path}\n")
            f.write(f"Data CSV: {args.csv_path}\n")
            f.write(f"Evaluation Time: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("------------------------------------\n")
            f.write(f"Accuracy: {metrics['Accuracy']:.4f}\n")
            f.write(f"Precision: {metrics['Precision']:.4f}\n")
            f.write(f"Recall: {metrics['Recall']:.4f}\n")
            f.write(f"F1 Score: {metrics['F1 Score']:.4f}\n")
            f.write(f"AUC: {metrics['AUC']:.4f}\n\n")
            f.write("Classification Report:\n")
            f.write(metrics['Classification Report'])
            f.write("\n\nConfusion Matrix:\n")
            f.write(np.array2string(metrics['Confusion Matrix']))
        logging.info(f"Evaluation metrics saved to {results_file_path}")

        # Plot and save confusion matrix
        plot_confusion_matrix(metrics['Confusion Matrix'], class_names=['Real', 'Fake'], output_path=cm_plot_path)

    except Exception as e:
        logging.error(f"Error saving evaluation results: {e}")

    eval_duration = time.time() - eval_start_time
    logging.info(f"Total evaluation script duration: {eval_duration / 60:.2f} minutes")


if __name__ == '__main__':
    main()

================================================================================
文件路径: scripts\preprocess_data.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\scripts\preprocess_data.py
================================================================================

import os
import pandas as pd
from PIL import Image, UnidentifiedImageError
import re
from tqdm import tqdm
import logging
import json # Added for reading JSON files
import requests # Added for downloading images from URL
from io import BytesIO # Added for handling image data in memory

# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Define base paths
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
DATA_DIR = os.path.join(BASE_DIR, 'data')
OUTPUT_DIR = os.path.join(DATA_DIR, 'processed')
IMAGE_OUTPUT_DIR = os.path.join(OUTPUT_DIR, 'images')

# Create output directories if they don't exist
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs(IMAGE_OUTPUT_DIR, exist_ok=True)

# --- Configuration ---
TARGET_IMAGE_SIZE = (224, 224) # Example size for many CNNs

# --- Text Cleaning Function ---
def clean_text(text):
    """Basic text cleaning: remove URLs, mentions, hashtags, and extra whitespace."""
    if not isinstance(text, str):
        return ""
    text = re.sub(r'http\\S+|www\\S+|https\\S+', '', text, flags=re.MULTILINE) # Remove URLs
    text = re.sub(r'\\@\\w+', '', text) # Remove mentions
    text = re.sub(r'#\\w+', '', text) # Remove hashtags
    # Remove specific Weibo artifacts like [超话] markers if needed
    text = re.sub(r'\\[.*?]', '', text) # Remove text within square brackets
    text = re.sub(r'\\s+', ' ', text).strip() # Remove extra whitespace
    # Add more specific cleaning rules if needed
    return text

# --- Image Processing Function ---
def process_image(image_path, output_dir, item_id):
    """Loads, resizes, normalizes (saves), and returns the path to the processed image."""
    # Check if image_path is a URL (simple check)
    is_url = isinstance(image_path, str) and (image_path.startswith('http://') or image_path.startswith('https://'))

    try:
        if is_url:
            # --- Download image from URL --- 
            logging.debug(f"Attempting to download image: {image_path}")
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
            
            # Check if it's a sinaimg URL and use Baidu proxy if needed
            download_url = image_path
            if 'sinaimg.cn' in image_path:
                download_url = f"https://image.baidu.com/search/down?url={image_path}"
                logging.debug(f"Using Baidu proxy for sinaimg URL: {download_url}")
            
            try:
                # Use the potentially modified download_url
                response = requests.get(download_url, timeout=20, headers=headers, stream=True) # Increased timeout slightly for proxy
                response.raise_for_status() # Raise an exception for bad status codes (4xx or 5xx)
                
                # Check content type if possible
                content_type = response.headers.get('content-type')
                if content_type and 'image' not in content_type.lower():
                     logging.warning(f"URL content-type doesn't look like an image ({content_type}): {image_path}")
                     # Decide whether to skip or try opening anyway
                     # return None # Option to skip non-image content types

                # Open image from response content
                img = Image.open(BytesIO(response.content)).convert('RGB')
            except requests.exceptions.Timeout:
                logging.error(f"Timeout downloading image {image_path}")
                return None
            except requests.exceptions.RequestException as e:
                logging.error(f"Error downloading image {image_path}: {e}")
                return None
            except UnidentifiedImageError: # Catch error if content is not a valid image format Pillow understands
                 logging.error(f"Downloaded content from {image_path} is not a valid image format.")
                 return None
        else:
            # Assume it's a local path
            if not os.path.exists(image_path):
                 logging.warning(f"Local image path not found: {image_path}")
                 return None
            img = Image.open(image_path).convert('RGB') # Ensure 3 channels

        img_resized = img.resize(TARGET_IMAGE_SIZE, Image.Resampling.LANCZOS)

        # Create a unique filename for the processed image
        base_filename = os.path.basename(image_path)
        # Clean potential query parameters from URL filenames
        if is_url:
             base_filename = base_filename.split('?')[0]
             
        file_ext = os.path.splitext(base_filename)[1]
        # Handle URLs potentially missing extensions or having query params
        if not file_ext or len(file_ext) > 5 : # Basic check for missing or weird extension
             # Try to guess extension from content type if downloaded, or default to .jpg
             if is_url and content_type:
                 if 'jpeg' in content_type.lower() or 'jpg' in content_type.lower(): file_ext = '.jpg'
                 elif 'png' in content_type.lower(): file_ext = '.png'
                 elif 'gif' in content_type.lower(): file_ext = '.gif'
                 elif 'bmp' in content_type.lower(): file_ext = '.bmp'
                 elif 'webp' in content_type.lower(): file_ext = '.webp'
                 else: file_ext = '.jpg' # Default if type is image/* but not recognized
             else:
                 file_ext = '.jpg' # Default extension if local or content type unknown

        # Sanitize item_id if it contains path separators
        sanitized_item_id = item_id.replace(os.path.sep, '_').replace(':','_') # Also replace colons
        output_filename = f"{sanitized_item_id}{file_ext}"
        output_path = os.path.join(output_dir, output_filename)

        img_resized.save(output_path)
        return os.path.join('processed/images', output_filename) # Return relative path for the final DataFrame

    except FileNotFoundError: # Catch case where local file doesn't exist even after check (race condition?)
        logging.warning(f"Image not found (processing local path): {image_path}")
        return None
    except UnidentifiedImageError: # Catch error if local file is not a valid image format
        logging.error(f"Local file {image_path} is not a valid image format.")
        return None
    except Exception as e:
        # Catch other PIL errors or unexpected issues
        logging.error(f"Error processing image {image_path}: {e}", exc_info=True)
        return None

# --- Dataset Specific Loaders ---

def load_mcfend(data_dir, image_output_dir):
    """Loads and preprocesses data from the mcfend dataset using provided structure."""
    logging.info("Processing mcfend dataset with provided structure...")
    processed_data = []
    news_path = os.path.join(data_dir, 'mcfend', 'news.csv')
    context_path = os.path.join(data_dir, 'mcfend', 'social_context.csv')
    user_path = os.path.join(data_dir, 'mcfend', 'user.csv')

    required_files = {'news': news_path, 'context': context_path, 'user': user_path}
    for name, path in required_files.items():
        if not os.path.exists(path):
            logging.error(f"mcfend required file not found: {path} ({name}.csv)")
            return []

    # --- 1. Load User Data --- 
    logging.info("Loading user data...")
    user_df = None
    try:
        # Assuming user.csv is manageable in memory (40MB)
        user_df = pd.read_csv(user_path, index_col='user_id') # Index by user_id for quick lookup
        # Select and rename relevant columns
        user_df = user_df[['follower_count', 'following_count', 'post_count', 'have_verification']]
        user_df.rename(columns={
            'follower_count': 'user_followers',
            'following_count': 'user_following',
            'post_count': 'user_posts',
            'have_verification': 'user_verified'
        }, inplace=True)
        # Convert verification status to numeric (e.g., 1 for verified, 0 otherwise)
        user_df['user_verified'] = user_df['user_verified'].apply(lambda x: 1 if isinstance(x, str) and x.lower() == 'verified' else 0)
        logging.info(f"Loaded {len(user_df)} user records.")
    except Exception as e:
        logging.error(f"Failed to load or process user.csv: {e}")
        return [] # Cannot proceed without user data if we want user features

    # --- 2. Aggregate Social Context Features --- 
    logging.info("Aggregating social context features (this may take time)...")
    social_features = {}
    poster_info = {} # To store the user_id of the original post for each news_id
    context_chunk_size = 50000 # Adjust based on memory
    try:
        for chunk in tqdm(pd.read_csv(context_path, chunksize=context_chunk_size, low_memory=False), desc="Processing context chunks"):
            # Fill NaN in numeric columns needed for aggregation
            num_cols_to_fill = ['like_count', 'cmt_count', 'repost_count', 'view_count']
            for col in num_cols_to_fill:
                 if col in chunk.columns:
                     chunk[col] = pd.to_numeric(chunk[col], errors='coerce').fillna(0)
                 else:
                      logging.warning(f"Column '{col}' not found in context chunk. Filling with 0.")
                      chunk[col] = 0 
            
            # Group by news_id within the chunk
            # Note: Summing view_count might be inaccurate if provided per comment/repost
            # Consider taking max or first value if view_count applies only to original post.
            # For now, we sum, assuming it represents engagement on related items.
            grouped = chunk.groupby('news_id')
            
            # Aggregate counts
            agg_data = grouped.agg({
                'like_count': 'sum',
                'cmt_count': 'sum',
                'repost_count': 'sum',
                'view_count': 'sum' # Or 'max' or custom logic
            })

            # Try to get the user_id of the original post ('posts')
            original_posts = chunk[chunk['type'] == 'posts']
            posters = original_posts.groupby('news_id')['user_id'].first() # Get the first user listed for a news_id post

            # Update the global aggregation dictionaries
            for news_id, features in agg_data.iterrows():
                if news_id not in social_features:
                    social_features[news_id] = features.copy()
                else:
                    social_features[news_id] += features # Add counts from chunk
            
            for news_id, user_id in posters.items():
                 if news_id not in poster_info:
                      poster_info[news_id] = user_id # Store the first identified poster

        # Convert aggregated data to DataFrame for easier merging later
        social_features_df = pd.DataFrame.from_dict(social_features, orient='index')
        social_features_df.rename(columns={
            'like_count': 'total_likes',
            'cmt_count': 'total_comments',
            'repost_count': 'total_reposts',
            'view_count': 'total_views' # Or max_views etc.
        }, inplace=True)
        logging.info(f"Aggregated social features for {len(social_features_df)} news items.")

    except Exception as e:
        logging.error(f"Failed during social context aggregation: {e}")
        # Decide if we want to proceed without social features
        logging.warning("Proceeding without aggregated social context features.")
        social_features_df = pd.DataFrame() # Create empty df

    # --- 3. Process News Data and Merge Features --- 
    logging.info("Processing news data and merging features...")
    news_chunk_size = 10000 # Adjust as needed
    label_map = {'谣言': 1, '事实': 0, '尚无定论': 1} # Map '尚无定论' to 1 (Fake/Rumor)
    
    try:
        for chunk in tqdm(pd.read_csv(news_path, chunksize=news_chunk_size, low_memory=False), desc="Processing news chunks"):
            # Join social features (if available)
            if not social_features_df.empty:
                 chunk = chunk.join(social_features_df, on='news_id')
            else: # Add empty columns if social features failed
                 for col in ['total_likes', 'total_comments', 'total_reposts', 'total_views']:
                      chunk[col] = 0

            # Add user features based on poster_info and user_df
            def get_user_features(news_id):
                poster_user_id = poster_info.get(news_id)
                if poster_user_id and poster_user_id in user_df.index:
                    return user_df.loc[poster_user_id]
                # Return default values if poster not found or user data missing
                return pd.Series({'user_followers': 0, 'user_following': 0, 'user_posts': 0, 'user_verified': 0})

            user_features_chunk = chunk['news_id'].apply(get_user_features)
            chunk = pd.concat([chunk, user_features_chunk], axis=1)

            # Fill NaNs in added feature columns with 0
            feature_cols = ['total_likes', 'total_comments', 'total_reposts', 'total_views',
                            'user_followers', 'user_following', 'user_posts', 'user_verified']
            for col in feature_cols:
                if col in chunk.columns:
                    chunk[col] = chunk[col].fillna(0).astype(int) # Fill NaN and ensure integer type
                else:
                    chunk[col] = 0 # Add column if it wasn't created (e.g., join failed)
            
            # Process each row in the enriched chunk
            for _, row in chunk.iterrows():
                news_id_val = row['news_id']
                # Use 'content' if available, fallback to 'title'?
                text_content_val = row.get('content', row.get('title', '')) 
                label_str = row.get('label', None)
                pic_url_val = row.get('pic_url', None)

                # Map label
                label = label_map.get(label_str)
                if label is None:
                    logging.warning(f"Unknown label '{label_str}' for mcfend news {news_id_val}. Skipping.")
                    continue

                item_id = f"mcfend_{news_id_val}"
                text = clean_text(text_content_val)

                processed_image_rel_path = None
                if pic_url_val and isinstance(pic_url_val, str) and pic_url_val.startswith('http'):
                    # Image processing logic (needs requests + uncommenting in process_image)
                    processed_image_rel_path = process_image(pic_url_val, image_output_dir, item_id)
                
                if text: # Require text
                    data_entry = {
                        'id': item_id,
                        'text': text,
                        'image_path': processed_image_rel_path, # Path or None
                        'label': label,
                        'source': 'mcfend',
                        # Add aggregated features
                        'total_likes': row['total_likes'],
                        'total_comments': row['total_comments'],
                        'total_reposts': row['total_reposts'],
                        'total_views': row['total_views'],
                        'user_followers': row['user_followers'],
                        'user_following': row['user_following'],
                        'user_posts': row['user_posts'],
                        'user_verified': row['user_verified']
                    }
                    processed_data.append(data_entry)
                else:
                    logging.warning(f"Skipping mcfend item {item_id} due to missing text content after cleaning.")
                    
    except Exception as e:
        logging.error(f"Error processing news chunks and merging features: {e}")

    logging.info(f"Finished processing mcfend. Found {len(processed_data)} valid items with features.")
    return processed_data


def load_rumor_acl2017(data_dir, image_output_dir):
    """Loads and preprocesses data from the rumor_detection_acl2017 dataset."""
    logging.info("Processing rumor_detection_acl2017 dataset...")
    processed_data = []
    base_path = os.path.join(data_dir, 'rumor_detection_acl2017')
    subsets = ['twitter15', 'twitter16']

    label_map = {'non-rumor': 0, 'false': 1, 'true': 1, 'unverified': 1} # Mapping based on common conventions, adjust if needed

    for subset in subsets:
        subset_path = os.path.join(base_path, subset)
        label_file = os.path.join(subset_path, 'label.txt')
        tweet_file = os.path.join(subset_path, 'source_tweets.txt')

        if not os.path.exists(label_file) or not os.path.exists(tweet_file):
            logging.warning(f"Skipping subset {subset}: missing label.txt or source_tweets.txt")
            continue

        logging.info(f"Processing subset: {subset}")

        # Load labels into a dictionary {tweet_id: label}
        labels = {}
        try:
            with open(label_file, 'r', encoding='utf-8') as f:
                for line in f:
                    try:
                        label_str, tweet_id_str = line.strip().split(':')
                        # Map string label to integer using label_map
                        numeric_label = label_map.get(label_str.lower())
                        if numeric_label is not None:
                           labels[tweet_id_str] = numeric_label
                        else:
                           logging.warning(f"Unknown label '{label_str}' for tweet {tweet_id_str} in {subset}. Skipping.")
                    except ValueError:
                        logging.warning(f"Malformed line in {label_file}: {line.strip()}. Skipping.")
        except Exception as e:
             logging.error(f"Error reading label file {label_file}: {e}")
             continue # Skip this subset if labels can't be read

        # Load tweets and combine with labels
        try:
            with open(tweet_file, 'r', encoding='utf-8') as f:
                for line in tqdm(f, desc=f"Processing {subset} tweets"):
                    try:
                        tweet_id_str, text_content = line.strip().split('\t', 1)
                    except ValueError:
                         logging.warning(f"Malformed line in {tweet_file}: {line.strip()}. Skipping.")
                         continue

                    if tweet_id_str in labels:
                        item_id = f"acl2017_{subset}_{tweet_id_str}"
                        text = clean_text(text_content)
                        label = labels[tweet_id_str]

                        # This dataset has no images according to README
                        processed_image_rel_path = None

                        if text: # Only need text and label here
                            processed_data.append({
                                'id': item_id,
                                'text': text,
                                'image_path': processed_image_rel_path, # Will be None
                                'label': label,
                                'source': f'acl2017_{subset}'
                            })
                    else:
                        # This case should ideally not happen if files are consistent
                        logging.warning(f"Tweet ID {tweet_id_str} found in tweets but not in labels for {subset}. Skipping.")
        except Exception as e:
             logging.error(f"Error reading tweet file {tweet_file}: {e}")
             continue # Skip this subset if tweets can't be read

    logging.info(f"Finished processing rumor_detection_acl2017. Found {len(processed_data)} valid items.")
    return processed_data


def load_socialnet(data_dir, image_output_dir):
    """Loads and preprocesses data from the SocialNet dataset (TikTok, Weibo V1, Weibo V2)."""
    logging.info("Processing SocialNet dataset (TikTok, Weibo V1, Weibo V2)...")
    processed_data = []
    socialnet_base = os.path.join(data_dir, 'SocialNet')

    platforms = {
        'TikTok': {'path': os.path.join(socialnet_base, 'TikTok')},
        'Weibo': {'path': os.path.join(socialnet_base, 'Weibo')}
    }

    for platform_name, platform_info in platforms.items():
        platform_path = platform_info['path']
        if not os.path.isdir(platform_path):
            logging.warning(f"Platform directory not found: {platform_path}")
            continue
        logging.info(f"--- Processing Platform: {platform_name} ---")

        # Check for Weibo V1/V2 structure
        versions = [''] # Default for TikTok or if no V1/V2 folders
        if platform_name == 'Weibo':
            if os.path.isdir(os.path.join(platform_path, 'V1')) or os.path.isdir(os.path.join(platform_path, 'V2')):
                versions = [v for v in ['V1', 'V2'] if os.path.isdir(os.path.join(platform_path, v))]
                logging.info(f"Found Weibo versions: {versions}")
            else:
                logging.warning(f"Could not find V1 or V2 subdirectories in {platform_path}. Skipping Weibo.")
                continue

        for version in versions:
            version_path = os.path.join(platform_path, version) # version might be empty for TikTok
            logging.info(f"Processing {platform_name} {version}...")
            
            categories = {'real_news': 0, 'fake_news': 1}
            for category, label in categories.items():
                category_path = os.path.join(version_path, category)
                if not os.path.isdir(category_path):
                    logging.warning(f"Category directory not found: {category_path}")
                    continue

                logging.info(f"Scanning category: {category}")
                item_ids = [d for d in os.listdir(category_path) if os.path.isdir(os.path.join(category_path, d))]

                for item_dir_name in tqdm(item_ids, desc=f"Processing {platform_name} {version} {category}"):
                    item_path = os.path.join(category_path, item_dir_name)
                    # Corrected filename for Weibo (and assuming TikTok also uses news.json or new.json)
                    json_filename = 'new.json' if platform_name == 'Weibo' else 'news.json' # Use new.json for Weibo
                    json_file_path = os.path.join(item_path, json_filename)
                    item_id = f"socialnet_{platform_name.lower()}{version.lower()}_{item_dir_name}"

                    if not os.path.exists(json_file_path):
                        logging.warning(f"{json_filename} not found in {item_path}. Skipping.")
                        continue

                    try:
                        with open(json_file_path, 'r', encoding='utf-8') as f:
                            data = json.load(f)

                        # Initialize common fields
                        text = ""
                        processed_image_rel_path = None
                        features = {
                            'total_likes': 0, 'total_comments': 0, 'total_reposts': 0, 'total_views': 0,
                            'user_followers': 0, 'user_following': 0, 'user_posts': 0, 'user_verified': 0,
                            'user_total_favorited': 0 # TikTok specific?
                        }

                        # --- Platform/Version Specific Parsing ---
                        if platform_name == 'TikTok':
                            aweme = data.get('aweme_detail', {})
                            text = clean_text(aweme.get('desc', ''))
                            
                            # Image: Use video cover
                            video_info = aweme.get('video')
                            if video_info and isinstance(video_info, dict):
                                cover_info = video_info.get('cover')
                                if cover_info and isinstance(cover_info, dict) and cover_info.get('url_list'):
                                     raw_image_path = cover_info['url_list'][0]
                                     if isinstance(raw_image_path, str) and raw_image_path.startswith('http'):
                                          logging.debug(f"Found TikTok video cover URL for {item_id}: {raw_image_path}")
                                          processed_image_rel_path = process_image(raw_image_path, image_output_dir, f"{item_id}_cover")
                            
                            # Features
                            author_info = aweme.get('author', {})
                            stats_info = aweme.get('statistics', {})
                            features['user_followers'] = int(author_info.get('follower_count', 0))
                            features['user_following'] = int(author_info.get('following_count', 0))
                            features['user_total_favorited'] = int(author_info.get('total_favorited', 0)) # Author's total favorited count
                            # User verification status seems complex or missing in example, default to 0
                            features['total_likes'] = int(stats_info.get('digg_count', 0))
                            features['total_comments'] = int(stats_info.get('comment_count', 0))
                            features['total_reposts'] = int(stats_info.get('share_count', 0)) # Map shares to reposts

                        elif platform_name == 'Weibo':
                            if version == 'V1':
                                text = clean_text(data.get('context', '')) # Needs careful cleaning
                                # No image info in V1 example
                                features['total_likes'] = int(str(data.get('like_num', '0')).replace('\'','')) # Handle potential quotes
                                features['total_comments'] = int(str(data.get('comment_num', '0')).replace('\'',''))
                                # Other features missing

                            elif version == 'V2':
                                text = clean_text(data.get('text_raw', ''))
                                
                                # Image: Prioritize pic_ids if available, else page_pic
                                pic_ids = data.get('pic_ids')
                                pic_infos = data.get('pic_infos')
                                
                                if pic_ids and isinstance(pic_ids, list) and len(pic_ids) > 0 and pic_infos and isinstance(pic_infos, dict):
                                    first_pic_id = pic_ids[0]
                                    if first_pic_id in pic_infos:
                                        info = pic_infos[first_pic_id]
                                        # Prioritize larger image sizes
                                        image_url = None
                                        for size_key in ['largest', 'large', 'mw2000', 'original', 'bmiddle', 'thumbnail']:
                                            if size_key in info and info[size_key].get('url'):
                                                image_url = info[size_key]['url']
                                                logging.debug(f"Found Weibo V2 image URL (size: {size_key}) for pic_id {first_pic_id}: {image_url}")
                                                break # Stop at the first found URL in priority order
                                        
                                        if image_url and isinstance(image_url, str) and image_url.startswith('http'):
                                            # Pass the extracted URL to process_image
                                            # process_image will handle the Baidu proxy if needed
                                            processed_image_rel_path = process_image(image_url, image_output_dir, f"{item_id}_pic0")
                                        else:
                                            logging.warning(f"Could not extract a valid URL for pic_id {first_pic_id} from pic_infos.")
                                    else:
                                        logging.warning(f"pic_id {first_pic_id} not found in pic_infos for {item_id}.")
                                # Remove the old placeholder warning
                                # logging.warning(f"Found pic_ids for {item_id}, but URL construction logic is missing. Skipping image from pic_ids.")

                                # If no image processed from pic_ids, check page_info for video preview ('page_pic')
                                if not processed_image_rel_path and 'page_info' in data and isinstance(data['page_info'], dict):
                                    page_info = data['page_info']
                                    if page_info.get('object_type') == 'video' and 'page_pic' in page_info:
                                        raw_image_path = page_info['page_pic'] # This is likely a URL
                                        if isinstance(raw_image_path, str) and raw_image_path.startswith('http'):
                                            logging.debug(f"Found Weibo V2 video preview image URL for {item_id}: {raw_image_path}")
                                            processed_image_rel_path = process_image(raw_image_path, image_output_dir, f"{item_id}_preview")
                                        else:
                                            logging.warning(f"Found page_pic for {item_id}, but it's not a valid URL: {raw_image_path}")
                                
                                # Features
                                user_info = data.get('user', {})
                                features['user_followers'] = int(user_info.get('followers_count', 0))
                                features['user_following'] = int(user_info.get('friends_count', 0)) # Weibo uses 'friends_count'
                                features['user_posts'] = int(user_info.get('statuses_count', 0))
                                features['user_verified'] = 1 if user_info.get('verified', False) else 0
                                features['total_likes'] = int(data.get('attitudes_count', 0))
                                features['total_comments'] = int(data.get('comments_count', 0))
                                features['total_reposts'] = int(data.get('reposts_count', 0))
                                # total_views missing in V2 JSON
                        # --- End Platform Specific Parsing ---

                        if text: # Require at least text
                            data_entry = {
                                'id': item_id,
                                'text': text,
                                'image_path': processed_image_rel_path, # Path or None
                                'label': label,
                                'source': f'socialnet_{platform_name.lower()}{version.lower()}_{category}'
                            }
                            data_entry.update(features) # Add all extracted features
                            processed_data.append(data_entry)
                        else:
                            logging.warning(f"Skipping {item_id} due to missing text content after cleaning.")

                    except json.JSONDecodeError:
                        logging.error(f"Error decoding JSON: {json_file_path}")
                    except Exception as e:
                         logging.error(f"Error processing item {item_dir_name} in {category_path}: {e}", exc_info=True)

    logging.info(f"Finished processing SocialNet. Found {len(processed_data)} potentially valid items.")
    return processed_data


# --- Main Execution ---
if __name__ == "__main__":
    all_data = []

    # Load and process each dataset
    all_data.extend(load_mcfend(DATA_DIR, IMAGE_OUTPUT_DIR))
    all_data.extend(load_rumor_acl2017(DATA_DIR, IMAGE_OUTPUT_DIR))
    all_data.extend(load_socialnet(DATA_DIR, IMAGE_OUTPUT_DIR))

    if not all_data:
        logging.warning("No data successfully processed from any source. Exiting.")
    else:
        # Convert to DataFrame
        df_processed = pd.DataFrame(all_data)

        # --- Data Cleaning/Filtering Post-Processing ---
        # Define all potential feature columns from all sources
        feature_cols = [
            'total_likes', 'total_comments', 'total_reposts', 'total_views',
            'user_followers', 'user_following', 'user_posts', 'user_verified',
            'user_total_favorited' # Added from TikTok
        ]
        # Fill NaNs in feature columns that might exist only in some sources
        for col in feature_cols:
             if col in df_processed.columns:
                 # Fill NaN first, then convert to int. Handle potential non-numeric gracefully.
                 df_processed[col] = pd.to_numeric(df_processed[col].fillna(0), errors='coerce').fillna(0).astype(int)
             else: # Add column with 0 if it doesn't exist
                  df_processed[col] = 0

        initial_count = len(df_processed)
        # Optional: Remove rows where image processing failed if an image is strictly required
        # df_processed = df_processed.dropna(subset=['image_path']) 
        # logging.info(f"Removed {initial_count - len(df_processed)} items with missing/failed images.")

        # Remove rows with empty text
        df_processed = df_processed[df_processed['text'].astype(str).str.len() > 0]
        logging.info(f"Removed {len(df_processed) - initial_count} items with empty text after cleaning.") # Corrected log message

        # Ensure correct types for final output (optional but good practice)
        df_processed['label'] = df_processed['label'].astype(int)
        # image_path can be object/string (contains None/paths)

        # Save the processed data manifest
        output_csv_path = os.path.join(OUTPUT_DIR, 'processed_data.csv')
        try:
            # Use utf-8-sig for better Excel compatibility with Chinese characters
            df_processed.to_csv(output_csv_path, index=False, encoding='utf-8-sig')
            logging.info(f"Successfully processed and saved {len(df_processed)} items.")
            logging.info(f"Processed data manifest saved to: {output_csv_path}")
            logging.info(f"Processed images (if any) saved in: {IMAGE_OUTPUT_DIR}")
        except Exception as e:
             logging.error(f"Failed to save processed data to CSV: {e}")

        # Display basic statistics
        if not df_processed.empty:
            logging.info("\n--- Final Data Statistics ---")
            logging.info(f"Total items: {len(df_processed)}")
            logging.info("Label distribution:")
            logging.info(df_processed['label'].value_counts())
            logging.info("\nSource distribution:")
            logging.info(df_processed['source'].value_counts())
            # Add stats for new features
            logging.info("\nFeature statistics (mean):")
            # Calculate mean only for existing columns to avoid errors if a feature column is all 0s
            existing_feature_cols = [col for col in feature_cols if col in df_processed.columns]
            if existing_feature_cols:
                 logging.info(df_processed[existing_feature_cols].mean().to_string())
            else:
                 logging.info("No feature columns found to calculate statistics.")
            logging.info("---------------------------\n")
        else:
             logging.warning("Final DataFrame is empty. No statistics to display.")

    logging.info("Data preprocessing script finished.") 

================================================================================
文件路径: scripts\setup_db.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\scripts\setup_db.py
================================================================================

#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
数据库初始化脚本
"""
import os
import sys
import MySQLdb
import getpass
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

# 默认配置
DEFAULT_CONFIG = {
    'HOST': os.getenv('DATABASE_HOST', 'localhost'),
    'PORT': int(os.getenv('DATABASE_PORT', 3306)),
    'USER': os.getenv('DATABASE_USER', 'root'),
    'PASSWORD': os.getenv('DATABASE_PASSWORD', 'root'),
    'DB_NAME': os.getenv('DATABASE_NAME', 'mmdfd'),
    'CHARSET': 'utf8mb4'
}

def create_database(config):
    """创建数据库和用户"""
    try:
        # 连接到MySQL服务器
        conn = MySQLdb.connect(
            host=config['HOST'],
            port=config['PORT'],
            user=config['USER'],
            password=config['PASSWORD']
        )
        cursor = conn.cursor()
        
        # 创建数据库
        print(f"创建数据库: {config['DB_NAME']}...")
        cursor.execute(f"CREATE DATABASE IF NOT EXISTS {config['DB_NAME']} DEFAULT CHARACTER SET {config['CHARSET']}")
        
        # 创建用户并授权
        if config['USER'] != 'root':
            cursor.execute(f"CREATE USER IF NOT EXISTS '{config['USER']}'@'%' IDENTIFIED BY '{config['PASSWORD']}'")
            cursor.execute(f"GRANT ALL PRIVILEGES ON {config['DB_NAME']}.* TO '{config['USER']}'@'%'")
            cursor.execute("FLUSH PRIVILEGES")
        
        print("数据库初始化成功！")
        conn.close()
        return True
    except MySQLdb.Error as e:
        print(f"错误: {e}")
        return False

def main():
    """主函数"""
    print("==== 多模态深度学习社交媒体虚假新闻检测系统 - 数据库初始化 ====")
    
    # 使用默认配置或询问用户输入
    config = DEFAULT_CONFIG.copy()
    if '--interactive' in sys.argv:
        config['HOST'] = input(f"MySQL主机地址 [{config['HOST']}]: ") or config['HOST']
        port_input = input(f"MySQL端口 [{config['PORT']}]: ") or str(config['PORT'])
        config['PORT'] = int(port_input)
        config['USER'] = input(f"MySQL用户名 [{config['USER']}]: ") or config['USER']
        config['PASSWORD'] = getpass.getpass(f"MySQL密码: ") or config['PASSWORD']
        config['DB_NAME'] = input(f"数据库名称 [{config['DB_NAME']}]: ") or config['DB_NAME']
    
    # 创建数据库
    success = create_database(config)
    
    # 将配置保存到.env文件供Django使用
    if success and '--save-env' in sys.argv:
        with open('../backend/.env', 'w', encoding='utf-8') as f:
            f.write(f"DATABASE_HOST={config['HOST']}\n")
            f.write(f"DATABASE_PORT={config['PORT']}\n")
            f.write(f"DATABASE_NAME={config['DB_NAME']}\n")
            f.write(f"DATABASE_USER={config['USER']}\n")
            f.write(f"DATABASE_PASSWORD={config['PASSWORD']}\n")
        print("配置已保存到 backend/.env 文件")

if __name__ == "__main__":
    main() 

================================================================================
文件路径: scripts\train_model.py
完整路径: C:\Users\lateyoung\Desktop\MM-DFD\scripts\train_model.py
================================================================================

# scripts/train_model.py

import os
import pandas as pd
import numpy as np
import torch
import torch.nn as nn
import torch.optim as optim
from torch.utils.data import DataLoader, Subset
from torch.optim.lr_scheduler import ReduceLROnPlateau
from torchvision.models import resnet50, ResNet50_Weights
from transformers import AutoModel, AutoTokenizer
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, precision_recall_fscore_support, roc_auc_score
from pathlib import Path
import logging
import time
from tqdm import tqdm

# Import the modified Dataset (不包含 metadata)
from data_loader import MultimodalFakeNewsDataset, get_tokenizer, get_image_transforms

# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Configuration (移除 Metadata 相关) ---
BASE_DIR = Path(__file__).parent.parent
DATA_DIR = BASE_DIR / 'data'
PROCESSED_DIR = DATA_DIR / 'processed'
CSV_PATH = PROCESSED_DIR / 'processed_data.csv'
OUTPUT_DIR = BASE_DIR / 'models' 
OUTPUT_DIR.mkdir(exist_ok=True)
# SCALER_PATH = OUTPUT_DIR / 'metadata_scaler.joblib' # 移除 Scaler 路径
# BEST_MODEL_PATH = OUTPUT_DIR / 'best_multimodal_model.pth' # 可以重命名，避免覆盖旧模型
BEST_MODEL_PATH = OUTPUT_DIR / 'best_text_image_model.pth' 

TEXT_MODEL_NAME = 'bert-base-chinese'
IMAGE_MODEL_NAME = 'resnet50'
IMAGE_MODEL_INPUT_SIZE = 224
MAX_TEXT_LEN = 128
# NUM_METADATA_FEATURES = 0 # 移除
IMG_EMBEDDING_DIM = 2048 
TEXT_EMBEDDING_DIM = 768 
# METADATA_EMBEDDING_DIM = 0 # 移除
FUSION_OUTPUT_DIM = 256 

EPOCHS = 20 
BATCH_SIZE = 32 
LEARNING_RATE_ENCODERS = 1e-5 
LEARNING_RATE_HEAD = 1e-4 
WEIGHT_DECAY = 0.01
VALIDATION_SPLIT = 0.15 
TEST_SPLIT = 0.15 
RANDOM_SEED = 42
EARLY_STOPPING_PATIENCE = 3 
LR_SCHEDULER_PATIENCE = 1 
LR_SCHEDULER_FACTOR = 0.1 

# --- Model Definition (移除 MetadataEncoder 和相关逻辑) ---

# 移除 MetadataEncoder 类
# class MetadataEncoder(nn.Module): ...

class MultimodalFakeNewsModel(nn.Module):
    """
    Multimodal model combining text and image.
    (Modified to exclude metadata)
    """
    # 移除 num_metadata_features, metadata_embedding_dim 参数
    def __init__(self, text_model_name, image_model_name,
                 text_embedding_dim, img_embedding_dim,
                 fusion_output_dim, freeze_encoders=False):
        super().__init__()
        logging.info("Initializing Text-Image Multimodal Model...")

        # Text Encoder (保持不变)
        logging.info(f"Loading text model: {text_model_name}")
        self.text_encoder = AutoModel.from_pretrained(text_model_name)

        # Image Encoder (保持不变)
        logging.info(f"Loading image model: {image_model_name}")
        if image_model_name == 'resnet50':
            weights = ResNet50_Weights.IMAGENET1K_V2
            self.image_encoder = resnet50(weights=weights)
            self.image_encoder.fc = nn.Identity()
            self.img_embedding_dim = IMG_EMBEDDING_DIM
            self.image_transform = weights.transforms()
            self.image_input_size = 224
            logging.info(f"Using standard ResNet50 transforms (input size {self.image_input_size})")
        else:
            raise ValueError(f"Image model '{image_model_name}' not currently supported.")
        
        # 移除 Metadata Encoder 初始化
        # logging.info("Initializing metadata encoder (MLP)...")
        # self.metadata_encoder = MetadataEncoder(num_metadata_features, metadata_embedding_dim)

        # Freeze encoders if requested (保持不变)
        if freeze_encoders:
            logging.info("Freezing text and image encoders.")
            for param in self.text_encoder.parameters():
                 param.requires_grad = False
            for param in self.image_encoder.parameters():
                 param.requires_grad = False

        # Fusion Layer (调整输入维度)
        logging.info("Initializing fusion layer...")
        # 新的融合维度只包含文本和图像
        self.fusion_dim = text_embedding_dim + self.img_embedding_dim 
        self.fusion_layer = nn.Sequential(
            nn.Linear(self.fusion_dim, fusion_output_dim),
            nn.ReLU(),
            nn.Dropout(0.5) 
        )

        # Classifier Head (保持不变)
        logging.info("Initializing classifier head...")
        self.classifier = nn.Linear(fusion_output_dim, 1)

    # 移除 forward 方法中的 metadata 参数
    def forward(self, input_ids, attention_mask, image, image_available):
        # Text Features (保持不变)
        text_outputs = self.text_encoder(input_ids=input_ids, attention_mask=attention_mask)
        text_features = text_outputs.last_hidden_state[:, 0, :]

        # Image Features (保持不变)
        batch_size = image.shape[0]
        image_features = torch.zeros(batch_size, self.img_embedding_dim, device=image.device)
        valid_image_mask = image_available.bool()
        if valid_image_mask.any():
            valid_images = image[valid_image_mask]
            valid_image_features = self.image_encoder(valid_images)
            image_features[valid_image_mask] = valid_image_features

        # 移除 Metadata Features 处理
        # metadata_features = self.metadata_encoder(metadata)

        # Fusion (只融合文本和图像)
        fused_features = torch.cat((text_features, image_features), dim=1)
        fused_output = self.fusion_layer(fused_features)

        # Classification (保持不变)
        logits = self.classifier(fused_output)
        return logits.squeeze(-1)

# --- Training and Evaluation Functions (移除 metadata 相关) ---

def train_epoch(model, data_loader, loss_fn, optimizer, device):
    model.train()
    total_loss = 0
    all_preds = []
    all_labels = []

    for batch in tqdm(data_loader, desc="Training"):
        input_ids = batch['input_ids'].to(device)
        attention_mask = batch['attention_mask'].to(device)
        images = batch['image'].to(device)
        # metadata = batch['metadata'].to(device) # 移除
        labels = batch['label'].to(device)
        image_available = batch['image_available'].to(device)

        optimizer.zero_grad()

        # 移除 forward 调用中的 metadata
        outputs = model(input_ids, attention_mask, images, image_available)
        loss = loss_fn(outputs, labels)

        loss.backward()
        optimizer.step()
        
        total_loss += loss.item()
        preds = torch.sigmoid(outputs).detach().cpu().numpy()
        all_preds.extend(preds)
        all_labels.extend(labels.cpu().numpy())

    avg_loss = total_loss / len(data_loader)
    all_preds_binary = (np.array(all_preds) >= 0.5).astype(int)
    accuracy = accuracy_score(all_labels, all_preds_binary)
    precision, recall, f1, _ = precision_recall_fscore_support(all_labels, all_preds_binary, average='binary', zero_division=0)
    logging.info(f"Train Epoch Summary: Avg Loss: {avg_loss:.4f}, Accuracy: {accuracy:.4f}, Precision: {precision:.4f}, Recall: {recall:.4f}, F1: {f1:.4f}")
    return avg_loss, f1

def evaluate_epoch(model, data_loader, loss_fn, device):
    model.eval()
    total_loss = 0
    all_preds = []
    all_labels = []

    with torch.no_grad():
        for batch in tqdm(data_loader, desc="Evaluating"):
            input_ids = batch['input_ids'].to(device)
            attention_mask = batch['attention_mask'].to(device)
            images = batch['image'].to(device)
            # metadata = batch['metadata'].to(device) # 移除
            labels = batch['label'].to(device)
            image_available = batch['image_available'].to(device)

            # 移除 forward 调用中的 metadata
            outputs = model(input_ids, attention_mask, images, image_available)
            loss = loss_fn(outputs, labels)
            total_loss += loss.item()

            preds = torch.sigmoid(outputs).cpu().numpy()
            all_preds.extend(preds)
            all_labels.extend(labels.cpu().numpy())

    avg_loss = total_loss / len(data_loader)
    all_preds_binary = (np.array(all_preds) >= 0.5).astype(int)
    accuracy = accuracy_score(all_labels, all_preds_binary)
    precision, recall, f1, _ = precision_recall_fscore_support(all_labels, all_preds_binary, average='binary', zero_division=0)
    try:
        auc = roc_auc_score(all_labels, all_preds)
    except ValueError:
        auc = 0.0
        logging.warning("AUC calculation failed (likely only one class present in labels). Setting AUC to 0.0")

    logging.info(f"Eval Summary: Avg Loss: {avg_loss:.4f}, Accuracy: {accuracy:.4f}, Precision: {precision:.4f}, Recall: {recall:.4f}, F1: {f1:.4f}, AUC: {auc:.4f}")
    return avg_loss, accuracy, precision, recall, f1, auc

# --- Main Training Orchestration (移除 metadata 相关) ---

# 移除 METADATA_COLS 定义
# METADATA_COLS = [...] 

def main():
    logging.info("--- Starting Model Training (Metadata Excluded) ---")
    start_time = time.time()

    torch.manual_seed(RANDOM_SEED)
    np.random.seed(RANDOM_SEED)
    if torch.cuda.is_available():
        torch.cuda.manual_seed_all(RANDOM_SEED)

    # 1. Load Data and Split (保持不变)
    logging.info("Loading and splitting data...")
    try:
        df = pd.read_csv(CSV_PATH)
        train_val_df, test_df = train_test_split(df, test_size=TEST_SPLIT, random_state=RANDOM_SEED, stratify=df['label'])
        train_df, val_df = train_test_split(train_val_df, test_size=VALIDATION_SPLIT/(1-TEST_SPLIT), random_state=RANDOM_SEED, stratify=train_val_df['label'])
        logging.info(f"Data split: Train={len(train_df)}, Val={len(val_df)}, Test={len(test_df)}")
    except FileNotFoundError:
        logging.error(f"FATAL: Processed CSV not found at {CSV_PATH}. Run preprocess script first.")
        return
    except Exception as e:
         logging.error(f"FATAL: Error loading or splitting data: {e}")
         return

    # 2. 移除 Metadata Scaler 相关逻辑
    # logging.info("Fitting metadata scaler on training data...")
    # metadata_scaler = StandardScaler()
    # ... (移除检查和 scaler.fit, joblib.dump 等)
    # logging.info(f"Metadata scaler fitting skipped.")

    # 3. Setup Datasets and DataLoaders (移除 metadata 相关参数)
    logging.info("Creating Datasets and DataLoaders...")
    tokenizer = get_tokenizer(TEXT_MODEL_NAME)
    image_transform = get_image_transforms(input_size=IMAGE_MODEL_INPUT_SIZE)
    train_image_transform = get_image_transforms(input_size=IMAGE_MODEL_INPUT_SIZE, augment=True)

    try:
        # 移除 metadata_cols 和 metadata_scaler 参数
        train_dataset = MultimodalFakeNewsDataset(train_df, DATA_DIR, tokenizer, train_image_transform, MAX_TEXT_LEN)
        val_dataset = MultimodalFakeNewsDataset(val_df, DATA_DIR, tokenizer, image_transform, MAX_TEXT_LEN)
        test_dataset = MultimodalFakeNewsDataset(test_df, DATA_DIR, tokenizer, image_transform, MAX_TEXT_LEN)

        train_loader = DataLoader(train_dataset, batch_size=BATCH_SIZE, shuffle=True, num_workers=2, pin_memory=True)
        val_loader = DataLoader(val_dataset, batch_size=BATCH_SIZE, shuffle=False, num_workers=2, pin_memory=True)
        test_loader = DataLoader(test_dataset, batch_size=BATCH_SIZE, shuffle=False, num_workers=2, pin_memory=True)
        logging.info("DataLoaders created.")
    except Exception as e:
         logging.error(f"FATAL: Error creating Datasets or DataLoaders: {e}", exc_info=True)
         return

    # 4. Setup Model, Optimizer, Loss (移除 metadata 相关参数)
    logging.info("Setting up model, optimizer, and loss...")
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    logging.info(f"Using device: {device}")

    # 移除 num_metadata_features, metadata_embedding_dim 参数
    model = MultimodalFakeNewsModel(
        text_model_name=TEXT_MODEL_NAME,
        image_model_name=IMAGE_MODEL_NAME,
        text_embedding_dim=TEXT_EMBEDDING_DIM,
        img_embedding_dim=IMG_EMBEDDING_DIM,
        fusion_output_dim=FUSION_OUTPUT_DIM,
        freeze_encoders=False 
    ).to(device)

    # 移除 metadata_encoder 参数组
    optimizer = optim.AdamW([
        {'params': model.text_encoder.parameters(), 'lr': LEARNING_RATE_ENCODERS},
        {'params': model.image_encoder.parameters(), 'lr': LEARNING_RATE_ENCODERS},
        # {'params': model.metadata_encoder.parameters(), 'lr': LEARNING_RATE_HEAD}, # 移除
        {'params': model.fusion_layer.parameters(), 'lr': LEARNING_RATE_HEAD},
        {'params': model.classifier.parameters(), 'lr': LEARNING_RATE_HEAD}
    ], weight_decay=WEIGHT_DECAY)

    loss_fn = nn.BCEWithLogitsLoss()
    scheduler = ReduceLROnPlateau(optimizer, mode='max', factor=LR_SCHEDULER_FACTOR, patience=LR_SCHEDULER_PATIENCE, verbose=True)

    # 5. Training Loop (逻辑不变, 但调用 train/evaluate 时 model 不处理 metadata)
    logging.info("--- Starting Training Loop ---")
    best_val_f1 = -1.0
    epochs_no_improve = 0
    best_epoch = 0

    for epoch in range(EPOCHS):
        epoch_start_time = time.time()
        logging.info(f"Epoch {epoch + 1}/{EPOCHS}")

        train_loss, train_f1 = train_epoch(model, train_loader, loss_fn, optimizer, device)
        val_loss, val_acc, val_prec, val_rec, val_f1, val_auc = evaluate_epoch(model, val_loader, loss_fn, device)

        epoch_duration = time.time() - epoch_start_time
        logging.info(f"Epoch {epoch + 1} duration: {epoch_duration:.2f} seconds")
        scheduler.step(val_f1)

        if val_f1 > best_val_f1:
            best_val_f1 = val_f1
            best_epoch = epoch + 1
            # 使用新的模型路径
            torch.save(model.state_dict(), BEST_MODEL_PATH) 
            logging.info(f"*** New best model saved to {BEST_MODEL_PATH} with Val F1: {best_val_f1:.4f} at epoch {best_epoch} ***")
            epochs_no_improve = 0
        else:
            epochs_no_improve += 1
            logging.info(f"Validation F1 did not improve for {epochs_no_improve} epoch(s). Current best F1: {best_val_f1:.4f} at epoch {best_epoch}.")

        if epochs_no_improve >= EARLY_STOPPING_PATIENCE:
            logging.info(f"--- Early stopping triggered after {epoch + 1} epochs. ---")
            break

    logging.info("--- Training Finished ---")

    # 6. Final Evaluation on Test Set (逻辑不变)
    logging.info(f"--- Evaluating on Test Set using Best Model ({BEST_MODEL_PATH}) ---")
    try:
        if os.path.exists(BEST_MODEL_PATH):
            model.load_state_dict(torch.load(BEST_MODEL_PATH))
            logging.info(f"Loaded best model from epoch {best_epoch} ({BEST_MODEL_PATH}) with Val F1: {best_val_f1:.4f}")
            test_loss, test_acc, test_prec, test_rec, test_f1, test_auc = evaluate_epoch(model, test_loader, loss_fn, device)
            logging.info(f"Test Set Performance: Loss: {test_loss:.4f}, Accuracy: {test_acc:.4f}, Precision: {test_prec:.4f}, Recall: {test_rec:.4f}, F1: {test_f1:.4f}, AUC: {test_auc:.4f}")
        else:
             logging.error(f"Could not find best model at {BEST_MODEL_PATH} for final testing. Evaluating with the model from the last epoch.")
             test_loss, test_acc, test_prec, test_rec, test_f1, test_auc = evaluate_epoch(model, test_loader, loss_fn, device)
             logging.info(f"Test Set Performance (last epoch model): Loss: {test_loss:.4f}, Accuracy: {test_acc:.4f}, Precision: {test_prec:.4f}, Recall: {test_rec:.4f}, F1: {test_f1:.4f}, AUC: {test_auc:.4f}")

    except Exception as e:
         logging.error(f"Error during final test evaluation: {e}")

    total_duration = time.time() - start_time
    logging.info(f"Total script duration: {total_duration / 60:.2f} minutes")

if __name__ == '__main__':
    main()